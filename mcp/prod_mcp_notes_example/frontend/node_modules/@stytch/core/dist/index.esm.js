function _createForOfIteratorHelper(r, e) { var t = "undefined" != typeof Symbol && r[Symbol.iterator] || r["@@iterator"]; if (!t) { if (Array.isArray(r) || (t = _unsupportedIterableToArray(r)) || e && r && "number" == typeof r.length) { t && (r = t); var _n = 0, F = function F() {}; return { s: F, n: function n() { return _n >= r.length ? { done: !0 } : { done: !1, value: r[_n++] }; }, e: function e(r) { throw r; }, f: F }; } throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); } var o, a = !0, u = !1; return { s: function s() { t = t.call(r); }, n: function n() { var r = t.next(); return a = r.done, r; }, e: function e(r) { u = !0, o = r; }, f: function f() { try { a || null == t["return"] || t["return"](); } finally { if (u) throw o; } } }; }
function _typeof(o) { "@babel/helpers - typeof"; return _typeof = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (o) { return typeof o; } : function (o) { return o && "function" == typeof Symbol && o.constructor === Symbol && o !== Symbol.prototype ? "symbol" : typeof o; }, _typeof(o); }
function _toConsumableArray(r) { return _arrayWithoutHoles(r) || _iterableToArray(r) || _unsupportedIterableToArray(r) || _nonIterableSpread(); }
function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }
function _iterableToArray(r) { if ("undefined" != typeof Symbol && null != r[Symbol.iterator] || null != r["@@iterator"]) return Array.from(r); }
function _arrayWithoutHoles(r) { if (Array.isArray(r)) return _arrayLikeToArray(r); }
function _slicedToArray(r, e) { return _arrayWithHoles(r) || _iterableToArrayLimit(r, e) || _unsupportedIterableToArray(r, e) || _nonIterableRest(); }
function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method."); }
function _unsupportedIterableToArray(r, a) { if (r) { if ("string" == typeof r) return _arrayLikeToArray(r, a); var t = {}.toString.call(r).slice(8, -1); return "Object" === t && r.constructor && (t = r.constructor.name), "Map" === t || "Set" === t ? Array.from(r) : "Arguments" === t || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t) ? _arrayLikeToArray(r, a) : void 0; } }
function _arrayLikeToArray(r, a) { (null == a || a > r.length) && (a = r.length); for (var e = 0, n = Array(a); e < a; e++) n[e] = r[e]; return n; }
function _iterableToArrayLimit(r, l) { var t = null == r ? null : "undefined" != typeof Symbol && r[Symbol.iterator] || r["@@iterator"]; if (null != t) { var e, n, i, u, a = [], f = !0, o = !1; try { if (i = (t = t.call(r)).next, 0 === l) { if (Object(t) !== t) return; f = !1; } else for (; !(f = (e = i.call(t)).done) && (a.push(e.value), a.length !== l); f = !0); } catch (r) { o = !0, n = r; } finally { try { if (!f && null != t["return"] && (u = t["return"](), Object(u) !== u)) return; } finally { if (o) throw n; } } return a; } }
function _arrayWithHoles(r) { if (Array.isArray(r)) return r; }
function _regenerator() { /*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/babel/babel/blob/main/packages/babel-helpers/LICENSE */ var e, t, r = "function" == typeof Symbol ? Symbol : {}, n = r.iterator || "@@iterator", o = r.toStringTag || "@@toStringTag"; function i(r, n, o, i) { var c = n && n.prototype instanceof Generator ? n : Generator, u = Object.create(c.prototype); return _regeneratorDefine2(u, "_invoke", function (r, n, o) { var i, c, u, f = 0, p = o || [], y = !1, G = { p: 0, n: 0, v: e, a: d, f: d.bind(e, 4), d: function d(t, r) { return i = t, c = 0, u = e, G.n = r, a; } }; function d(r, n) { for (c = r, u = n, t = 0; !y && f && !o && t < p.length; t++) { var o, i = p[t], d = G.p, l = i[2]; r > 3 ? (o = l === n) && (u = i[(c = i[4]) ? 5 : (c = 3, 3)], i[4] = i[5] = e) : i[0] <= d && ((o = r < 2 && d < i[1]) ? (c = 0, G.v = n, G.n = i[1]) : d < l && (o = r < 3 || i[0] > n || n > l) && (i[4] = r, i[5] = n, G.n = l, c = 0)); } if (o || r > 1) return a; throw y = !0, n; } return function (o, p, l) { if (f > 1) throw TypeError("Generator is already running"); for (y && 1 === p && d(p, l), c = p, u = l; (t = c < 2 ? e : u) || !y;) { i || (c ? c < 3 ? (c > 1 && (G.n = -1), d(c, u)) : G.n = u : G.v = u); try { if (f = 2, i) { if (c || (o = "next"), t = i[o]) { if (!(t = t.call(i, u))) throw TypeError("iterator result is not an object"); if (!t.done) return t; u = t.value, c < 2 && (c = 0); } else 1 === c && (t = i["return"]) && t.call(i), c < 2 && (u = TypeError("The iterator does not provide a '" + o + "' method"), c = 1); i = e; } else if ((t = (y = G.n < 0) ? u : r.call(n, G)) !== a) break; } catch (t) { i = e, c = 1, u = t; } finally { f = 1; } } return { value: t, done: y }; }; }(r, o, i), !0), u; } var a = {}; function Generator() {} function GeneratorFunction() {} function GeneratorFunctionPrototype() {} t = Object.getPrototypeOf; var c = [][n] ? t(t([][n]())) : (_regeneratorDefine2(t = {}, n, function () { return this; }), t), u = GeneratorFunctionPrototype.prototype = Generator.prototype = Object.create(c); function f(e) { return Object.setPrototypeOf ? Object.setPrototypeOf(e, GeneratorFunctionPrototype) : (e.__proto__ = GeneratorFunctionPrototype, _regeneratorDefine2(e, o, "GeneratorFunction")), e.prototype = Object.create(u), e; } return GeneratorFunction.prototype = GeneratorFunctionPrototype, _regeneratorDefine2(u, "constructor", GeneratorFunctionPrototype), _regeneratorDefine2(GeneratorFunctionPrototype, "constructor", GeneratorFunction), GeneratorFunction.displayName = "GeneratorFunction", _regeneratorDefine2(GeneratorFunctionPrototype, o, "GeneratorFunction"), _regeneratorDefine2(u), _regeneratorDefine2(u, o, "Generator"), _regeneratorDefine2(u, n, function () { return this; }), _regeneratorDefine2(u, "toString", function () { return "[object Generator]"; }), (_regenerator = function _regenerator() { return { w: i, m: f }; })(); }
function _regeneratorDefine2(e, r, n, t) { var i = Object.defineProperty; try { i({}, "", {}); } catch (e) { i = 0; } _regeneratorDefine2 = function _regeneratorDefine(e, r, n, t) { function o(r, n) { _regeneratorDefine2(e, r, function (e) { return this._invoke(r, n, e); }); } r ? i ? i(e, r, { value: n, enumerable: !t, configurable: !t, writable: !t }) : e[r] = n : (o("next", 0), o("throw", 1), o("return", 2)); }, _regeneratorDefine2(e, r, n, t); }
function _defineProperties(e, r) { for (var t = 0; t < r.length; t++) { var o = r[t]; o.enumerable = o.enumerable || !1, o.configurable = !0, "value" in o && (o.writable = !0), Object.defineProperty(e, _toPropertyKey(o.key), o); } }
function _createClass(e, r, t) { return r && _defineProperties(e.prototype, r), t && _defineProperties(e, t), Object.defineProperty(e, "prototype", { writable: !1 }), e; }
function _toPropertyKey(t) { var i = _toPrimitive(t, "string"); return "symbol" == _typeof(i) ? i : i + ""; }
function _toPrimitive(t, r) { if ("object" != _typeof(t) || !t) return t; var e = t[Symbol.toPrimitive]; if (void 0 !== e) { var i = e.call(t, r || "default"); if ("object" != _typeof(i)) return i; throw new TypeError("@@toPrimitive must return a primitive value."); } return ("string" === r ? String : Number)(t); }
function _classCallCheck(a, n) { if (!(a instanceof n)) throw new TypeError("Cannot call a class as a function"); }
function _callSuper(t, o, e) { return o = _getPrototypeOf(o), _possibleConstructorReturn(t, _isNativeReflectConstruct() ? Reflect.construct(o, e || [], _getPrototypeOf(t).constructor) : o.apply(t, e)); }
function _possibleConstructorReturn(t, e) { if (e && ("object" == _typeof(e) || "function" == typeof e)) return e; if (void 0 !== e) throw new TypeError("Derived constructors may only return object or undefined"); return _assertThisInitialized(t); }
function _assertThisInitialized(e) { if (void 0 === e) throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); return e; }
function _inherits(t, e) { if ("function" != typeof e && null !== e) throw new TypeError("Super expression must either be null or a function"); t.prototype = Object.create(e && e.prototype, { constructor: { value: t, writable: !0, configurable: !0 } }), Object.defineProperty(t, "prototype", { writable: !1 }), e && _setPrototypeOf(t, e); }
function _wrapNativeSuper(t) { var r = "function" == typeof Map ? new Map() : void 0; return _wrapNativeSuper = function _wrapNativeSuper(t) { if (null === t || !_isNativeFunction(t)) return t; if ("function" != typeof t) throw new TypeError("Super expression must either be null or a function"); if (void 0 !== r) { if (r.has(t)) return r.get(t); r.set(t, Wrapper); } function Wrapper() { return _construct(t, arguments, _getPrototypeOf(this).constructor); } return Wrapper.prototype = Object.create(t.prototype, { constructor: { value: Wrapper, enumerable: !1, writable: !0, configurable: !0 } }), _setPrototypeOf(Wrapper, t); }, _wrapNativeSuper(t); }
function _construct(t, e, r) { if (_isNativeReflectConstruct()) return Reflect.construct.apply(null, arguments); var o = [null]; o.push.apply(o, e); var p = new (t.bind.apply(t, o))(); return r && _setPrototypeOf(p, r.prototype), p; }
function _isNativeReflectConstruct() { try { var t = !Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); } catch (t) {} return (_isNativeReflectConstruct = function _isNativeReflectConstruct() { return !!t; })(); }
function _isNativeFunction(t) { try { return -1 !== Function.toString.call(t).indexOf("[native code]"); } catch (n) { return "function" == typeof t; } }
function _setPrototypeOf(t, e) { return _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function (t, e) { return t.__proto__ = e, t; }, _setPrototypeOf(t, e); }
function _getPrototypeOf(t) { return _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf.bind() : function (t) { return t.__proto__ || Object.getPrototypeOf(t); }, _getPrototypeOf(t); }
import { _ as __awaiter, a as __rest } from './tslib.es6-f6374340.js';
import { S as StytchAPIUnreachableError, a as StytchAPISchemaError, b as StytchAPIError, O as OTPMethods, c as StytchSDKUsageError, d as StytchSDKAPIError, e as StytchSDKSchemaError, f as SDKAPIUnreachableError, U as UNRECOVERABLE_ERROR_TYPES, g as OAuthProviders, B as B2BOAuthProviders } from './ui-cccea861.js';
var TEST_API_URL = 'https://test.stytch.com';
var LIVE_API_URL = 'https://api.stytch.com';
var CLIENTSIDE_SERVICES_IFRAME_URL = 'https://js.stytch.com/clientside-services/index.html';
var STYTCH_DFP_BACKEND_URL = "https://telemetry.stytch.com";
var STYTCH_DFP_CDN_URL = "https://elements.stytch.com";
var STYTCH_SESSION_COOKIE = 'stytch_session';
var STYTCH_SESSION_JWT_COOKIE = 'stytch_session_jwt';
var POWERED_BY_STYTCH_IMG_URL = 'https://public-assets.stytch.com/et_powered_by_stytch_logo.png';
var GOOGLE_ONE_TAP_HOST = 'https://accounts.google.com/gsi';
var GOOGLE_ONE_TAP_SCRIPT_URL = "".concat(GOOGLE_ONE_TAP_HOST, "/client");
var DEFAULT_SESSION_DURATION_MINUTES = 30;
var DEFAULT_OTP_EXPIRATION_MINUTES = 5;
var MULTIPLE_STYTCH_CLIENTS_DETECTED_WARNING = "It looks like you're creating multiple copies of the Stytch client." + ' This behavior is unsupported, and unintended side effects may occur. ' + "Make sure you are creating the Stytch client at the global level, and not inside a component's render function.";
var RetriableErrorType;
(function (RetriableErrorType) {
  RetriableErrorType["RequiredCaptcha"] = "CAPTCHA required";
})(RetriableErrorType || (RetriableErrorType = {}));
var RetriableError = /*#__PURE__*/function (_Error) {
  function RetriableError(type) {
    var _this;
    _classCallCheck(this, RetriableError);
    _this = _callSuper(this, RetriableError, [type]);
    _this.type = type;
    return _this;
  }
  _inherits(RetriableError, _Error);
  return _createClass(RetriableError);
}(/*#__PURE__*/_wrapNativeSuper(Error));
function retriableFetchSDK(_ref) {
  var method = _ref.method,
    finalURL = _ref.finalURL,
    basicAuthHeader = _ref.basicAuthHeader,
    xSDKClientHeader = _ref.xSDKClientHeader,
    xSDKParentHostHeader = _ref.xSDKParentHostHeader,
    body = _ref.body,
    retryCallback = _ref.retryCallback;
  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee() {
    var req, _t;
    return _regenerator().w(function (_context) {
      while (1) switch (_context.p = _context.n) {
        case 0:
          req = {
            method: method,
            finalURL: finalURL,
            basicAuthHeader: basicAuthHeader,
            xSDKClientHeader: xSDKClientHeader,
            xSDKParentHostHeader: xSDKParentHostHeader,
            body: body
          };
          _context.p = 1;
          _context.n = 2;
          return baseFetchSDK(req);
        case 2:
          return _context.a(2, _context.v);
        case 3:
          _context.p = 3;
          _t = _context.v;
          if (!(_t instanceof RetriableError)) {
            _context.n = 6;
            break;
          }
          _context.n = 4;
          return retryCallback(_t, req);
        case 4:
          req = _context.v;
          _context.n = 5;
          return baseFetchSDK(req);
        case 5:
          return _context.a(2, _context.v);
        case 6:
          throw _t;
        case 7:
          return _context.a(2);
      }
    }, _callee, null, [[1, 3]]);
  }));
}
function baseFetchSDK(_ref2) {
  var method = _ref2.method,
    finalURL = _ref2.finalURL,
    basicAuthHeader = _ref2.basicAuthHeader,
    xSDKClientHeader = _ref2.xSDKClientHeader,
    xSDKParentHostHeader = _ref2.xSDKParentHostHeader,
    body = _ref2.body;
  var _a;
  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee2() {
    var headers, fetchOpts, resp, _respData, respError, respData, _t2, _t3, _t4, _t5;
    return _regenerator().w(function (_context2) {
      while (1) switch (_context2.p = _context2.n) {
        case 0:
          headers = {
            Authorization: basicAuthHeader,
            'Content-Type': 'application/json',
            'X-SDK-Client': xSDKClientHeader
          };
          if (xSDKParentHostHeader) {
            headers['X-SDK-Parent-Host'] = xSDKParentHostHeader;
          }
          fetchOpts = {
            method: method,
            headers: headers,
            body: body && JSON.stringify(body),
            credentials: 'include'
          };
          _context2.p = 1;
          _context2.n = 2;
          return fetch(finalURL, fetchOpts);
        case 2:
          resp = _context2.v;
          _context2.n = 5;
          break;
        case 3:
          _context2.p = 3;
          _t2 = _context2.v;
          if (!(_t2.message === 'Failed to fetch')) {
            _context2.n = 4;
            break;
          }
          throw new StytchAPIUnreachableError('Unable to contact our servers.');
        case 4:
          throw _t2;
        case 5:
          if (!(resp.status <= 299)) {
            _context2.n = 9;
            break;
          }
          _context2.p = 6;
          _context2.n = 7;
          return resp.json();
        case 7:
          _respData = _context2.v;
          return _context2.a(2, _respData.data);
        case 8:
          _context2.p = 8;
          _t3 = _context2.v;
          throw new StytchAPIUnreachableError('Invalid JSON response from our servers.');
        case 9:
          if (!(resp.status !== 200 && ((_a = resp.headers.get('content-type')) === null || _a === void 0 ? void 0 : _a.includes('application/json')))) {
            _context2.n = 15;
            break;
          }
          _context2.p = 10;
          _context2.n = 11;
          return resp.json();
        case 11:
          respError = _context2.v;
          _context2.n = 13;
          break;
        case 12:
          _context2.p = 12;
          _t4 = _context2.v;
          throw new StytchAPIUnreachableError('Invalid or no response from server');
        case 13:
          if (!('body' in respError || 'params' in respError || 'query' in respError)) {
            _context2.n = 14;
            break;
          }
          throw new StytchAPISchemaError(respError);
        case 14:
          throw new StytchAPIError(respError);
        case 15:
          _context2.p = 15;
          _context2.n = 16;
          return resp.text();
        case 16:
          respData = _context2.v;
          _context2.n = 18;
          break;
        case 17:
          _context2.p = 17;
          _t5 = _context2.v;
          throw new StytchAPIUnreachableError('Invalid response from our servers.');
        case 18:
          if (!respData.includes('Captcha required')) {
            _context2.n = 19;
            break;
          }
          throw new RetriableError(RetriableErrorType.RequiredCaptcha);
        case 19:
          throw new StytchAPIUnreachableError('Invalid response from our servers.');
        case 20:
          return _context2.a(2);
      }
    }, _callee2, null, [[15, 17], [10, 12], [6, 8], [1, 3]]);
  }));
}
function baseSubmitFormSDK(_ref3) {
  var method = _ref3.method,
    finalURL = _ref3.finalURL,
    basicAuthHeader = _ref3.basicAuthHeader,
    xSDKClientHeader = _ref3.xSDKClientHeader,
    xSDKParentHostHeader = _ref3.xSDKParentHostHeader,
    body = _ref3.body;
  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee3() {
    var bodyParams, finalBody, children, form;
    return _regenerator().w(function (_context3) {
      while (1) switch (_context3.n) {
        case 0:
          bodyParams = body || {};
          finalBody = Object.assign(Object.assign({}, bodyParams), {
            __Authorization: basicAuthHeader,
            '__X-SDK-Client': xSDKClientHeader
          });
          if (xSDKParentHostHeader) {
            finalBody['__X-SDK-Parent-Host'] = xSDKParentHostHeader;
          }
          children = Object.entries(finalBody).map(function (_ref4) {
            var _ref5 = _slicedToArray(_ref4, 2),
              key = _ref5[0],
              value = _ref5[1];
            var input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = value;
            return input;
          });
          form = document.createElement('form');
          form.method = method;
          form.action = finalURL;
          form.append.apply(form, _toConsumableArray(children));
          document.body.appendChild(form);
          form.submit();
        case 1:
          return _context3.a(2);
      }
    }, _callee3);
  }));
}

// Unique ID creation requires a high quality random # generator. In the browser we therefore
// require the crypto API and do not support built-in fallback to lower quality random number
// generators (like Math.random()).
var getRandomValues;
var rnds8 = new Uint8Array(16);
function rng() {
  // lazy load so that environments that need to polyfill have a chance to do so
  if (!getRandomValues) {
    // getRandomValues needs to be invoked in a context where "this" is a Crypto implementation. Also,
    // find the complete implementation of crypto (msCrypto) on IE11.
    getRandomValues = typeof crypto !== 'undefined' && crypto.getRandomValues && crypto.getRandomValues.bind(crypto) || typeof msCrypto !== 'undefined' && typeof msCrypto.getRandomValues === 'function' && msCrypto.getRandomValues.bind(msCrypto);
    if (!getRandomValues) {
      throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');
    }
  }
  return getRandomValues(rnds8);
}
var REGEX = /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;
function validate$1(uuid) {
  return typeof uuid === 'string' && REGEX.test(uuid);
}

/**
 * Convert array of 16 byte values to UUID string format of the form:
 * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX
 */
var byteToHex = [];
for (var i = 0; i < 256; ++i) {
  byteToHex.push((i + 0x100).toString(16).substr(1));
}
function stringify(arr) {
  var offset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;
  // Note: Be careful editing this code!  It's been tuned for performance
  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434
  var uuid = (byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]]).toLowerCase(); // Consistency check for valid UUID.  If this throws, it's likely due to one
  // of the following:
  // - One or more input array values don't map to a hex octet (leading to
  // "undefined" in the uuid)
  // - Invalid input values for the RFC `version` or `variant` fields
  if (!validate$1(uuid)) {
    throw TypeError('Stringified UUID is invalid');
  }
  return uuid;
}
function v4(options, buf, offset) {
  options = options || {};
  var rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`
  rnds[6] = rnds[6] & 0x0f | 0x40;
  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided
  if (buf) {
    offset = offset || 0;
    for (var i = 0; i < 16; ++i) {
      buf[offset + i] = rnds[i];
    }
    return buf;
  }
  return stringify(rnds);
}
var ModulePromiseCache = {};
function loadESModule(url, moduleFromGlobalScope) {
  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee4() {
    return _regenerator().w(function (_context4) {
      while (1) switch (_context4.n) {
        case 0:
          if (!(ModulePromiseCache[url] !== undefined)) {
            _context4.n = 1;
            break;
          }
          return _context4.a(2, ModulePromiseCache[url]);
        case 1:
          ModulePromiseCache[url] = loadESModuleFromNetwork(url, moduleFromGlobalScope);
          return _context4.a(2, ModulePromiseCache[url]);
      }
    }, _callee4);
  }));
}
function loadESModuleFromNetwork(url, moduleFromGlobalScope) {
  return new Promise(function (resolve, reject) {
    var maybeScript = findScript(url);
    if (maybeScript && maybeScript.dataset.loaded === 'true') {
      try {
        resolve(moduleFromGlobalScope());
      } catch (err) {
        return reject(new Error("".concat(url, " already loaded, but module was not found in global scope: ").concat(err)));
      }
    }
    var script = createScript(url);
    script.addEventListener('load', function () {
      script.dataset.loaded = 'true';
      try {
        resolve(moduleFromGlobalScope());
      } catch (err) {
        reject(new Error("".concat(url, " was loaded, but module was not found in global scope: ").concat(err)));
      }
    });
    script.addEventListener('error', function (err) {
      reject(new Error("".concat(url, " could not be loaded: ").concat(err)));
    });
  });
}
var findScriptsInDom = function findScriptsInDom(url) {
  return document.querySelectorAll("script[src=\"".concat(url, "\"]"));
};
function findScript(url) {
  var scripts = findScriptsInDom(url);
  if (scripts[0]) {
    return scripts[0];
  }
}
function createScript(url) {
  var script = document.createElement('script');
  script.setAttribute('src', url);
  script.setAttribute('async', 'true');
  script.setAttribute('defer', 'true');
  document.head.appendChild(script);
  return script;
}
var getHttpsUrl = function getHttpsUrl(urlOrDomain) {
  // If it's already a valid URL, extract the domain
  try {
    var url = new URL(urlOrDomain);
    return "https://".concat(url.hostname);
  } catch (_a) {
    // invalid URLs are OK
  }
  // Prepend a scheme and verify it's a valid URL
  try {
    var _url = new URL("https://".concat(urlOrDomain));
    return "https://".concat(_url.hostname);
  } catch (_b) {
    // Invalid URL, fallback to undefined
  }
  // Input was neither a valid URL nor a valid domain
  return undefined;
};

/**
 * A set of tokens to stylize the console.log output
 * First token is the raw text. %c is a placeholder for string formatting
 * Second token starts our stylizing - adding custom color and background
 * Third token resets stylizing to baseline before showing the rest of the content.
 */
var STYTCH_BADGE = process.env.NODE_ENV === 'production' ? ['[Stytch]'] : ['%c[Stytch]%c', 'background: #19303d; color: #13E5C0; padding: 2px;border-radius: 4px', ''];
// Turn this to true to enable debug logs
// TODO: Make this an env var
var DEBUG = false;
/* eslint-disable no-console */
/* eslint-disable @typescript-eslint/no-explicit-any */
/**
 * An ultralightweight wrapper around console.log.
 * In the future, the logger might be passed in from the customer,
 * or the level might be configurable.
 */
var logger = {
  debug: function debug() {
    return DEBUG;
  },
  log: function log() {
    var _console;
    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }
    return (_console = console).log.apply(_console, STYTCH_BADGE.concat(args));
  },
  warn: function warn() {
    var _console2;
    for (var _len2 = arguments.length, args = new Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
      args[_key2] = arguments[_key2];
    }
    return (_console2 = console).warn.apply(_console2, STYTCH_BADGE.concat(args));
  },
  error: function error() {
    var _console3;
    for (var _len3 = arguments.length, args = new Array(_len3), _key3 = 0; _key3 < _len3; _key3++) {
      args[_key3] = arguments[_key3];
    }
    return (_console3 = console).error.apply(_console3, STYTCH_BADGE.concat(args));
  }
};
/* eslint-enable @typescript-eslint/no-explicit-any */
/* eslint-enable no-console */

var getLiveApiURL = function getLiveApiURL(opts) {
  var _a, _b, _c, _d;
  var domain = (_a = opts === null || opts === void 0 ? void 0 : opts.customBaseUrl) !== null && _a !== void 0 ? _a : (_b = opts === null || opts === void 0 ? void 0 : opts.endpointOptions) === null || _b === void 0 ? void 0 : _b.apiDomain;
  if (domain) {
    var httpsUrl = getHttpsUrl(domain);
    if (httpsUrl) {
      return httpsUrl;
    } else {
      var key = (opts === null || opts === void 0 ? void 0 : opts.customBaseUrl) ? 'customBaseUrl' : 'apiDomain';
      logger.warn("Unable to use custom API domain `".concat(domain, "`. ").concat(key, " should be a valid domain."));
    }
  }
  return (_d = (_c = opts === null || opts === void 0 ? void 0 : opts.endpoints) === null || _c === void 0 ? void 0 : _c.liveAPIURL) !== null && _d !== void 0 ? _d : LIVE_API_URL;
};
var getTestApiURL = function getTestApiURL(opts) {
  var _a, _b, _c, _d;
  var domain = (_a = opts === null || opts === void 0 ? void 0 : opts.customBaseUrl) !== null && _a !== void 0 ? _a : (_b = opts === null || opts === void 0 ? void 0 : opts.endpointOptions) === null || _b === void 0 ? void 0 : _b.testApiDomain;
  if (domain) {
    var httpsUrl = getHttpsUrl(domain);
    if (httpsUrl) {
      return httpsUrl;
    } else {
      var key = (opts === null || opts === void 0 ? void 0 : opts.customBaseUrl) ? 'customBaseUrl' : 'testApiDomain';
      logger.warn("Unable to use custom API domain `".concat(domain, "`. ").concat(key, " should be a valid domain."));
    }
  }
  return (_d = (_c = opts === null || opts === void 0 ? void 0 : opts.endpoints) === null || _c === void 0 ? void 0 : _c.testAPIURL) !== null && _d !== void 0 ? _d : TEST_API_URL;
};
var trailer = "\nYou can find your public token at https://stytch.com/dashboard/api-keys.";
var checkPublicToken = function checkPublicToken(publicToken) {
  if (typeof publicToken !== 'string') {
    logger.warn("Public token is malformed. Expected a string, got ".concat(_typeof(publicToken), ".").concat(trailer));
  } else if (publicToken === '') {
    logger.warn("Public token is malformed. Expected \"public-token-...\", got an empty string.".concat(trailer));
  } else if (!publicToken.startsWith('public-token-')) {
    logger.warn("Public token is malformed. Expected \"public-token-...\", got ".concat(publicToken, ".").concat(trailer));
  }
};
var checkNotSSR = function checkNotSSR(clientName) {
  var factoryFunctionName = clientName === 'StytchUIClient' ? 'createStytchUIClient' : 'createStytchHeadlessClient';
  if (typeof window === 'undefined') {
    throw new Error("`new ".concat(clientName, "()` is not supported in server environments. If using @stytch/react or @stytch/nextjs, use `").concat(factoryFunctionName, "()` instead."));
  }
};
var checkB2BNotSSR = function checkB2BNotSSR(clientName) {
  var factoryFunctionName = clientName === 'StytchB2BUIClient' ? 'createStytchB2BUIClient' : 'createStytchB2BHeadlessClient';
  if (typeof window === 'undefined') {
    throw new Error("`new ".concat(clientName, "()` is not supported in server environments. If using @stytch/react or @stytch/nextjs, use `").concat(factoryFunctionName, "()` instead."));
  }
};

// List of Alpha-2 country codes to display in the drop down for phone number entry in our pre-built UI components.
//
// This list contains all allowed country codes, in alphabetical order, with the exception of the US, which is placed first as it is
// the default and our most common user country.
//
// This list was built by pulling all countries from https://www.iban.com/country-codes and then removing countries that are not on our
// unsupported countries (https://app.launchdarkly.com/default/production/features/default-banned-countries-for-phone-validation/targeting).
//
// Other useful links are the IBAN Alpha-2 code list (https://www.iban.com/country-codes) and Twilio's per-country notes
// (https://www.twilio.com/en-us/guidelines/ag/sms). Just substitute the country code in that URL!
//
// This list is served to any customer, regardless of whether they are on the default country allowlist (only US and Canada) or they allow
// all countries. This means that users may be able to choose a country that is not allowed for a customer and receive an error. This should
// be improved in the future: ODEVX-34.
var COUNTRIES_LIST = {
  US: '1',
  // United States of America
  AX: '358',
  // Aland Islands
  AS: '1684',
  // American Samoa
  AG: '1268',
  // Antigua and Barbuda
  AI: '1264',
  // Anguilla
  AR: '54',
  // Argentina
  AT: '43',
  // Austria
  AU: '61',
  // Australia
  BE: '32',
  // Belgium
  BJ: '229',
  // Benin
  BO: '591',
  // Bolivia
  BR: '55',
  // Brazil
  IO: '246',
  // British Indian Ocean Territory (the)
  BN: '673',
  // Brunei Darussalam
  BG: '359',
  // Bulgaria
  BF: '226',
  // Burkina Faso
  CM: '237',
  // Cameroon
  CA: '1',
  // Canada
  BQ: '599',
  // Caribbean Netherlands
  CF: '236',
  // Central African Republic (the)
  CL: '56',
  // Chile
  CX: '61',
  // Christmas Island
  CC: '61',
  // Cocos (Keeling) Islands (the)
  CO: '57',
  // Colombia
  CD: '243',
  // Congo (the Democratic Republic of the)
  CK: '682',
  // Cook Islands (the)
  CR: '506',
  // Costa Rica
  HR: '385',
  // Croatia
  CZ: '420',
  // Czechia
  DK: '45',
  // Denmark
  DO: '1829',
  // Dominican Republic (the)
  EC: '593',
  // Ecuador
  SV: '503',
  // El Salvador
  EE: '372',
  // Estonia
  SZ: '268',
  // Eswatini
  FK: '500',
  // Falkland Islands (the) [Malvinas]
  FI: '358',
  // Finland
  FR: '33',
  // France
  GF: '594',
  // French Guiana
  DE: '49',
  // Germany
  GH: '233',
  // Ghana
  GR: '30',
  // Greece
  GD: '1473',
  // Grenada
  GT: '502',
  // Guatemala
  GG: '44',
  // Guernsey
  GW: '245',
  // Guinea-Bissau
  GY: '592',
  // Guyana
  HU: '36',
  // Hungary
  IS: '354',
  // Iceland
  IN: '91',
  // India
  IE: '353',
  // Ireland
  IM: '44',
  // Isle of Man
  IT: '39',
  // Italy
  JM: '1876',
  // Jamaica
  JP: '81',
  // Japan
  KZ: '7',
  // Kazakhstan
  KE: '254',
  // Kenya
  KI: '686',
  // Kiribati
  KR: '82',
  // Korea (the Republic of)
  LV: '371',
  // Latvia
  LT: '370',
  // Lithuania
  LU: '352',
  // Luxembourg
  MO: '853',
  // Macao
  MT: '356',
  // Malta
  MH: '692',
  // Marshall Islands (the)
  MR: '222',
  // Mauritania
  MU: '230',
  // Mauritius
  YT: '262',
  // Mayotte
  MX: '52',
  // Mexico
  MC: '377',
  // Monaco
  ME: '382',
  // Montenegro
  NR: '674',
  // Nauru
  NL: '31',
  // Netherlands (the)
  NZ: '64',
  // New Zealand
  NI: '505',
  // Nicaragua
  NF: '672',
  // Norfolk Island
  NO: '47',
  // Norway
  PA: '507',
  // Panama
  PY: '595',
  // Paraguay
  PE: '51',
  // Peru
  PN: '870',
  // Pitcairn
  PL: '48',
  // Poland
  PT: '351',
  // Portugal
  PR: '1',
  // Puerto Rico
  RO: '40',
  // Romania
  BL: '590',
  // Saint BarthÃ©lemy
  SH: '290',
  // Saint Helena, Ascension and Tristan da Cunha
  KN: '1869',
  // Saint Kitts and Nevis
  LC: '1758',
  // Saint Lucia
  MF: '590',
  // Saint Martin (French part)
  PM: '508',
  // Saint Pierre and Miquelon
  SM: '378',
  // San Marino
  ST: '239',
  // Sao Tome and Principe
  SC: '248',
  // Seychelles
  SX: '599',
  // Sint Maarten (Dutch part)
  SK: '421',
  // Slovakia
  SI: '386',
  // Slovenia
  ZA: '27',
  // South Africa
  SS: '211',
  // South Sudan
  ES: '34',
  // Spain
  SR: '597',
  // Suriname
  SJ: '47',
  // Svalbard and Jan Mayen
  SE: '46',
  // Sweden
  CH: '41',
  // Switzerland
  TW: '886',
  // Taiwan
  TZ: '255',
  // Tanzania, United Republic of
  TK: '690',
  // Tokelau
  TO: '676',
  // Tonga
  TT: '1868',
  // Trinidad and Tobago
  TR: '90',
  // Turkey
  UA: '380',
  // Ukraine
  GB: '44',
  // United Kingdom of Great Britain and Northern Ireland (the)
  UM: '1',
  // United States Minor Outlying Islands (the)
  UY: '598',
  // Uruguay
  VA: '379',
  // Vatican
  EH: '212' // Western Sahara
};
var getDFPBackendURL = function getDFPBackendURL(opts) {
  var _a, _b, _c, _d;
  var domain = (_a = opts === null || opts === void 0 ? void 0 : opts.dfppaUrl) !== null && _a !== void 0 ? _a : (_b = opts === null || opts === void 0 ? void 0 : opts.endpointOptions) === null || _b === void 0 ? void 0 : _b.dfppaDomain;
  if (domain) {
    var httpsUrl = getHttpsUrl(domain);
    if (httpsUrl) {
      return httpsUrl;
    } else {
      var key = (opts === null || opts === void 0 ? void 0 : opts.dfppaUrl) ? 'dfppaUrl' : 'dfppaDomain';
      logger.warn("Unable to use custom DFPPA domain `".concat(domain, "`. ").concat(key, " should be a valid domain."));
    }
  }
  return (_d = (_c = opts === null || opts === void 0 ? void 0 : opts.endpoints) === null || _c === void 0 ? void 0 : _c.dfpBackendURL) !== null && _d !== void 0 ? _d : STYTCH_DFP_BACKEND_URL;
};
var getDFPCdnURL = function getDFPCdnURL(opts) {
  var _a, _b;
  var domain = (_a = opts === null || opts === void 0 ? void 0 : opts.dfpCdnUrl) !== null && _a !== void 0 ? _a : (_b = opts === null || opts === void 0 ? void 0 : opts.endpointOptions) === null || _b === void 0 ? void 0 : _b.dfpCdnDomain;
  if (domain) {
    var httpsUrl = getHttpsUrl(domain);
    if (httpsUrl) {
      return httpsUrl;
    } else {
      var key = (opts === null || opts === void 0 ? void 0 : opts.dfpCdnUrl) ? 'dfpCdnUrl' : 'dfpCdnDomain';
      logger.warn("Unable to use custom DFP CDN domain `".concat(domain, "`. ").concat(key, " should be a valid domain."));
    }
  }
  return STYTCH_DFP_CDN_URL;
};

/**
 * Moves the first item that matches the predicate to the front of the array.
 * Returns a tuple of [reorderedArray, foundMatch] where foundMatch indicates
 * whether a matching item was found and moved.
 *
 * Note: Returns false if the array has only one item, but does return true even if the
 * item is found at index 0. This is behavior matches user expectation that you can't
 * really reorder an array of length 1.
 */
function moveToFront(array, predicate) {
  // If the array has only one item, it can't be moved so we return false
  if (array.length <= 1) {
    return [array, false];
  }
  var matchingIndex = array.findIndex(predicate);
  if (matchingIndex === -1) {
    return [array, false];
  }
  var reordered = _toConsumableArray(array);
  reordered.unshift.apply(reordered, _toConsumableArray(reordered.splice(matchingIndex, 1)));
  return [reordered, true];
}
// TODO: This weird structure is because export * seems to produce a type structure
//       that consuming packages downstream had issues with. Not entirely sure why,
//       I assume it's a TS bug that will be solved in the future?
var arrayUtils = {
  moveToFront: moveToFront
};
var isTestPublicToken = function isTestPublicToken(token) {
  return token.includes('public-token-test');
};
/**
 * Normalizes an es5 promise with a .then(onSuccess, onFailure) signature to
 * the es6 .then().catch() signature
 */
var normalizePromiseLike = function normalizePromiseLike(prom) {
  return new Promise(function (resolve, reject) {
    prom.then(resolve, reject);
  });
};
var createEventId = function createEventId() {
  return "event-id-".concat(v4());
};
var createAppSessionId = function createAppSessionId() {
  return "app-session-id-".concat(v4());
};
var createPersistentId = function createPersistentId() {
  return "persistent-id-".concat(v4());
};
var validate = function validate(methodName) {
  var validator = {
    isObject: function isObject(fieldName, value) {
      var isObject = _typeof(value) === 'object' && !Array.isArray(value) && value !== null;
      if (!isObject) {
        throw new StytchSDKUsageError(methodName, fieldName + ' must be an object.');
      }
      return validator;
    },
    isOptionalObject: function isOptionalObject(fieldName, value) {
      if (typeof value === 'undefined') {
        return validator;
      }
      return validator.isObject(fieldName, value);
    },
    isString: function isString(fieldName, value) {
      if (typeof value !== 'string') {
        throw new StytchSDKUsageError(methodName, fieldName + ' must be a string.');
      }
      return validator;
    },
    isOptionalString: function isOptionalString(fieldName, value) {
      if (typeof value === 'undefined') {
        return validator;
      }
      return validator.isString(fieldName, value);
    },
    isStringArray: function isStringArray(fieldName, value) {
      if (!Array.isArray(value)) {
        throw new StytchSDKUsageError(methodName, fieldName + ' must be an array of strings.');
      }
      var _iterator = _createForOfIteratorHelper(value),
        _step;
      try {
        for (_iterator.s(); !(_step = _iterator.n()).done;) {
          var str = _step.value;
          if (typeof str !== 'string') {
            throw new StytchSDKUsageError(methodName, fieldName + ' must be an array of strings.');
          }
        }
      } catch (err) {
        _iterator.e(err);
      } finally {
        _iterator.f();
      }
      return validator;
    },
    isOptionalStringArray: function isOptionalStringArray(fieldName, value) {
      if (typeof value === 'undefined') {
        return validator;
      }
      return validator.isStringArray(fieldName, value);
    },
    isNumber: function isNumber(fieldName, value) {
      if (typeof value !== 'number') {
        throw new StytchSDKUsageError(methodName, fieldName + ' must be a number.');
      }
      return validator;
    },
    isOptionalNumber: function isOptionalNumber(fieldName, value) {
      if (typeof value === 'undefined') {
        return validator;
      }
      return validator.isNumber(fieldName, value);
    },
    isBoolean: function isBoolean(fieldName, value) {
      if (typeof value !== 'boolean') {
        throw new StytchSDKUsageError(methodName, fieldName + ' must be a boolean.');
      }
      return validator;
    },
    isOptionalBoolean: function isOptionalBoolean(fieldName, value) {
      if (typeof value === 'undefined') {
        return validator;
      }
      return validator.isBoolean(fieldName, value);
    }
  };
  return validator;
};
var isPhoneMethod = function isPhoneMethod(selectionMethod) {
  return selectionMethod === OTPMethods.SMS || selectionMethod === OTPMethods.WhatsApp;
};
var isEmailMethod = function isEmailMethod(selectionMethod) {
  return selectionMethod === OTPMethods.Email;
};
var removeResponseCommon = function removeResponseCommon(_a) {
  var rest = __rest(_a, ["request_id", "status_code"]);
  return rest;
};
var omitUser = function omitUser(resp) {
  var rest = __rest(resp, ["__user"]);
  return rest;
};
var loadTelemetryJS = function loadTelemetryJS(domain) {
  return loadESModule("".concat(domain, "/telemetry.js"), function () {
    return window.GetTelemetryID;
  });
};
var DFPProtectedAuthProvider = /*#__PURE__*/_createClass(function DFPProtectedAuthProvider(publicToken, dfpBackendURL, dfpCdnDomain, bootstrapPromise) {
  var _this2 = this;
  var executeRecaptcha = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : function () {
    return Promise.resolve(undefined);
  };
  _classCallCheck(this, DFPProtectedAuthProvider);
  this.bootstrapPromise = bootstrapPromise;
  this.isEnabled = function () {
    return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee5() {
      return _regenerator().w(function (_context5) {
        while (1) switch (_context5.n) {
          case 0:
            return _context5.a(2, this.state.then(function (state) {
              return state.enabled;
            }));
        }
      }, _callee5, this);
    }));
  };
  this.getTelemetryID = function () {
    return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee6() {
      var _yield$this$state, publicToken, enabled, dfpBackendURL;
      return _regenerator().w(function (_context6) {
        while (1) switch (_context6.n) {
          case 0:
            _context6.n = 1;
            return this.state;
          case 1:
            _yield$this$state = _context6.v;
            publicToken = _yield$this$state.publicToken;
            enabled = _yield$this$state.enabled;
            dfpBackendURL = _yield$this$state.dfpBackendURL;
            if (enabled) {
              _context6.n = 2;
              break;
            }
            return _context6.a(2, undefined);
          case 2:
            _context6.n = 3;
            return window.GetTelemetryID(publicToken, "".concat(dfpBackendURL, "/submit"));
          case 3:
            return _context6.a(2, _context6.v);
        }
      }, _callee6, this);
    }));
  };
  this.getDFPTelemetryIDAndCaptcha = function () {
    return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee7() {
      var _yield$this$state2, enabled, executeRecaptcha, mode, dfp_telemetry_id, captcha_token;
      return _regenerator().w(function (_context7) {
        while (1) switch (_context7.n) {
          case 0:
            _context7.n = 1;
            return this.state;
          case 1:
            _yield$this$state2 = _context7.v;
            enabled = _yield$this$state2.enabled;
            executeRecaptcha = _yield$this$state2.executeRecaptcha;
            mode = _yield$this$state2.mode;
            dfp_telemetry_id = undefined;
            captcha_token = undefined;
            if (enabled) {
              _context7.n = 3;
              break;
            }
            _context7.n = 2;
            return executeRecaptcha();
          case 2:
            captcha_token = _context7.v;
          case 3:
            if (!(mode === 'DECISIONING')) {
              _context7.n = 5;
              break;
            }
            _context7.n = 4;
            return this.getTelemetryID();
          case 4:
            dfp_telemetry_id = _context7.v;
            _context7.n = 8;
            break;
          case 5:
            if (!(mode === 'OBSERVATION')) {
              _context7.n = 8;
              break;
            }
            _context7.n = 6;
            return this.getTelemetryID();
          case 6:
            dfp_telemetry_id = _context7.v;
            _context7.n = 7;
            return executeRecaptcha();
          case 7:
            captcha_token = _context7.v;
          case 8:
            return _context7.a(2, {
              dfp_telemetry_id: dfp_telemetry_id,
              captcha_token: captcha_token
            });
        }
      }, _callee7, this);
    }));
  };
  this.retryWithCaptchaAndDFP = function (e, req) {
    return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee8() {
      var _yield$this$state3, enabled, executeRecaptcha;
      return _regenerator().w(function (_context8) {
        while (1) switch (_context8.n) {
          case 0:
            _context8.n = 1;
            return this.state;
          case 1:
            _yield$this$state3 = _context8.v;
            enabled = _yield$this$state3.enabled;
            executeRecaptcha = _yield$this$state3.executeRecaptcha;
            if (!(e.type === RetriableErrorType.RequiredCaptcha && enabled)) {
              _context8.n = 5;
              break;
            }
            if (!req.body) {
              _context8.n = 4;
              break;
            }
            _context8.n = 2;
            return this.getTelemetryID();
          case 2:
            req.body.dfp_telemetry_id = _context8.v;
            _context8.n = 3;
            return executeRecaptcha();
          case 3:
            req.body.captcha_token = _context8.v;
          case 4:
            return _context8.a(2, req);
          case 5:
            throw new Error('Unable to query captcha and/or dfp telemetry ID');
          case 6:
            return _context8.a(2);
        }
      }, _callee8, this);
    }));
  };
  this.state = bootstrapPromise.then(function (bootstrapData) {
    return __awaiter(_this2, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee9() {
      return _regenerator().w(function (_context9) {
        while (1) switch (_context9.n) {
          case 0:
            if (bootstrapData.runDFPProtectedAuth) {
              _context9.n = 1;
              break;
            }
            return _context9.a(2, {
              publicToken: publicToken,
              dfpBackendURL: dfpBackendURL,
              enabled: false,
              loaded: false,
              executeRecaptcha: executeRecaptcha
            });
          case 1:
            _context9.n = 2;
            return loadTelemetryJS(dfpCdnDomain);
          case 2:
            return _context9.a(2, {
              publicToken: publicToken,
              dfpBackendURL: dfpBackendURL,
              enabled: true,
              mode: bootstrapData.dfpProtectedAuthMode || 'OBSERVATION',
              loaded: true,
              executeRecaptcha: executeRecaptcha
            });
        }
      }, _callee9);
    }));
  });
});
var DisabledDFPProtectedAuthProvider = function DisabledDFPProtectedAuthProvider() {
  return {
    isEnabled: function isEnabled() {
      return __awaiter(void 0, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee0() {
        return _regenerator().w(function (_context0) {
          while (1) switch (_context0.n) {
            case 0:
              return _context0.a(2, false);
          }
        }, _callee0);
      }));
    },
    getTelemetryID: function getTelemetryID() {
      return __awaiter(void 0, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee1() {
        return _regenerator().w(function (_context1) {
          while (1) switch (_context1.n) {
            case 0:
              return _context1.a(2, undefined);
          }
        }, _callee1);
      }));
    },
    getDFPTelemetryIDAndCaptcha: function getDFPTelemetryIDAndCaptcha() {
      return __awaiter(void 0, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee10() {
        return _regenerator().w(function (_context10) {
          while (1) switch (_context10.n) {
            case 0:
              return _context10.a(2, {
                dfp_telemetry_id: undefined,
                captcha_token: undefined
              });
          }
        }, _callee10);
      }));
    },
    retryWithCaptchaAndDFP: function retryWithCaptchaAndDFP() {
      return __awaiter(void 0, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee11() {
        return _regenerator().w(function (_context11) {
          while (1) switch (_context11.n) {
            case 0:
              throw new Error('DFP protected auth is disabled');
            case 1:
              return _context11.a(2);
          }
        }, _callee11);
      }));
    }
  };
};

/**
 * Some errors are thrown from inside an iframe, but we can't serialize them
 * to the parent in Webkit. This class handles restoring marshalled errors
 * to their original form.
 * It preserves the error instance/class constructor by inspecting err.name
 * and calling `new` on the matching constructor.
 */
var ErrorMarshaller = /*#__PURE__*/function () {
  function ErrorMarshaller() {
    _classCallCheck(this, ErrorMarshaller);
  }
  return _createClass(ErrorMarshaller, null, [{
    key: "inflate",
    value: function inflate(ErrorClass, ErrorData) {
      // !!HACK!!
      // We make the assumption that if the error takes in a required property
      // (StytchAPIError takes in an APIDetails obj...)
      // that we can just pass in the error body itself to satisfy the constructor...
      // And if the types don't work out, Object.assign(...) copies everything over anyway
      // This is a brittle and weak assumption.
      // eslint-disable-next-line @typescript-eslint/ban-ts-comment
      // @ts-ignore
      var err = new ErrorClass(ErrorData);
      Object.assign(err, ErrorData);
      Object.setPrototypeOf(err, ErrorClass.prototype);
      return err;
    }
  }, {
    key: "unmarshall",
    value: function unmarshall(error) {
      if ('name' in error) {
        switch (error.name) {
          case 'SDKAPIUnreachableError':
            return ErrorMarshaller.inflate(SDKAPIUnreachableError, error);
          case 'StytchSDKSchemaError':
            return ErrorMarshaller.inflate(StytchSDKSchemaError, error);
          case 'StytchAPIUnreachableError':
            return ErrorMarshaller.inflate(StytchAPIUnreachableError, error);
          case 'StytchAPISchemaError':
            return ErrorMarshaller.inflate(StytchAPISchemaError, error);
          case 'StytchSDKAPIError':
            return ErrorMarshaller.inflate(StytchSDKAPIError, error);
          case 'StytchAPIError':
            return ErrorMarshaller.inflate(StytchAPIError, error);
          case 'TypeError':
            return ErrorMarshaller.inflate(TypeError, error);
          case 'SyntaxError':
            return ErrorMarshaller.inflate(SyntaxError, error);
          case 'ReferenceError':
            return ErrorMarshaller.inflate(ReferenceError, error);
          case 'RangeError':
            return ErrorMarshaller.inflate(RangeError, error);
          case 'EvalError':
            return ErrorMarshaller.inflate(EvalError, error);
          case 'URIError':
            return ErrorMarshaller.inflate(URIError, error);
        }
      }
      return ErrorMarshaller.inflate(Error, error);
    }
  }]);
}();
var DEFAULT_MAX_BATCH_SIZE = 15;
var DEFAULT_INTERVAL_DURATION_MS = 800;
var EventLogger = /*#__PURE__*/function () {
  function EventLogger(args) {
    _classCallCheck(this, EventLogger);
    this.maxBatchSize = args.maxBatchSize;
    this.logEventURL = args.logEventURL;
    // TODO: If we create more than one of these, we'll want a mechanism to clean up the intervals
    setInterval(this.flush.bind(this), args.intervalDurationMs);
    this.batch = [];
  }
  return _createClass(EventLogger, [{
    key: "logEvent",
    value: function logEvent(telemetry, event) {
      this.batch.push({
        telemetry: telemetry,
        event: event
      });
      if (this.batch.length >= this.maxBatchSize) {
        this.flush();
      }
    }
  }, {
    key: "flush",
    value: function flush() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee12() {
        var batchToSubmit, _t6;
        return _regenerator().w(function (_context12) {
          while (1) switch (_context12.p = _context12.n) {
            case 0:
              if (this.batch.length) {
                _context12.n = 1;
                break;
              }
              return _context12.a(2);
            case 1:
              batchToSubmit = this.batch;
              this.batch = [];
              _context12.p = 2;
              _context12.n = 3;
              return fetch(this.logEventURL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(batchToSubmit)
              });
            case 3:
              _context12.n = 5;
              break;
            case 4:
              _context12.p = 4;
              _t6 = _context12.v;
            case 5:
              return _context12.a(2);
          }
        }, _callee12, this, [[2, 4]]);
      }));
    }
  }]);
}();
var EmailSentType;
(function (EmailSentType) {
  EmailSentType["LoginOrCreateEML"] = "login_or_create_eml";
  EmailSentType["LoginOrCreateOTP"] = "login_or_create_otp";
  EmailSentType["ResetPassword"] = "reset_password";
})(EmailSentType || (EmailSentType = {}));
var HeadlessUserClient = /*#__PURE__*/_createClass(function HeadlessUserClient(_networkClient, _subscriptionService) {
  var _this3 = this;
  _classCallCheck(this, HeadlessUserClient);
  this._networkClient = _networkClient;
  this._subscriptionService = _subscriptionService;
  this.get = function () {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee13() {
      var resp, user;
      return _regenerator().w(function (_context13) {
        while (1) switch (_context13.n) {
          case 0:
            _context13.n = 1;
            return this._networkClient.fetchSDK({
              url: '/users/me',
              method: 'GET'
            });
          case 1:
            resp = _context13.v;
            user = removeResponseCommon(resp);
            this._subscriptionService.updateUser(user);
            return _context13.a(2, user);
        }
      }, _callee13, this);
    }));
  };
  this.getSync = function () {
    return _this3._subscriptionService.getUser();
  };
  this.getInfo = function () {
    return {
      user: _this3.getSync(),
      fromCache: _this3._subscriptionService.getFromCache()
    };
  };
  this.update = function (options) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee14() {
      var resp, user;
      return _regenerator().w(function (_context14) {
        while (1) switch (_context14.n) {
          case 0:
            validate('stytch.user.update').isOptionalObject('untrusted_metadata', options.untrusted_metadata);
            _context14.n = 1;
            return this._networkClient.fetchSDK({
              url: '/users/me',
              body: options,
              method: 'PUT'
            });
          case 1:
            resp = _context14.v;
            user = removeResponseCommon(resp.__user);
            this._subscriptionService.updateUser(user);
            return _context14.a(2, omitUser(resp));
        }
      }, _callee14, this);
    }));
  };
  this.deleteEmail = function (emailId) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee15() {
      var resp, user;
      return _regenerator().w(function (_context15) {
        while (1) switch (_context15.n) {
          case 0:
            _context15.n = 1;
            return this._networkClient.fetchSDK({
              url: "/users/emails/".concat(emailId),
              method: 'DELETE'
            });
          case 1:
            resp = _context15.v;
            user = removeResponseCommon(resp.__user);
            this._subscriptionService.updateUser(user);
            return _context15.a(2, omitUser(resp));
        }
      }, _callee15, this);
    }));
  };
  this.deletePhoneNumber = function (phoneId) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee16() {
      var resp, user;
      return _regenerator().w(function (_context16) {
        while (1) switch (_context16.n) {
          case 0:
            _context16.n = 1;
            return this._networkClient.fetchSDK({
              url: "/users/phone_numbers/".concat(phoneId),
              method: 'DELETE'
            });
          case 1:
            resp = _context16.v;
            user = removeResponseCommon(resp.__user);
            this._subscriptionService.updateUser(user);
            return _context16.a(2, omitUser(resp));
        }
      }, _callee16, this);
    }));
  };
  this.deleteTOTP = function (totpId) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee17() {
      var resp, user;
      return _regenerator().w(function (_context17) {
        while (1) switch (_context17.n) {
          case 0:
            _context17.n = 1;
            return this._networkClient.fetchSDK({
              url: "/users/totps/".concat(totpId),
              method: 'DELETE'
            });
          case 1:
            resp = _context17.v;
            user = removeResponseCommon(resp.__user);
            this._subscriptionService.updateUser(user);
            return _context17.a(2, omitUser(resp));
        }
      }, _callee17, this);
    }));
  };
  this.deleteCryptoWallet = function (cryptoWalletId) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee18() {
      var resp, user;
      return _regenerator().w(function (_context18) {
        while (1) switch (_context18.n) {
          case 0:
            _context18.n = 1;
            return this._networkClient.fetchSDK({
              url: "/users/crypto_wallets/".concat(cryptoWalletId),
              method: 'DELETE'
            });
          case 1:
            resp = _context18.v;
            user = removeResponseCommon(resp.__user);
            this._subscriptionService.updateUser(user);
            return _context18.a(2, omitUser(resp));
        }
      }, _callee18, this);
    }));
  };
  this.deleteOAuthRegistration = function (oauthUserRegistrationId) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee19() {
      var resp, user;
      return _regenerator().w(function (_context19) {
        while (1) switch (_context19.n) {
          case 0:
            _context19.n = 1;
            return this._networkClient.fetchSDK({
              url: "/users/oauth/".concat(oauthUserRegistrationId),
              method: 'DELETE'
            });
          case 1:
            resp = _context19.v;
            user = removeResponseCommon(resp.__user);
            this._subscriptionService.updateUser(user);
            return _context19.a(2, omitUser(resp));
        }
      }, _callee19, this);
    }));
  };
  this.deleteWebauthnRegistration = function (webAuthnId) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee20() {
      var resp, user;
      return _regenerator().w(function (_context20) {
        while (1) switch (_context20.n) {
          case 0:
            _context20.n = 1;
            return this._networkClient.fetchSDK({
              url: "/users/webauthn_registrations/".concat(webAuthnId),
              method: 'DELETE'
            });
          case 1:
            resp = _context20.v;
            user = removeResponseCommon(resp.__user);
            this._subscriptionService.updateUser(user);
            return _context20.a(2, omitUser(resp));
        }
      }, _callee20, this);
    }));
  };
  this.deleteBiometricRegistration = function (biometricRegistrationId) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee21() {
      var resp, user;
      return _regenerator().w(function (_context21) {
        while (1) switch (_context21.n) {
          case 0:
            _context21.n = 1;
            return this._networkClient.fetchSDK({
              url: "/users/biometric_registrations/".concat(biometricRegistrationId),
              method: 'DELETE'
            });
          case 1:
            resp = _context21.v;
            user = removeResponseCommon(resp.__user);
            this._subscriptionService.updateUser(user);
            return _context21.a(2, omitUser(resp));
        }
      }, _callee21, this);
    }));
  };
  this.onChange = function (callback) {
    var lastVal = _this3._subscriptionService.getUser();
    var listener = function listener(state) {
      var _a;
      if ((state === null || state === void 0 ? void 0 : state.user) !== lastVal) {
        lastVal = (_a = state === null || state === void 0 ? void 0 : state.user) !== null && _a !== void 0 ? _a : null;
        callback(lastVal);
      }
    };
    return _this3._subscriptionService.subscribeToState(listener);
  };
  this.getConnectedApps = function () {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee22() {
      return _regenerator().w(function (_context22) {
        while (1) switch (_context22.n) {
          case 0:
            _context22.n = 1;
            return this._networkClient.fetchSDK({
              url: '/users/connected_apps',
              method: 'GET'
            });
          case 1:
            return _context22.a(2, _context22.v);
        }
      }, _callee22, this);
    }));
  };
  this.revokedConnectedApp = function (connectedAppId) {
    return __awaiter(_this3, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee23() {
      return _regenerator().w(function (_context23) {
        while (1) switch (_context23.n) {
          case 0:
            _context23.n = 1;
            return this._networkClient.fetchSDK({
              url: "/users/connected_apps/".concat(connectedAppId, "/revoke"),
              method: 'POST'
            });
          case 1:
            return _context23.a(2, _context23.v);
        }
      }, _callee23, this);
    }));
  };
});
var HeadlessSessionClient = /*#__PURE__*/function () {
  function HeadlessSessionClient(_networkClient, _subscriptionService) {
    var _this4 = this;
    _classCallCheck(this, HeadlessSessionClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this.getSync = function () {
      return _this4._subscriptionService.getSession();
    };
    this.getInfo = function () {
      var session = _this4.getSync();
      var fromCache = _this4._subscriptionService.getFromCache();
      return {
        session: session,
        fromCache: fromCache
      };
    };
    this.onChange = function (callback) {
      var lastVal = _this4._subscriptionService.getSession();
      var listener = function listener(state) {
        var _a;
        if ((state === null || state === void 0 ? void 0 : state.session) !== lastVal) {
          lastVal = (_a = state === null || state === void 0 ? void 0 : state.session) !== null && _a !== void 0 ? _a : null;
          callback(lastVal);
        }
      };
      return _this4._subscriptionService.subscribeToState(listener);
    };
    this.revoke = function (options) {
      return __awaiter(_this4, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee24() {
        var resp, _t7;
        return _regenerator().w(function (_context24) {
          while (1) switch (_context24.p = _context24.n) {
            case 0:
              _context24.p = 0;
              _context24.n = 1;
              return this._networkClient.fetchSDK({
                url: "/sessions/revoke",
                method: 'POST'
              });
            case 1:
              resp = _context24.v;
              this._subscriptionService.destroyState();
              return _context24.a(2, resp);
            case 2:
              _context24.p = 2;
              _t7 = _context24.v;
              if (options === null || options === void 0 ? void 0 : options.forceClear) {
                this._subscriptionService.destroyState();
              } else if (UNRECOVERABLE_ERROR_TYPES.includes(_t7.error_type)) {
                this._subscriptionService.destroyState();
              }
              throw _t7;
            case 3:
              return _context24.a(2);
          }
        }, _callee24, this, [[0, 2]]);
      }));
    };
    this._authenticate = function (options) {
      return __awaiter(_this4, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee25() {
        var _this5 = this;
        var initialSession, isSessionStale, requestBody, resp, _t8;
        return _regenerator().w(function (_context25) {
          while (1) switch (_context25.p = _context25.n) {
            case 0:
              initialSession = this._subscriptionService.getSession();
              isSessionStale = function isSessionStale() {
                var _a;
                return (initialSession === null || initialSession === void 0 ? void 0 : initialSession.session_id) !== ((_a = _this5._subscriptionService.getSession()) === null || _a === void 0 ? void 0 : _a.session_id);
              };
              _context25.p = 1;
              requestBody = {
                session_duration_minutes: options === null || options === void 0 ? void 0 : options.session_duration_minutes
              };
              _context25.n = 2;
              return this._networkClient.fetchSDK({
                url: '/sessions/authenticate',
                body: requestBody,
                method: 'POST'
              });
            case 2:
              resp = _context25.v;
              if (!isSessionStale()) {
                _context25.n = 3;
                break;
              }
              return _context25.a(2, this._authenticate(options));
            case 3:
              return _context25.a(2, omitUser(resp));
            case 4:
              _context25.p = 4;
              _t8 = _context25.v;
              if (!isSessionStale()) {
                _context25.n = 5;
                break;
              }
              return _context25.a(2, this._authenticate(options));
            case 5:
              if (UNRECOVERABLE_ERROR_TYPES.includes(_t8.error_type)) {
                this._subscriptionService.destroySession();
              }
              throw _t8;
            case 6:
              return _context25.a(2);
          }
        }, _callee25, this, [[1, 4]]);
      }));
    };
    this.authenticate = this._subscriptionService.withUpdateSession(this._authenticate);
    this.exchangeAccessToken = this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this4, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee26() {
        var resp;
        return _regenerator().w(function (_context26) {
          while (1) switch (_context26.n) {
            case 0:
              validate('stytch.session.exchangeAccessToken').isString('access_token', data.access_token).isNumber('session_duration_minutes', data.session_duration_minutes);
              _context26.n = 1;
              return this._networkClient.fetchSDK({
                url: '/sessions/exchange_access_token',
                body: data,
                method: 'POST'
              });
            case 1:
              resp = _context26.v;
              return _context26.a(2, omitUser(resp));
          }
        }, _callee26, this);
      }));
    });
    this.attest = this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this4, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee27() {
        return _regenerator().w(function (_context27) {
          while (1) switch (_context27.n) {
            case 0:
              validate('stytch.session.attest').isString('profile_id', data.profile_id).isString('token', data.token).isOptionalNumber('session_duration_minutes', data.session_duration_minutes);
              return _context27.a(2, this._networkClient.fetchSDK({
                url: '/sessions/attest',
                body: data,
                method: 'POST'
              }));
          }
        }, _callee27, this);
      }));
    });
  }
  return _createClass(HeadlessSessionClient, [{
    key: "getTokens",
    value: function getTokens() {
      return this._subscriptionService.getTokens();
    }
  }, {
    key: "updateSession",
    value: function updateSession(tokens) {
      var _a;
      validate('stytch.session.updateSession').isString('session_token', tokens.session_token).isOptionalString('session_jwt', (_a = tokens.session_jwt) !== null && _a !== void 0 ? _a : undefined);
      this._subscriptionService.updateTokens(tokens);
    }
  }]);
}();
var DefaultDynamicConfig$4 = Promise.resolve({
  pkceRequiredForEmailMagicLinks: false
});
var HeadlessMagicLinksClient = /*#__PURE__*/function () {
  function HeadlessMagicLinksClient(_networkClient, _subscriptionService, _pkceManager, _passwordResetPKCEManager) {
    var _this6 = this;
    var _config = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : DefaultDynamicConfig$4;
    var dfpProtectedAuth = arguments.length > 5 ? arguments[5] : undefined;
    _classCallCheck(this, HeadlessMagicLinksClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this._pkceManager = _pkceManager;
    this._passwordResetPKCEManager = _passwordResetPKCEManager;
    this._config = _config;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.email = {
      loginOrCreate: function loginOrCreate(email) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
        return __awaiter(_this6, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee28() {
          var _yield$this$_config, pkceRequiredForEmailMagicLinks, code_challenge, _yield$this$dfpProtec, dfp_telemetry_id, captcha_token, requestBody;
          return _regenerator().w(function (_context28) {
            while (1) switch (_context28.n) {
              case 0:
                _context28.n = 1;
                return this._config;
              case 1:
                _yield$this$_config = _context28.v;
                pkceRequiredForEmailMagicLinks = _yield$this$_config.pkceRequiredForEmailMagicLinks;
                code_challenge = undefined;
                if (!pkceRequiredForEmailMagicLinks) {
                  _context28.n = 3;
                  break;
                }
                _context28.n = 2;
                return this.getCodeChallenge();
              case 2:
                code_challenge = _context28.v;
              case 3:
                _context28.n = 4;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 4:
                _yield$this$dfpProtec = _context28.v;
                dfp_telemetry_id = _yield$this$dfpProtec.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec.captcha_token;
                requestBody = Object.assign(Object.assign({}, options), {
                  email: email,
                  code_challenge: code_challenge,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                });
                return _context28.a(2, this._networkClient.retriableFetchSDK({
                  url: '/magic_links/email/login_or_create',
                  body: requestBody,
                  method: 'POST',
                  retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                }));
            }
          }, _callee28, this);
        }));
      },
      send: function send(email) {
        var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
        return __awaiter(_this6, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee29() {
          var _yield$this$_config2, pkceRequiredForEmailMagicLinks, code_challenge, _yield$this$dfpProtec2, dfp_telemetry_id, captcha_token, requestBody, isLoggedIn, endpoint;
          return _regenerator().w(function (_context29) {
            while (1) switch (_context29.n) {
              case 0:
                _context29.n = 1;
                return this._config;
              case 1:
                _yield$this$_config2 = _context29.v;
                pkceRequiredForEmailMagicLinks = _yield$this$_config2.pkceRequiredForEmailMagicLinks;
                code_challenge = undefined;
                if (!pkceRequiredForEmailMagicLinks) {
                  _context29.n = 3;
                  break;
                }
                _context29.n = 2;
                return this.getCodeChallenge();
              case 2:
                code_challenge = _context29.v;
              case 3:
                _context29.n = 4;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 4:
                _yield$this$dfpProtec2 = _context29.v;
                dfp_telemetry_id = _yield$this$dfpProtec2.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec2.captcha_token;
                requestBody = Object.assign(Object.assign({}, options), {
                  email: email,
                  code_challenge: code_challenge,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                });
                isLoggedIn = !!this._subscriptionService.getSession();
                endpoint = isLoggedIn ? '/magic_links/email/send/secondary' : '/magic_links/email/send/primary';
                return _context29.a(2, this._networkClient.retriableFetchSDK({
                  url: endpoint,
                  body: requestBody,
                  method: 'POST',
                  retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                }));
            }
          }, _callee29, this);
        }));
      }
    };
    this.authenticate = this._subscriptionService.withUpdateSession(function (token, options) {
      return __awaiter(_this6, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee30() {
        var passwordResetPKPair, resp, _t9;
        return _regenerator().w(function (_context30) {
          while (1) switch (_context30.p = _context30.n) {
            case 0:
              validate('stytch.magicLinks.authenticate').isString('Token', token).isNumber('session_duration_minutes', options.session_duration_minutes);
              // When a user resets their password with PKCE turned on, they create a pkPair in the 'passwords' namespace.
              // However, when the user gets the reset password email, they have the option to log in without a password.
              // This redirects them to the magic link authenticate flow, which automatically looks for the pkce code_verifier
              // in the 'magic_links' namespace, breaking the flow. Unfortunately we won't know for sure in the eml authenticate call
              // whether or not the user is coming from a password reset flow. To handle this, we have to try to authenticate with
              // both the 'passwords' and 'magic_links' code_verifiers.
              _context30.n = 1;
              return this._passwordResetPKCEManager.getPKPair();
            case 1:
              passwordResetPKPair = _context30.v;
              resp = null;
              if (!(passwordResetPKPair === null || passwordResetPKPair === void 0 ? void 0 : passwordResetPKPair.code_verifier)) {
                _context30.n = 6;
                break;
              }
              _context30.p = 2;
              _context30.n = 3;
              return this.handlePKCEForAuthenticate(this._passwordResetPKCEManager, Object.assign(Object.assign({}, options), {
                token: token
              }));
            case 3:
              resp = _context30.v;
              _context30.n = 6;
              break;
            case 4:
              _context30.p = 4;
              _t9 = _context30.v;
              if (!_t9.message.includes('pkce')) {
                _context30.n = 5;
                break;
              }
              // If pkce-related error, fall back to magic links code_verifier
              // eslint-disable-next-line no-console
              console.log('Authenticate with passwords pkce namespace failed. Falling back to authenticate with magic_links namespace.');
              _context30.n = 6;
              break;
            case 5:
              throw _t9;
            case 6:
              if (resp) {
                _context30.n = 8;
                break;
              }
              _context30.n = 7;
              return this.handlePKCEForAuthenticate(this._pkceManager, Object.assign(Object.assign({}, options), {
                token: token
              }));
            case 7:
              resp = _context30.v;
            case 8:
              return _context30.a(2, omitUser(resp));
          }
        }, _callee30, this, [[2, 4]]);
      }));
    });
  }
  return _createClass(HeadlessMagicLinksClient, [{
    key: "getCodeChallenge",
    value: function getCodeChallenge() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee31() {
        var keyPair;
        return _regenerator().w(function (_context31) {
          while (1) switch (_context31.n) {
            case 0:
              _context31.n = 1;
              return this._pkceManager.getPKPair();
            case 1:
              keyPair = _context31.v;
              if (!keyPair) {
                _context31.n = 2;
                break;
              }
              return _context31.a(2, keyPair.code_challenge);
            case 2:
              _context31.n = 3;
              return this._pkceManager.startPKCETransaction();
            case 3:
              keyPair = _context31.v;
              return _context31.a(2, keyPair.code_challenge);
          }
        }, _callee31, this);
      }));
    }
  }, {
    key: "handlePKCEForAuthenticate",
    value: function handlePKCEForAuthenticate(pkceManager, data) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee32() {
        var pkPair, requestBody, resp;
        return _regenerator().w(function (_context32) {
          while (1) switch (_context32.n) {
            case 0:
              _context32.n = 1;
              return pkceManager.getPKPair();
            case 1:
              pkPair = _context32.v;
              requestBody = Object.assign({
                code_verifier: pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier
              }, data);
              _context32.n = 2;
              return this._networkClient.fetchSDK({
                url: '/magic_links/authenticate',
                body: requestBody,
                method: 'POST'
              });
            case 2:
              resp = _context32.v;
              pkceManager.clearPKPair();
              return _context32.a(2, resp);
          }
        }, _callee32, this);
      }));
    }
  }]);
}();
var HeadlessOTPClient = /*#__PURE__*/_createClass(function HeadlessOTPClient(_networkClient, _subscriptionService) {
  var _this7 = this;
  var executeRecaptcha = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : function () {
    return Promise.resolve(undefined);
  };
  var dfpProtectedAuth = arguments.length > 3 ? arguments[3] : undefined;
  _classCallCheck(this, HeadlessOTPClient);
  this._networkClient = _networkClient;
  this._subscriptionService = _subscriptionService;
  this.executeRecaptcha = executeRecaptcha;
  this.dfpProtectedAuth = dfpProtectedAuth;
  this.sms = {
    loginOrCreate: function loginOrCreate(phone_number, options) {
      return __awaiter(_this7, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee33() {
        var _yield$this$dfpProtec3, dfp_telemetry_id, captcha_token, requestBody;
        return _regenerator().w(function (_context33) {
          while (1) switch (_context33.n) {
            case 0:
              _context33.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec3 = _context33.v;
              dfp_telemetry_id = _yield$this$dfpProtec3.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec3.captcha_token;
              requestBody = Object.assign(Object.assign({}, options), {
                phone_number: phone_number,
                captcha_token: captcha_token,
                dfp_telemetry_id: dfp_telemetry_id
              });
              return _context33.a(2, this._networkClient.retriableFetchSDK({
                url: '/otps/sms/login_or_create',
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee33, this);
      }));
    },
    send: function send(phone_number, options) {
      return __awaiter(_this7, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee34() {
        var _yield$this$dfpProtec4, dfp_telemetry_id, captcha_token, requestBody, isLoggedIn, endpoint;
        return _regenerator().w(function (_context34) {
          while (1) switch (_context34.n) {
            case 0:
              _context34.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec4 = _context34.v;
              dfp_telemetry_id = _yield$this$dfpProtec4.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec4.captcha_token;
              requestBody = Object.assign(Object.assign({}, options), {
                phone_number: phone_number,
                captcha_token: captcha_token,
                dfp_telemetry_id: dfp_telemetry_id
              });
              isLoggedIn = !!this._subscriptionService.getSession();
              endpoint = isLoggedIn ? '/otps/sms/send/secondary' : '/otps/sms/send/primary';
              return _context34.a(2, this._networkClient.retriableFetchSDK({
                url: endpoint,
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee34, this);
      }));
    }
  };
  this.whatsapp = {
    loginOrCreate: function loginOrCreate(phone_number, options) {
      return __awaiter(_this7, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee35() {
        var _yield$this$dfpProtec5, dfp_telemetry_id, captcha_token, requestBody;
        return _regenerator().w(function (_context35) {
          while (1) switch (_context35.n) {
            case 0:
              _context35.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec5 = _context35.v;
              dfp_telemetry_id = _yield$this$dfpProtec5.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec5.captcha_token;
              requestBody = Object.assign(Object.assign({}, options), {
                phone_number: phone_number,
                dfp_telemetry_id: dfp_telemetry_id,
                captcha_token: captcha_token
              });
              return _context35.a(2, this._networkClient.retriableFetchSDK({
                url: '/otps/whatsapp/login_or_create',
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee35, this);
      }));
    },
    send: function send(phone_number, options) {
      return __awaiter(_this7, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee36() {
        var _yield$this$dfpProtec6, dfp_telemetry_id, captcha_token, requestBody, isLoggedIn, endpoint;
        return _regenerator().w(function (_context36) {
          while (1) switch (_context36.n) {
            case 0:
              _context36.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec6 = _context36.v;
              dfp_telemetry_id = _yield$this$dfpProtec6.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec6.captcha_token;
              requestBody = Object.assign(Object.assign({}, options), {
                phone_number: phone_number,
                captcha_token: captcha_token,
                dfp_telemetry_id: dfp_telemetry_id
              });
              isLoggedIn = !!this._subscriptionService.getSession();
              endpoint = isLoggedIn ? '/otps/whatsapp/send/secondary' : '/otps/whatsapp/send/primary';
              return _context36.a(2, this._networkClient.retriableFetchSDK({
                url: endpoint,
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee36, this);
      }));
    }
  };
  this.email = {
    loginOrCreate: function loginOrCreate(email, options) {
      return __awaiter(_this7, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee37() {
        var _yield$this$dfpProtec7, dfp_telemetry_id, captcha_token, requestBody;
        return _regenerator().w(function (_context37) {
          while (1) switch (_context37.n) {
            case 0:
              _context37.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec7 = _context37.v;
              dfp_telemetry_id = _yield$this$dfpProtec7.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec7.captcha_token;
              requestBody = Object.assign(Object.assign({}, options), {
                email: email,
                captcha_token: captcha_token,
                dfp_telemetry_id: dfp_telemetry_id
              });
              return _context37.a(2, this._networkClient.retriableFetchSDK({
                url: '/otps/email/login_or_create',
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee37, this);
      }));
    },
    send: function send(email, options) {
      return __awaiter(_this7, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee38() {
        var captcha_token, requestBody, isLoggedIn, endpoint;
        return _regenerator().w(function (_context38) {
          while (1) switch (_context38.n) {
            case 0:
              _context38.n = 1;
              return this.executeRecaptcha();
            case 1:
              captcha_token = _context38.v;
              requestBody = Object.assign(Object.assign({}, options), {
                email: email,
                captcha_token: captcha_token
              });
              isLoggedIn = !!this._subscriptionService.getSession();
              endpoint = isLoggedIn ? '/otps/email/send/secondary' : '/otps/email/send/primary';
              return _context38.a(2, this._networkClient.fetchSDK({
                url: endpoint,
                body: requestBody,
                method: 'POST'
              }));
          }
        }, _callee38, this);
      }));
    }
  };
  this.authenticate = this._subscriptionService.withUpdateSession(function (code, method_id, options) {
    return __awaiter(_this7, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee39() {
      var _yield$this$dfpProtec8, dfp_telemetry_id, captcha_token, requestBody, resp;
      return _regenerator().w(function (_context39) {
        while (1) switch (_context39.n) {
          case 0:
            validate('stytch.otps.authenticate').isString('Code', code).isNumber('session_duration_minutes', options.session_duration_minutes);
            _context39.n = 1;
            return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
          case 1:
            _yield$this$dfpProtec8 = _context39.v;
            dfp_telemetry_id = _yield$this$dfpProtec8.dfp_telemetry_id;
            captcha_token = _yield$this$dfpProtec8.captcha_token;
            requestBody = Object.assign({
              token: code,
              method_id: method_id,
              dfp_telemetry_id: dfp_telemetry_id,
              captcha_token: captcha_token
            }, options);
            _context39.n = 2;
            return this._networkClient.retriableFetchSDK({
              url: '/otps/authenticate',
              body: requestBody,
              method: 'POST',
              retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
            });
          case 2:
            resp = _context39.v;
            return _context39.a(2, omitUser(resp));
        }
      }, _callee39, this);
    }));
  });
});
var HeadlessOAuthClient = /*#__PURE__*/function () {
  function HeadlessOAuthClient(_networkClient, _subscriptionService, _pkceManager, _dynamicConfig, _config) {
    var _this8 = this;
    _classCallCheck(this, HeadlessOAuthClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this._pkceManager = _pkceManager;
    this._dynamicConfig = _dynamicConfig;
    this._config = _config;
    this.google = {
      start: this.startOAuthFlow(OAuthProviders.Google)
    };
    this.apple = {
      start: this.startOAuthFlow(OAuthProviders.Apple)
    };
    this.microsoft = {
      start: this.startOAuthFlow(OAuthProviders.Microsoft)
    };
    this.github = {
      start: this.startOAuthFlow(OAuthProviders.Github)
    };
    this.gitlab = {
      start: this.startOAuthFlow(OAuthProviders.GitLab)
    };
    this.facebook = {
      start: this.startOAuthFlow(OAuthProviders.Facebook)
    };
    this.discord = {
      start: this.startOAuthFlow(OAuthProviders.Discord)
    };
    this.salesforce = {
      start: this.startOAuthFlow(OAuthProviders.Salesforce)
    };
    this.slack = {
      start: this.startOAuthFlow(OAuthProviders.Slack)
    };
    this.amazon = {
      start: this.startOAuthFlow(OAuthProviders.Amazon)
    };
    this.bitbucket = {
      start: this.startOAuthFlow(OAuthProviders.Bitbucket)
    };
    this.linkedin = {
      start: this.startOAuthFlow(OAuthProviders.LinkedIn)
    };
    this.coinbase = {
      start: this.startOAuthFlow(OAuthProviders.Coinbase)
    };
    this.twitch = {
      start: this.startOAuthFlow(OAuthProviders.Twitch)
    };
    this.twitter = {
      start: this.startOAuthFlow(OAuthProviders.Twitter)
    };
    this.tiktok = {
      start: this.startOAuthFlow(OAuthProviders.TikTok)
    };
    this.snapchat = {
      start: this.startOAuthFlow(OAuthProviders.Snapchat)
    };
    this.figma = {
      start: this.startOAuthFlow(OAuthProviders.Figma)
    };
    this.yahoo = {
      start: this.startOAuthFlow(OAuthProviders.Yahoo)
    };
    this.authenticate = this._subscriptionService.withUpdateSession(function (token, options) {
      return __awaiter(_this8, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee40() {
        var keyPair, resp;
        return _regenerator().w(function (_context40) {
          while (1) switch (_context40.n) {
            case 0:
              validate('stytch.oauth.authenticate').isString('Token', token).isNumber('session_duration_minutes', options.session_duration_minutes);
              _context40.n = 1;
              return this._pkceManager.getPKPair();
            case 1:
              keyPair = _context40.v;
              if (!keyPair) {
                logger.warn('No code verifier found in local storage for OAuth flow.\n' + 'Consider using stytch.oauth.$provider.start() to add PKCE to your OAuth flows for added security.\n' + 'See https://stytch.com/docs/oauth#guides_pkce for more information.');
              }
              _context40.n = 2;
              return this._networkClient.fetchSDK({
                url: '/oauth/authenticate',
                method: 'POST',
                body: Object.assign({
                  token: token,
                  code_verifier: keyPair === null || keyPair === void 0 ? void 0 : keyPair.code_verifier
                }, options)
              });
            case 2:
              resp = _context40.v;
              this._pkceManager.clearPKPair();
              return _context40.a(2, omitUser(resp));
          }
        }, _callee40, this);
      }));
    });
  }
  return _createClass(HeadlessOAuthClient, [{
    key: "attach",
    value: function attach(provider) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee41() {
        return _regenerator().w(function (_context41) {
          while (1) switch (_context41.n) {
            case 0:
              validate('stytch.oauth.attach').isString('Provider', provider);
              _context41.n = 1;
              return this._networkClient.fetchSDK({
                url: '/oauth/attach',
                method: 'POST',
                body: {
                  provider: provider
                }
              });
            case 1:
              return _context41.a(2, _context41.v);
          }
        }, _callee41, this);
      }));
    }
  }, {
    key: "getBaseApiUrl",
    value: function getBaseApiUrl() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee42() {
        var _yield$this$_dynamicC, cnameDomain;
        return _regenerator().w(function (_context42) {
          while (1) switch (_context42.n) {
            case 0:
              _context42.n = 1;
              return this._dynamicConfig;
            case 1:
              _yield$this$_dynamicC = _context42.v;
              cnameDomain = _yield$this$_dynamicC.cnameDomain;
              if (!cnameDomain) {
                _context42.n = 2;
                break;
              }
              return _context42.a(2, "https://".concat(cnameDomain));
            case 2:
              if (!isTestPublicToken(this._config.publicToken)) {
                _context42.n = 3;
                break;
              }
              return _context42.a(2, this._config.testAPIURL);
            case 3:
              return _context42.a(2, this._config.liveAPIURL);
          }
        }, _callee42, this);
      }));
    }
  }, {
    key: "startOAuthFlow",
    value: function startOAuthFlow(providerType) {
      var _this9 = this;
      return function () {
        var _ref6 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
          login_redirect_url = _ref6.login_redirect_url,
          signup_redirect_url = _ref6.signup_redirect_url,
          custom_scopes = _ref6.custom_scopes,
          provider_params = _ref6.provider_params,
          oauth_attach_token = _ref6.oauth_attach_token;
        return __awaiter(_this9, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee43() {
          var _yield$this$_dynamicC2, cnameDomain, pkceRequiredForOAuth, baseURL, oauthUrl, keyPair, key;
          return _regenerator().w(function (_context43) {
            while (1) switch (_context43.n) {
              case 0:
                _context43.n = 1;
                return this._dynamicConfig;
              case 1:
                _yield$this$_dynamicC2 = _context43.v;
                cnameDomain = _yield$this$_dynamicC2.cnameDomain;
                pkceRequiredForOAuth = _yield$this$_dynamicC2.pkceRequiredForOAuth;
                _context43.n = 2;
                return this.getBaseApiUrl();
              case 2:
                baseURL = _context43.v;
                this._networkClient.logEvent({
                  name: 'start_oauth_flow',
                  details: {
                    provider_type: providerType,
                    custom_scopes: custom_scopes,
                    cname_domain: cnameDomain,
                    pkce: pkceRequiredForOAuth,
                    provider_params: provider_params
                  }
                });
                oauthUrl = new URL("".concat(baseURL, "/v1/public/oauth/").concat(providerType, "/start"));
                oauthUrl.searchParams.set('public_token', this._config.publicToken);
                if (!pkceRequiredForOAuth) {
                  _context43.n = 4;
                  break;
                }
                _context43.n = 3;
                return this._pkceManager.startPKCETransaction();
              case 3:
                keyPair = _context43.v;
                oauthUrl.searchParams.set('code_challenge', keyPair.code_challenge);
                _context43.n = 5;
                break;
              case 4:
                this._pkceManager.clearPKPair();
              case 5:
                if (custom_scopes) {
                  validate('startOAuthFlow').isStringArray('custom_scopes', custom_scopes);
                  oauthUrl.searchParams.set('custom_scopes', custom_scopes.join(' '));
                }
                if (provider_params) {
                  validate('startOAuthFlow').isOptionalObject('provider_params', provider_params);
                  for (key in provider_params) {
                    oauthUrl.searchParams.set('provider_' + key, provider_params[key]);
                  }
                }
                if (login_redirect_url) oauthUrl.searchParams.set('login_redirect_url', login_redirect_url);
                if (signup_redirect_url) oauthUrl.searchParams.set('signup_redirect_url', signup_redirect_url);
                if (oauth_attach_token) oauthUrl.searchParams.set('oauth_attach_token', oauth_attach_token);
                window.location.href = oauthUrl.toString();
              case 6:
                return _context43.a(2);
            }
          }, _callee43, this);
        }));
      };
    }
  }]);
}();
var DefaultDynamicConfig$3 = Promise.resolve({
  siweRequiredForCryptoWallets: false
});
var HeadlessCryptoWalletClient = /*#__PURE__*/function () {
  function HeadlessCryptoWalletClient(_networkClient, _apiNetworkClient, _subscriptionService) {
    var _this0 = this;
    var executeRecaptcha = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : function () {
      return Promise.resolve(undefined);
    };
    var dfpProtectedAuth = arguments.length > 4 ? arguments[4] : undefined;
    var _config = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : DefaultDynamicConfig$3;
    _classCallCheck(this, HeadlessCryptoWalletClient);
    this._networkClient = _networkClient;
    this._apiNetworkClient = _apiNetworkClient;
    this._subscriptionService = _subscriptionService;
    this.executeRecaptcha = executeRecaptcha;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this._config = _config;
    this.authenticate = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this0, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee44() {
        var _yield$this$dfpProtec9, dfp_telemetry_id, captcha_token, resp;
        return _regenerator().w(function (_context44) {
          while (1) switch (_context44.n) {
            case 0:
              validate('stytch.cryptoWallets.authenticate').isString('signature', options.signature).isString('crypto_wallet_address', options.crypto_wallet_address).isString('crypto_wallet_type', options.crypto_wallet_type).isNumber('session_duration_minutes', options.session_duration_minutes);
              _context44.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec9 = _context44.v;
              dfp_telemetry_id = _yield$this$dfpProtec9.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec9.captcha_token;
              _context44.n = 2;
              return this._apiNetworkClient.retriableFetchSDK({
                url: '/crypto_wallets/authenticate',
                method: 'POST',
                body: {
                  session_duration_minutes: options.session_duration_minutes,
                  crypto_wallet_address: options.crypto_wallet_address,
                  crypto_wallet_type: options.crypto_wallet_type,
                  signature: options.signature,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 2:
              resp = _context44.v;
              return _context44.a(2, omitUser(resp));
          }
        }, _callee44, this);
      }));
    });
  }
  return _createClass(HeadlessCryptoWalletClient, [{
    key: "authenticateStart",
    value: function authenticateStart(options) {
      var _a;
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee45() {
        var isLoggedIn, captcha_token, _yield$this$_config3, siweRequiredForCryptoWallets, body, endpoint, requestBody;
        return _regenerator().w(function (_context45) {
          while (1) switch (_context45.n) {
            case 0:
              validate('stytch.cryptoWallets.authenticateStart').isString('crypto_wallet_address', options.crypto_wallet_address).isString('crypto_wallet_type', options.crypto_wallet_type);
              if (options.siwe_params) {
                validate('stytch.cryptoWallets.authenticateStart').isOptionalString('uri', options.siwe_params.uri).isOptionalString('chain_id', options.siwe_params.chain_id).isOptionalString('issued_at', options.siwe_params.issued_at).isOptionalString('statement', options.siwe_params.statement).isOptionalString('not_before', options.siwe_params.not_before).isOptionalString('message_request_id', options.siwe_params.message_request_id).isOptionalStringArray('resources', options.siwe_params.resources);
              }
              isLoggedIn = !!this._subscriptionService.getSession();
              _context45.n = 1;
              return this.executeRecaptcha();
            case 1:
              captcha_token = _context45.v;
              _context45.n = 2;
              return this._config;
            case 2:
              _yield$this$_config3 = _context45.v;
              siweRequiredForCryptoWallets = _yield$this$_config3.siweRequiredForCryptoWallets;
              body = {
                crypto_wallet_address: options.crypto_wallet_address,
                crypto_wallet_type: options.crypto_wallet_type
              };
              if (siweRequiredForCryptoWallets && options.crypto_wallet_type == 'ethereum') {
                body.siwe_params = Object.assign(Object.assign({}, options.siwe_params), {
                  uri: ((_a = options.siwe_params) === null || _a === void 0 ? void 0 : _a.uri) || window.location.origin
                });
              }
              endpoint = isLoggedIn ? '/crypto_wallets/authenticate/start/secondary' : '/crypto_wallets/authenticate/start/primary';
              requestBody = Object.assign(Object.assign({}, body), {
                captcha_token: captcha_token
              });
              return _context45.a(2, this._apiNetworkClient.fetchSDK({
                url: endpoint,
                method: 'POST',
                body: requestBody
              }));
          }
        }, _callee45, this);
      }));
    }
  }]);
}();
var HeadlessTOTPClient = /*#__PURE__*/function () {
  function HeadlessTOTPClient(_networkClient, _subscriptionService, dfpProtectedAuth) {
    var _this1 = this;
    _classCallCheck(this, HeadlessTOTPClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.authenticate = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this1, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee46() {
        var _yield$this$dfpProtec0, dfp_telemetry_id, captcha_token, resp;
        return _regenerator().w(function (_context46) {
          while (1) switch (_context46.n) {
            case 0:
              validate('stytch.totps.authenticate').isNumber('session_duration_minutes', options.session_duration_minutes).isString('totp_code', options.totp_code);
              _context46.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec0 = _context46.v;
              dfp_telemetry_id = _yield$this$dfpProtec0.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec0.captcha_token;
              _context46.n = 2;
              return this._networkClient.retriableFetchSDK({
                url: '/totps/authenticate',
                method: 'POST',
                body: {
                  session_duration_minutes: options.session_duration_minutes,
                  totp_code: options.totp_code,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 2:
              resp = _context46.v;
              return _context46.a(2, omitUser(resp));
          }
        }, _callee46, this);
      }));
    });
    this.recover = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this1, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee47() {
        var _yield$this$dfpProtec1, dfp_telemetry_id, captcha_token, resp;
        return _regenerator().w(function (_context47) {
          while (1) switch (_context47.n) {
            case 0:
              validate('stytch.totps.recover').isNumber('session_duration_minutes', options.session_duration_minutes).isString('recovery_code', options.recovery_code);
              _context47.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec1 = _context47.v;
              dfp_telemetry_id = _yield$this$dfpProtec1.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec1.captcha_token;
              _context47.n = 2;
              return this._networkClient.retriableFetchSDK({
                url: '/totps/recover',
                method: 'POST',
                body: {
                  session_duration_minutes: options.session_duration_minutes,
                  recovery_code: options.recovery_code,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 2:
              resp = _context47.v;
              return _context47.a(2, omitUser(resp));
          }
        }, _callee47, this);
      }));
    });
  }
  return _createClass(HeadlessTOTPClient, [{
    key: "create",
    value: function create(options) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee48() {
        var resp;
        return _regenerator().w(function (_context48) {
          while (1) switch (_context48.n) {
            case 0:
              validate('stytch.totps.create').isNumber('expiration_minutes', options.expiration_minutes);
              _context48.n = 1;
              return this._networkClient.fetchSDK({
                url: '/totps',
                method: 'POST',
                body: {
                  expiration_minutes: options.expiration_minutes
                }
              });
            case 1:
              resp = _context48.v;
              this._subscriptionService.updateUser(resp.__user);
              return _context48.a(2, omitUser(resp));
          }
        }, _callee48, this);
      }));
    }
  }, {
    key: "recoveryCodes",
    value: function recoveryCodes() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee49() {
        return _regenerator().w(function (_context49) {
          while (1) switch (_context49.n) {
            case 0:
              return _context49.a(2, this._networkClient.fetchSDK({
                url: '/totps/recovery_codes',
                method: 'POST'
              }));
          }
        }, _callee49, this);
      }));
    }
  }]);
}(); // src/webauthn-json/base64url.ts
function base64urlToBuffer(baseurl64String) {
  var padding = "==".slice(0, (4 - baseurl64String.length % 4) % 4);
  var base64String = baseurl64String.replace(/-/g, "+").replace(/_/g, "/") + padding;
  var str = atob(base64String);
  var buffer = new ArrayBuffer(str.length);
  var byteView = new Uint8Array(buffer);
  for (var _i = 0; _i < str.length; _i++) {
    byteView[_i] = str.charCodeAt(_i);
  }
  return buffer;
}
function bufferToBase64url(buffer) {
  var byteView = new Uint8Array(buffer);
  var str = "";
  var _iterator2 = _createForOfIteratorHelper(byteView),
    _step2;
  try {
    for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {
      var charCode = _step2.value;
      str += String.fromCharCode(charCode);
    }
  } catch (err) {
    _iterator2.e(err);
  } finally {
    _iterator2.f();
  }
  var base64String = btoa(str);
  var base64urlString = base64String.replace(/\+/g, "-").replace(/\//g, "_").replace(/=/g, "");
  return base64urlString;
}
// src/webauthn-json/convert.ts
var copyValue = "copy";
var convertValue = "convert";
function convert(conversionFn, schema2, input) {
  if (schema2 === copyValue) {
    return input;
  }
  if (schema2 === convertValue) {
    return conversionFn(input);
  }
  if (schema2 instanceof Array) {
    return input.map(function (v) {
      return convert(conversionFn, schema2[0], v);
    });
  }
  if (schema2 instanceof Object) {
    var output = {};
    for (var _i2 = 0, _Object$entries = Object.entries(schema2); _i2 < _Object$entries.length; _i2++) {
      var _Object$entries$_i = _slicedToArray(_Object$entries[_i2], 2),
        key = _Object$entries$_i[0],
        schemaField = _Object$entries$_i[1];
      if (schemaField.derive) {
        var v = schemaField.derive(input);
        if (v !== void 0) {
          input[key] = v;
        }
      }
      if (!(key in input)) {
        if (schemaField.required) {
          throw new Error("Missing key: ".concat(key));
        }
        continue;
      }
      if (input[key] == null) {
        output[key] = null;
        continue;
      }
      output[key] = convert(conversionFn, schemaField.schema, input[key]);
    }
    return output;
  }
}
function derived(schema2, derive) {
  return {
    required: true,
    schema: schema2,
    derive: derive
  };
}
function required(schema2) {
  return {
    required: true,
    schema: schema2
  };
}
function optional(schema2) {
  return {
    required: false,
    schema: schema2
  };
}
// src/webauthn-json/basic/schema.ts
var publicKeyCredentialDescriptorSchema = {
  type: required(copyValue),
  id: required(convertValue),
  transports: optional(copyValue)
};
var simplifiedExtensionsSchema = {
  appid: optional(copyValue),
  appidExclude: optional(copyValue),
  credProps: optional(copyValue)
};
var simplifiedClientExtensionResultsSchema = {
  appid: optional(copyValue),
  appidExclude: optional(copyValue),
  credProps: optional(copyValue)
};
var credentialCreationOptions = {
  publicKey: required({
    rp: required(copyValue),
    user: required({
      id: required(convertValue),
      name: required(copyValue),
      displayName: required(copyValue)
    }),
    challenge: required(convertValue),
    pubKeyCredParams: required(copyValue),
    timeout: optional(copyValue),
    excludeCredentials: optional([publicKeyCredentialDescriptorSchema]),
    authenticatorSelection: optional(copyValue),
    attestation: optional(copyValue),
    extensions: optional(simplifiedExtensionsSchema)
  }),
  signal: optional(copyValue)
};
var publicKeyCredentialWithAttestation = {
  type: required(copyValue),
  id: required(copyValue),
  rawId: required(convertValue),
  authenticatorAttachment: optional(copyValue),
  response: required({
    clientDataJSON: required(convertValue),
    attestationObject: required(convertValue),
    transports: derived(copyValue, function (response) {
      var _a;
      return ((_a = response.getTransports) == null ? void 0 : _a.call(response)) || [];
    })
  }),
  clientExtensionResults: derived(simplifiedClientExtensionResultsSchema, function (pkc) {
    return pkc.getClientExtensionResults();
  })
};
var credentialRequestOptions = {
  mediation: optional(copyValue),
  publicKey: required({
    challenge: required(convertValue),
    timeout: optional(copyValue),
    rpId: optional(copyValue),
    allowCredentials: optional([publicKeyCredentialDescriptorSchema]),
    userVerification: optional(copyValue),
    extensions: optional(simplifiedExtensionsSchema)
  }),
  signal: optional(copyValue)
};
var publicKeyCredentialWithAssertion = {
  type: required(copyValue),
  id: required(copyValue),
  rawId: required(convertValue),
  authenticatorAttachment: optional(copyValue),
  response: required({
    clientDataJSON: required(convertValue),
    authenticatorData: required(convertValue),
    signature: required(convertValue),
    userHandle: required(convertValue)
  }),
  clientExtensionResults: derived(simplifiedClientExtensionResultsSchema, function (pkc) {
    return pkc.getClientExtensionResults();
  })
};
// src/webauthn-json/basic/api.ts
function createRequestFromJSON(requestJSON) {
  return convert(base64urlToBuffer, credentialCreationOptions, requestJSON);
}
function createResponseToJSON(credential) {
  return convert(bufferToBase64url, publicKeyCredentialWithAttestation, credential);
}
function create(requestJSON) {
  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee50() {
    var credential;
    return _regenerator().w(function (_context50) {
      while (1) switch (_context50.n) {
        case 0:
          _context50.n = 1;
          return navigator.credentials.create(createRequestFromJSON(requestJSON));
        case 1:
          credential = _context50.v;
          return _context50.a(2, createResponseToJSON(credential));
      }
    }, _callee50);
  }));
}
function getRequestFromJSON(requestJSON) {
  return convert(base64urlToBuffer, credentialRequestOptions, requestJSON);
}
function getResponseToJSON(credential) {
  return convert(bufferToBase64url, publicKeyCredentialWithAssertion, credential);
}
function get(requestJSON) {
  return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee51() {
    var credential;
    return _regenerator().w(function (_context51) {
      while (1) switch (_context51.n) {
        case 0:
          _context51.n = 1;
          return navigator.credentials.get(getRequestFromJSON(requestJSON));
        case 1:
          credential = _context51.v;
          return _context51.a(2, getResponseToJSON(credential));
      }
    }, _callee51);
  }));
}
var HeadlessWebAuthnClient = /*#__PURE__*/function () {
  function HeadlessWebAuthnClient(_networkClient, _subscriptionService, dfpProtectedAuth) {
    var _this10 = this;
    _classCallCheck(this, HeadlessWebAuthnClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.register = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this10, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee52() {
        var _a, _b, startResp, publicKeyCredentialCreationOptions, publicKey, credential, resp;
        return _regenerator().w(function (_context52) {
          while (1) switch (_context52.n) {
            case 0:
              validate('stytch.webauthn.register').isOptionalString('domain', options === null || options === void 0 ? void 0 : options.domain).isOptionalString('authenticator_type', options === null || options === void 0 ? void 0 : options.authenticator_type).isOptionalBoolean('is_passkey', options === null || options === void 0 ? void 0 : options.is_passkey).isOptionalNumber('session_duration_minutes', options === null || options === void 0 ? void 0 : options.session_duration_minutes).isOptionalString('override_id', options === null || options === void 0 ? void 0 : options.override_id).isOptionalString('override_name', options === null || options === void 0 ? void 0 : options.override_name).isOptionalString('override_display_name', options === null || options === void 0 ? void 0 : options.override_display_name).isOptionalBoolean('use_base64_url_encoding', options === null || options === void 0 ? void 0 : options.use_base64_url_encoding);
              _context52.n = 1;
              return this._networkClient.fetchSDK({
                url: '/webauthn/register/start',
                method: 'POST',
                body: {
                  domain: (_a = options === null || options === void 0 ? void 0 : options.domain) !== null && _a !== void 0 ? _a : window.location.hostname,
                  authenticator_type: (_b = options === null || options === void 0 ? void 0 : options.authenticator_type) !== null && _b !== void 0 ? _b : undefined,
                  return_passkey_credential_options: options === null || options === void 0 ? void 0 : options.is_passkey,
                  override_id: options === null || options === void 0 ? void 0 : options.override_id,
                  override_name: options === null || options === void 0 ? void 0 : options.override_name,
                  override_display_name: options === null || options === void 0 ? void 0 : options.override_display_name,
                  user_agent: navigator.userAgent,
                  use_base64_url_encoding: options === null || options === void 0 ? void 0 : options.use_base64_url_encoding
                }
              });
            case 1:
              startResp = _context52.v;
              publicKeyCredentialCreationOptions = startResp.public_key_credential_creation_options;
              publicKey = JSON.parse(publicKeyCredentialCreationOptions);
              _context52.n = 2;
              return create({
                publicKey: publicKey
              });
            case 2:
              credential = _context52.v;
              _context52.n = 3;
              return this._networkClient.fetchSDK({
                url: '/webauthn/register',
                method: 'POST',
                body: {
                  public_key_credential: JSON.stringify(credential),
                  session_duration_minutes: options === null || options === void 0 ? void 0 : options.session_duration_minutes
                }
              });
            case 3:
              resp = _context52.v;
              return _context52.a(2, omitUser(resp));
          }
        }, _callee52, this);
      }));
    });
    this.authenticate = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this10, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee53() {
        var _c, _d, _yield$this$dfpProtec10, dfp_telemetry_id, captcha_token, isLoggedIn, endpoint, startResp, publicKeyCredentialRequestOptions, abortController, credReqOptions, conditionalMediationCredReqOption, credential, authenticationData;
        return _regenerator().w(function (_context53) {
          while (1) switch (_context53.n) {
            case 0:
              validate('stytch.webauthn.authenticate').isOptionalString('domain', options.domain).isNumber('session_duration_minutes', options.session_duration_minutes).isOptionalBoolean('is_passkey', options.is_passkey).isOptionalObject('signal', options.signal);
              _context53.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec10 = _context53.v;
              dfp_telemetry_id = _yield$this$dfpProtec10.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec10.captcha_token;
              if (!options.conditional_mediation) {
                _context53.n = 4;
                break;
              }
              _context53.n = 2;
              return this.browserSupportsAutofill();
            case 2:
              if (_context53.v) {
                _context53.n = 3;
                break;
              }
              logger.error('Browser does not support WebAuthn autofill');
              return _context53.a(2, null);
            case 3:
              if (this.checkEligibleInputs()) {
                _context53.n = 4;
                break;
              }
              return _context53.a(2, null);
            case 4:
              isLoggedIn = !!this._subscriptionService.getSession();
              endpoint = isLoggedIn ? '/webauthn/authenticate/start/secondary' : '/webauthn/authenticate/start/primary';
              _context53.n = 5;
              return this._networkClient.fetchSDK({
                url: endpoint,
                method: 'POST',
                body: {
                  domain: (_c = options.domain) !== null && _c !== void 0 ? _c : window.location.hostname,
                  return_passkey_credential_options: options === null || options === void 0 ? void 0 : options.is_passkey
                }
              });
            case 5:
              startResp = _context53.v;
              publicKeyCredentialRequestOptions = startResp.public_key_credential_request_options;
              abortController = new AbortController();
              credReqOptions = {
                publicKey: JSON.parse(publicKeyCredentialRequestOptions),
                signal: (_d = options.signal) !== null && _d !== void 0 ? _d : abortController.signal
              };
              conditionalMediationCredReqOption = Object.assign(Object.assign({}, credReqOptions), {
                mediation: 'conditional'
              });
              _context53.n = 6;
              return get(options.conditional_mediation ? conditionalMediationCredReqOption : credReqOptions);
            case 6:
              credential = _context53.v;
              _context53.n = 7;
              return this._networkClient.retriableFetchSDK({
                url: '/webauthn/authenticate',
                method: 'POST',
                body: {
                  public_key_credential: JSON.stringify(credential),
                  session_duration_minutes: options.session_duration_minutes,
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 7:
              authenticationData = _context53.v;
              return _context53.a(2, omitUser(authenticationData));
          }
        }, _callee53, this);
      }));
    });
    this.checkEligibleInputs = function () {
      // Check for an <input> with "webauthn" in its `autocomplete` attribute
      var eligibleInputs = document.querySelectorAll("input[autocomplete*='webauthn']");
      // WebAuthn autofill requires at least one valid input
      if (eligibleInputs.length < 1) {
        logger.error('No <input> with `"webauthn"` in its `autocomplete` attribute was detected');
        return false;
      }
      return true;
    };
  }
  return _createClass(HeadlessWebAuthnClient, [{
    key: "update",
    value: function update(options) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee54() {
        var url;
        return _regenerator().w(function (_context54) {
          while (1) switch (_context54.n) {
            case 0:
              validate('stytch.webauthn.update').isString('webauthn_registration_id', options.webauthn_registration_id).isString('name', options.name);
              url = '/webauthn/update/' + options.webauthn_registration_id;
              _context54.n = 1;
              return this._networkClient.fetchSDK({
                url: url,
                method: 'PUT',
                body: {
                  name: options.name
                }
              });
            case 1:
              return _context54.a(2, _context54.v);
          }
        }, _callee54, this);
      }));
    }
  }, {
    key: "browserSupportsAutofill",
    value: function browserSupportsAutofill() {
      var _a, _b, _c;
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee55() {
        var _t0, _t1, _t10;
        return _regenerator().w(function (_context55) {
          while (1) switch (_context55.n) {
            case 0:
              _context55.n = 1;
              return (_b = (_a = window.PublicKeyCredential) === null || _a === void 0 ? void 0 : _a.isConditionalMediationAvailable) === null || _b === void 0 ? void 0 : _b.call(_a);
            case 1:
              _t1 = _c = _context55.v;
              _t0 = _t1 !== null;
              if (!_t0) {
                _context55.n = 2;
                break;
              }
              _t0 = _c !== void 0;
            case 2:
              if (!_t0) {
                _context55.n = 3;
                break;
              }
              _t10 = _c;
              _context55.n = 4;
              break;
            case 3:
              _t10 = false;
            case 4:
              return _context55.a(2, _t10);
          }
        }, _callee55);
      }));
    }
  }]);
}();
var DefaultDynamicConfig$2 = Promise.resolve({
  pkceRequiredForPasswordResets: false
});
var HeadlessPasswordClient = /*#__PURE__*/function () {
  function HeadlessPasswordClient(_networkClient, _subscriptionService, _pkceManager) {
    var _this11 = this;
    var _config = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : DefaultDynamicConfig$2;
    var dfpProtectedAuth = arguments.length > 4 ? arguments[4] : undefined;
    _classCallCheck(this, HeadlessPasswordClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this._pkceManager = _pkceManager;
    this._config = _config;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.create = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this11, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee56() {
        var _yield$this$dfpProtec11, dfp_telemetry_id, captcha_token, resp;
        return _regenerator().w(function (_context56) {
          while (1) switch (_context56.n) {
            case 0:
              validate('stytch.passwords.create').isString('password', options.password).isString('email', options.email).isNumber('session_duration_minutes', options.session_duration_minutes);
              _context56.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec11 = _context56.v;
              dfp_telemetry_id = _yield$this$dfpProtec11.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec11.captcha_token;
              _context56.n = 2;
              return this._networkClient.retriableFetchSDK({
                url: '/passwords',
                method: 'POST',
                body: {
                  email: options.email,
                  password: options.password,
                  session_duration_minutes: options.session_duration_minutes,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 2:
              resp = _context56.v;
              return _context56.a(2, omitUser(resp));
          }
        }, _callee56, this);
      }));
    });
    this.authenticate = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this11, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee57() {
        var _yield$this$dfpProtec12, dfp_telemetry_id, captcha_token, resp;
        return _regenerator().w(function (_context57) {
          while (1) switch (_context57.n) {
            case 0:
              validate('stytch.passwords.authenticate').isString('password', options.password).isString('email', options.email).isNumber('session_duration_minutes', options.session_duration_minutes);
              _context57.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec12 = _context57.v;
              dfp_telemetry_id = _yield$this$dfpProtec12.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec12.captcha_token;
              _context57.n = 2;
              return this._networkClient.retriableFetchSDK({
                url: '/passwords/authenticate',
                method: 'POST',
                body: {
                  email: options.email,
                  password: options.password,
                  session_duration_minutes: options.session_duration_minutes,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 2:
              resp = _context57.v;
              return _context57.a(2, omitUser(resp));
          }
        }, _callee57, this);
      }));
    });
    this.resetByEmail = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this11, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee58() {
        var _yield$this$dfpProtec13, dfp_telemetry_id, captcha_token, pkPair, code_verifier, resp;
        return _regenerator().w(function (_context58) {
          while (1) switch (_context58.n) {
            case 0:
              validate('stytch.passwords.resetByEmail').isString('token', options.token).isString('password', options.password).isNumber('session_duration_minutes', options.session_duration_minutes);
              _context58.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec13 = _context58.v;
              dfp_telemetry_id = _yield$this$dfpProtec13.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec13.captcha_token;
              _context58.n = 2;
              return this._pkceManager.getPKPair();
            case 2:
              pkPair = _context58.v;
              code_verifier = pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier;
              _context58.n = 3;
              return this._networkClient.retriableFetchSDK({
                url: '/passwords/email/reset',
                method: 'POST',
                body: {
                  token: options.token,
                  password: options.password,
                  session_duration_minutes: options.session_duration_minutes,
                  captcha_token: captcha_token,
                  code_verifier: code_verifier,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 3:
              resp = _context58.v;
              this._pkceManager.clearPKPair();
              return _context58.a(2, omitUser(resp));
          }
        }, _callee58, this);
      }));
    });
    this.resetByExistingPassword = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this11, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee59() {
        var _yield$this$dfpProtec14, dfp_telemetry_id, captcha_token, resp;
        return _regenerator().w(function (_context59) {
          while (1) switch (_context59.n) {
            case 0:
              validate('stytch.passwords.resetByExistingPassword').isString('email', options.email).isString('existing_password', options.existing_password).isString('new_password', options.new_password).isNumber('session_duration_minutes', options.session_duration_minutes);
              _context59.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec14 = _context59.v;
              dfp_telemetry_id = _yield$this$dfpProtec14.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec14.captcha_token;
              _context59.n = 2;
              return this._networkClient.retriableFetchSDK({
                url: '/passwords/existing_password/reset',
                method: 'POST',
                body: {
                  email: options.email,
                  existing_password: options.existing_password,
                  new_password: options.new_password,
                  session_duration_minutes: options.session_duration_minutes,
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 2:
              resp = _context59.v;
              return _context59.a(2, omitUser(resp));
          }
        }, _callee59, this);
      }));
    });
    this.resetBySession = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this11, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee60() {
        var _yield$this$dfpProtec15, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context60) {
          while (1) switch (_context60.n) {
            case 0:
              validate('stytch.passwords.resetBySession').isString('password', options.password);
              _context60.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec15 = _context60.v;
              dfp_telemetry_id = _yield$this$dfpProtec15.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec15.captcha_token;
              return _context60.a(2, this._networkClient.retriableFetchSDK({
                url: '/passwords/session/reset',
                method: 'POST',
                body: {
                  password: options.password,
                  session_duration_minutes: options.session_duration_minutes,
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee60, this);
      }));
    });
  }
  return _createClass(HeadlessPasswordClient, [{
    key: "getCodeChallenge",
    value: function getCodeChallenge() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee61() {
        var _yield$this$_config4, pkceRequiredForPasswordResets, keyPair;
        return _regenerator().w(function (_context61) {
          while (1) switch (_context61.n) {
            case 0:
              _context61.n = 1;
              return this._config;
            case 1:
              _yield$this$_config4 = _context61.v;
              pkceRequiredForPasswordResets = _yield$this$_config4.pkceRequiredForPasswordResets;
              if (pkceRequiredForPasswordResets) {
                _context61.n = 2;
                break;
              }
              return _context61.a(2, undefined);
            case 2:
              _context61.n = 3;
              return this._pkceManager.getPKPair();
            case 3:
              keyPair = _context61.v;
              if (!keyPair) {
                _context61.n = 4;
                break;
              }
              return _context61.a(2, keyPair.code_challenge);
            case 4:
              _context61.n = 5;
              return this._pkceManager.startPKCETransaction();
            case 5:
              keyPair = _context61.v;
              return _context61.a(2, keyPair.code_challenge);
          }
        }, _callee61, this);
      }));
    }
  }, {
    key: "resetByEmailStart",
    value: function resetByEmailStart(options) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee62() {
        var code_challenge, _yield$this$dfpProtec16, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context62) {
          while (1) switch (_context62.n) {
            case 0:
              validate('stytch.passwords.resetByEmailStart').isString('email', options.email).isOptionalString('login_redirect_url', options.login_redirect_url).isOptionalString('reset_password_redirect_url', options.reset_password_redirect_url).isOptionalString('reset_password_template_id', options.reset_password_template_id).isOptionalNumber('reset_password_expiration_minutes', options.reset_password_expiration_minutes).isOptionalString('locale', options.locale);
              _context62.n = 1;
              return this.getCodeChallenge();
            case 1:
              code_challenge = _context62.v;
              _context62.n = 2;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 2:
              _yield$this$dfpProtec16 = _context62.v;
              dfp_telemetry_id = _yield$this$dfpProtec16.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec16.captcha_token;
              return _context62.a(2, this._networkClient.retriableFetchSDK({
                url: '/passwords/email/reset/start',
                method: 'POST',
                body: {
                  email: options.email,
                  login_redirect_url: options.login_redirect_url,
                  reset_password_redirect_url: options.reset_password_redirect_url,
                  reset_password_expiration_minutes: options.reset_password_expiration_minutes,
                  reset_password_template_id: options.reset_password_template_id,
                  locale: options.locale,
                  code_challenge: code_challenge,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee62, this);
      }));
    }
  }, {
    key: "strengthCheck",
    value: function strengthCheck(options) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee63() {
        return _regenerator().w(function (_context63) {
          while (1) switch (_context63.n) {
            case 0:
              validate('stytch.passwords.strengthCheck').isOptionalString('email', options.email).isString('password', options.password);
              return _context63.a(2, this._networkClient.fetchSDK({
                url: '/passwords/strength_check',
                method: 'POST',
                body: {
                  email: options.email,
                  password: options.password
                }
              }));
          }
        }, _callee63, this);
      }));
    }
  }]);
}();
var HeadlessImpersonationClient = /*#__PURE__*/_createClass(function HeadlessImpersonationClient(_networkClient, _subscriptionService, dfpProtectedAuth) {
  var _this12 = this;
  _classCallCheck(this, HeadlessImpersonationClient);
  this._networkClient = _networkClient;
  this._subscriptionService = _subscriptionService;
  this.dfpProtectedAuth = dfpProtectedAuth;
  this.authenticate = this._subscriptionService.withUpdateSession(function (data) {
    return __awaiter(_this12, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee64() {
      var _yield$this$dfpProtec17, dfp_telemetry_id, captcha_token;
      return _regenerator().w(function (_context64) {
        while (1) switch (_context64.n) {
          case 0:
            validate('stytch.impersonation.authenticate').isString('impersonation_token', data.impersonation_token);
            _context64.n = 1;
            return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
          case 1:
            _yield$this$dfpProtec17 = _context64.v;
            dfp_telemetry_id = _yield$this$dfpProtec17.dfp_telemetry_id;
            captcha_token = _yield$this$dfpProtec17.captcha_token;
            return _context64.a(2, this._networkClient.retriableFetchSDK({
              url: '/impersonation/authenticate',
              body: Object.assign(Object.assign({}, data), {
                dfp_telemetry_id: dfp_telemetry_id,
                captcha_token: captcha_token
              }),
              method: 'POST',
              retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
            }));
        }
      }, _callee64, this);
    }));
  });
});
var WILDCARD_ACTION = '*';
/**
 * RBACPolicy represents an instance of a parsed Stytch RBAC policy object
 * It contains methods for computing outcomes for various permissions questions
 */
var RBACPolicy = /*#__PURE__*/function () {
  function RBACPolicy(roles, resources) {
    var _this13 = this;
    _classCallCheck(this, RBACPolicy);
    this.roles = roles;
    this.resources = resources;
    this.rolesByID = {};
    roles.forEach(function (role) {
      return _this13.rolesByID[role.role_id] = role;
    });
  }
  return _createClass(RBACPolicy, [{
    key: "mergeWithCustomRoles",
    value:
    /**
     * Merges organization custom roles with this project policy.
     * Custom roles are additive - they add additional roles on top of the base project policy.
     * Resources remain from the project policy, roles are combined.
     * @param customRoles Array of custom organization roles to add
     * @returns A new RBACPolicy instance with merged roles
     */
    function mergeWithCustomRoles(customRoles) {
      var mergedRoles = [].concat(_toConsumableArray(this.roles), _toConsumableArray(customRoles));
      // Resources come from the project policy - custom roles don't define new resources
      return new RBACPolicy(mergedRoles, this.resources);
    }
    /**
     * isAuthorized returns whether or not a user with a specific set of roles can perform a desired action
     * @example
     *  const canDoIt = policy.callerIsAuthorized(roles, 'files', 'create')
     *  console.log(canDoIt) // true
     */
  }, {
    key: "callerIsAuthorized",
    value: function callerIsAuthorized(memberRoles, resourceId, action) {
      var _this14 = this;
      return !!memberRoles.map(function (roleId) {
        return _this14.rolesByID[roleId];
      })
      // Defense in depth: filter out null/undefined in case memberRoles contains a role that doesn't match the policy
      // This may happen if the member is loaded _before_ a fresh RBAC policy is loaded
      .filter(function (v) {
        return v;
      }).flatMap(function (role) {
        return role.permissions;
      }).filter(function (permission) {
        return permission.resource_id === resourceId;
      }).find(function (permission) {
        return permission.actions.includes(action) || permission.actions.includes(WILDCARD_ACTION);
      });
    }
    /**
     * allPermissions generates a map that allows quick lookup of all the permissions available to the user
     * @example
     *   const perms = policy.allPermissions(roles)
     *   console.log(perms.files.create) // true
     *   console.log(perms.files.delete) // false
     */
  }, {
    key: "allPermissionsForCaller",
    value: function allPermissionsForCaller(memberRoles) {
      var _this15 = this;
      var allPermsMap = Object.create(null);
      this.resources.forEach(function (resource) {
        allPermsMap[resource.resource_id] = {};
        resource.actions.forEach(function (action) {
          allPermsMap[resource.resource_id][action] = _this15.callerIsAuthorized(memberRoles, resource.resource_id, action);
        });
      });
      return allPermsMap;
    }
  }], [{
    key: "fromJSON",
    value: function fromJSON(input) {
      return new RBACPolicy(input.roles, input.resources);
    }
  }]);
}();
var HeadlessRBACClient = /*#__PURE__*/function () {
  function HeadlessRBACClient(cachedConfig, dynamicConfig, _subscriptionService) {
    var _this16 = this;
    _classCallCheck(this, HeadlessRBACClient);
    this._subscriptionService = _subscriptionService;
    this.isAuthorizedSync = function (resourceId, action) {
      var _a;
      return !!((_a = _this16.cachedPolicy) === null || _a === void 0 ? void 0 : _a.callerIsAuthorized(_this16.roleIds(), resourceId, action));
    };
    this.isAuthorized = function (resourceId, action) {
      return _this16.policyPromise.then(function (policy) {
        return policy.callerIsAuthorized(_this16.roleIds(), resourceId, action);
      });
    };
    this.cachedPolicy = cachedConfig.rbacPolicy ? RBACPolicy.fromJSON(cachedConfig.rbacPolicy) : null;
    this.policyPromise = dynamicConfig.then(function (data) {
      if (!data.rbacPolicy) {
        logger.error('Unable to retrieve RBAC policy from servers. Assuming caller has no permissions.');
        return new RBACPolicy([], []);
      }
      // Update the existing policy too, so isAuthorizedSync will be up-to-date
      _this16.cachedPolicy = RBACPolicy.fromJSON(data.rbacPolicy);
      return _this16.cachedPolicy;
    });
  }
  return _createClass(HeadlessRBACClient, [{
    key: "allPermissions",
    value: function allPermissions() {
      var _this17 = this;
      return this.policyPromise.then(function (policy) {
        return policy.allPermissionsForCaller(_this17.roleIds());
      });
    }
  }, {
    key: "roleIds",
    value: function roleIds() {
      var _a;
      var user = this._subscriptionService.getUser();
      if (!user) {
        return [];
      }
      // Although user.roles is guaranteed to exist for fresh data, there is a chance
      // that the user stored in localstorage clientside comes from before roles were added to
      // the API response - in which case user.roles will be undefined and this will crash
      // TODO: [AUTH-2294] We can safely remove this ~3mos after RBAC is released
      return (_a = user.roles) !== null && _a !== void 0 ? _a : [];
    }
  }]);
}();
var HeadlessIDPClient = /*#__PURE__*/_createClass(function HeadlessIDPClient(_networkClient) {
  var _this18 = this;
  _classCallCheck(this, HeadlessIDPClient);
  this._networkClient = _networkClient;
  this.oauthAuthorizeStart = function (data) {
    return __awaiter(_this18, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee65() {
      return _regenerator().w(function (_context65) {
        while (1) switch (_context65.n) {
          case 0:
            return _context65.a(2, this._networkClient.fetchSDK({
              url: '/idp/oauth/authorize/start',
              method: 'POST',
              body: data
            }));
        }
      }, _callee65, this);
    }));
  };
  this.oauthAuthorizeSubmit = function (data) {
    return __awaiter(_this18, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee66() {
      return _regenerator().w(function (_context66) {
        while (1) switch (_context66.n) {
          case 0:
            return _context66.a(2, this._networkClient.fetchSDK({
              url: '/idp/oauth/authorize/submit',
              method: 'POST',
              body: data
            }));
        }
      }, _callee66, this);
    }));
  };
  this.oauthLogoutStart = function (data) {
    return __awaiter(_this18, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee67() {
      return _regenerator().w(function (_context67) {
        while (1) switch (_context67.n) {
          case 0:
            return _context67.a(2, this._networkClient.fetchSDK({
              url: "/oauth/logout/start",
              method: 'POST',
              body: data
            }));
        }
      }, _callee67, this);
    }));
  };
});
var DefaultDynamicConfig$1 = Promise.resolve({
  pkceRequiredForEmailMagicLinks: false
});
var HeadlessB2BMagicLinksClient = /*#__PURE__*/function () {
  function HeadlessB2BMagicLinksClient(_networkClient, _subscriptionService, _pkceManager, _passwordResetPKCEManager) {
    var _this19 = this;
    var _config = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : DefaultDynamicConfig$1;
    var dfpProtectedAuth = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : DisabledDFPProtectedAuthProvider();
    _classCallCheck(this, HeadlessB2BMagicLinksClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this._pkceManager = _pkceManager;
    this._passwordResetPKCEManager = _passwordResetPKCEManager;
    this._config = _config;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.email = {
      invite: function invite(data) {
        return __awaiter(_this19, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee68() {
          return _regenerator().w(function (_context68) {
            while (1) switch (_context68.n) {
              case 0:
                validate('stytch.magicLinks.email.invite').isString('email_address', data.email_address).isOptionalString('invite_redirect_url', data.invite_redirect_url).isOptionalString('invite_template_id', data.invite_template_id).isOptionalString('name', data.name).isOptionalString('locale', data.locale).isOptionalStringArray('roles', data.roles).isOptionalNumber('invite_expiration_minutes', data.invite_expiration_minutes);
                return _context68.a(2, this._networkClient.fetchSDK({
                  url: '/b2b/magic_links/email/invite',
                  body: data,
                  method: 'POST'
                }));
            }
          }, _callee68, this);
        }));
      },
      loginOrSignup: function loginOrSignup(data) {
        return __awaiter(_this19, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee69() {
          var pkce_code_challenge, requestBody;
          return _regenerator().w(function (_context69) {
            while (1) switch (_context69.n) {
              case 0:
                validate('stytch.magicLinks.email.loginOrSignup').isString('email_address', data.email_address).isString('organization_id', data.organization_id).isOptionalString('login_redirect_url', data.login_redirect_url).isOptionalString('login_template_id', data.login_template_id).isOptionalString('signup_redirect_url', data.signup_redirect_url).isOptionalString('signup_template_id', data.signup_template_id).isOptionalString('locale', data.locale).isOptionalNumber('login_expiration_minutes', data.login_expiration_minutes).isOptionalNumber('signup_expiration_minutes', data.signup_expiration_minutes);
                _context69.n = 1;
                return this.getCodeChallenge();
              case 1:
                pkce_code_challenge = _context69.v;
                requestBody = Object.assign(Object.assign({}, data), {
                  pkce_code_challenge: pkce_code_challenge
                });
                return _context69.a(2, this._networkClient.fetchSDK({
                  url: '/b2b/magic_links/email/login_or_signup',
                  body: requestBody,
                  method: 'POST'
                }));
            }
          }, _callee69, this);
        }));
      },
      discovery: {
        send: function send(data) {
          return __awaiter(_this19, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee70() {
            var _yield$this$dfpProtec18, dfp_telemetry_id, captcha_token, pkce_code_challenge, requestBody;
            return _regenerator().w(function (_context70) {
              while (1) switch (_context70.n) {
                case 0:
                  validate('stytch.magicLinks.email.discovery.send').isString('email_address', data.email_address).isOptionalString('discovery_redirect_url', data.discovery_redirect_url).isOptionalString('login_template_id', data.login_template_id).isOptionalString('locale', data.locale).isOptionalNumber('discovery_expiration_minutes', data.discovery_expiration_minutes);
                  _context70.n = 1;
                  return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
                case 1:
                  _yield$this$dfpProtec18 = _context70.v;
                  dfp_telemetry_id = _yield$this$dfpProtec18.dfp_telemetry_id;
                  captcha_token = _yield$this$dfpProtec18.captcha_token;
                  _context70.n = 2;
                  return this.getCodeChallenge();
                case 2:
                  pkce_code_challenge = _context70.v;
                  requestBody = Object.assign(Object.assign({}, data), {
                    pkce_code_challenge: pkce_code_challenge,
                    dfp_telemetry_id: dfp_telemetry_id,
                    captcha_token: captcha_token
                  });
                  return _context70.a(2, this._networkClient.retriableFetchSDK({
                    url: '/b2b/magic_links/email/discovery/send',
                    body: requestBody,
                    method: 'POST',
                    retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                  }));
              }
            }, _callee70, this);
          }));
        }
      }
    };
    this.authenticate = this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this19, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee71() {
        var passwordResetPKPair, resp, _t11;
        return _regenerator().w(function (_context71) {
          while (1) switch (_context71.p = _context71.n) {
            case 0:
              validate('stytch.magicLinks.authenticate').isString('magic_links_token', data.magic_links_token).isNumber('session_duration_minutes', data.session_duration_minutes).isOptionalString('locale', data.locale);
              // When a user resets their password with PKCE turned on, they create a pkPair in the 'passwords' namespace.
              // However, when the user gets the reset password email, they have the option to log in without a password.
              // This redirects them to the magic link authenticate flow, which automatically looks for the pkce code_verifier
              // in the 'magic_links' namespace, breaking the flow. Unfortunately we won't know for sure in the eml authenticate call
              // whether or not the user is coming from a password reset flow. To handle this, we have to try to authenticate with
              // both the 'passwords' and 'magic_links' code_verifiers.
              _context71.n = 1;
              return this._passwordResetPKCEManager.getPKPair();
            case 1:
              passwordResetPKPair = _context71.v;
              resp = null;
              if (!(passwordResetPKPair === null || passwordResetPKPair === void 0 ? void 0 : passwordResetPKPair.code_verifier)) {
                _context71.n = 6;
                break;
              }
              _context71.p = 2;
              _context71.n = 3;
              return this.handlePKCEForAuthenticate(this._passwordResetPKCEManager, data);
            case 3:
              resp = _context71.v;
              _context71.n = 6;
              break;
            case 4:
              _context71.p = 4;
              _t11 = _context71.v;
              if (!_t11.message.includes('pkce')) {
                _context71.n = 5;
                break;
              }
              // If pkce-related error, fall back to magic links code_verifier
              // eslint-disable-next-line no-console
              console.log('Authenticate with passwords pkce namespace failed. Falling back to authenticate with magic_links namespace.');
              _context71.n = 6;
              break;
            case 5:
              throw _t11;
            case 6:
              if (resp) {
                _context71.n = 8;
                break;
              }
              _context71.n = 7;
              return this.handlePKCEForAuthenticate(this._pkceManager, data);
            case 7:
              resp = _context71.v;
            case 8:
              return _context71.a(2, resp);
          }
        }, _callee71, this, [[2, 4]]);
      }));
    });
    this.discovery = {
      authenticate: this._subscriptionService.withUpdateSession(function (data) {
        return __awaiter(_this19, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee72() {
          var pkPair, _yield$this$dfpProtec19, dfp_telemetry_id, captcha_token, requestBody, resp;
          return _regenerator().w(function (_context72) {
            while (1) switch (_context72.n) {
              case 0:
                validate('stytch.magicLinks.discovery.authenticate').isString('discovery_magic_links_token', data.discovery_magic_links_token);
                _context72.n = 1;
                return this._pkceManager.getPKPair();
              case 1:
                pkPair = _context72.v;
                _context72.n = 2;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 2:
                _yield$this$dfpProtec19 = _context72.v;
                dfp_telemetry_id = _yield$this$dfpProtec19.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec19.captcha_token;
                requestBody = Object.assign({
                  pkce_code_verifier: pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier,
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                }, data);
                _context72.n = 3;
                return this._networkClient.retriableFetchSDK({
                  url: '/b2b/magic_links/discovery/authenticate',
                  body: requestBody,
                  method: 'POST',
                  retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                });
              case 3:
                resp = _context72.v;
                this._pkceManager.clearPKPair();
                return _context72.a(2, resp);
            }
          }, _callee72, this);
        }));
      })
    };
  }
  return _createClass(HeadlessB2BMagicLinksClient, [{
    key: "getCodeChallenge",
    value: function getCodeChallenge() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee73() {
        var _yield$this$_config5, pkceRequiredForEmailMagicLinks, keyPair;
        return _regenerator().w(function (_context73) {
          while (1) switch (_context73.n) {
            case 0:
              _context73.n = 1;
              return this._config;
            case 1:
              _yield$this$_config5 = _context73.v;
              pkceRequiredForEmailMagicLinks = _yield$this$_config5.pkceRequiredForEmailMagicLinks;
              if (pkceRequiredForEmailMagicLinks) {
                _context73.n = 2;
                break;
              }
              return _context73.a(2, undefined);
            case 2:
              _context73.n = 3;
              return this._pkceManager.getPKPair();
            case 3:
              keyPair = _context73.v;
              if (!keyPair) {
                _context73.n = 4;
                break;
              }
              return _context73.a(2, keyPair.code_challenge);
            case 4:
              _context73.n = 5;
              return this._pkceManager.startPKCETransaction();
            case 5:
              keyPair = _context73.v;
              return _context73.a(2, keyPair.code_challenge);
          }
        }, _callee73, this);
      }));
    }
  }, {
    key: "handlePKCEForAuthenticate",
    value: function handlePKCEForAuthenticate(pkceManager, data) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee74() {
        var pkPair, _yield$this$dfpProtec20, dfp_telemetry_id, captcha_token, requestBody, resp, _t12, _t13, _t14, _t15, _t16, _t17;
        return _regenerator().w(function (_context74) {
          while (1) switch (_context74.n) {
            case 0:
              _context74.n = 1;
              return pkceManager.getPKPair();
            case 1:
              pkPair = _context74.v;
              _context74.n = 2;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 2:
              _yield$this$dfpProtec20 = _context74.v;
              dfp_telemetry_id = _yield$this$dfpProtec20.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec20.captcha_token;
              _t12 = Object;
              _t13 = pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier;
              _t14 = dfp_telemetry_id;
              _t15 = captcha_token;
              _context74.n = 3;
              return this._subscriptionService.getIntermediateSessionToken();
            case 3:
              _t16 = _context74.v;
              if (_t16) {
                _context74.n = 4;
                break;
              }
              _t16 = undefined;
            case 4:
              _t17 = _t16;
              requestBody = _t12.assign.call(_t12, {
                pkce_code_verifier: _t13,
                dfp_telemetry_id: _t14,
                captcha_token: _t15,
                intermediate_session_token: _t17
              }, data);
              _context74.n = 5;
              return this._networkClient.retriableFetchSDK({
                url: '/b2b/magic_links/authenticate',
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 5:
              resp = _context74.v;
              pkceManager.clearPKPair();
              return _context74.a(2, resp);
          }
        }, _callee74, this);
      }));
    }
  }]);
}();
var HeadlessB2BSelfClient = /*#__PURE__*/_createClass(function HeadlessB2BSelfClient(_networkClient, _apiNetworkClient, _subscriptionService) {
  var _this20 = this;
  _classCallCheck(this, HeadlessB2BSelfClient);
  this._networkClient = _networkClient;
  this._apiNetworkClient = _apiNetworkClient;
  this._subscriptionService = _subscriptionService;
  this.get = function () {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee75() {
      var resp;
      return _regenerator().w(function (_context75) {
        while (1) switch (_context75.n) {
          case 0:
            _context75.n = 1;
            return this._networkClient.fetchSDK({
              url: "/b2b/organizations/members/me",
              method: 'GET'
            });
          case 1:
            resp = _context75.v;
            this._subscriptionService.updateMember(resp.member);
            return _context75.a(2, resp.member);
        }
      }, _callee75, this);
    }));
  };
  this.getSync = function () {
    return _this20._subscriptionService.getMember();
  };
  this.getInfo = function () {
    return {
      member: _this20.getSync(),
      fromCache: _this20._subscriptionService.getFromCache()
    };
  };
  this.onChange = function (callback) {
    return _this20._subscriptionService.subscribeToState(function (state) {
      var _a;
      return callback((_a = state === null || state === void 0 ? void 0 : state.member) !== null && _a !== void 0 ? _a : null);
    });
  };
  this.update = function (data) {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee76() {
      var resp;
      return _regenerator().w(function (_context76) {
        while (1) switch (_context76.n) {
          case 0:
            validate('stytch.self.update').isOptionalString('name', data.name).isOptionalObject('untrusted_metadata', data.untrusted_metadata).isOptionalBoolean('mfa_enrolled', data.mfa_enrolled).isOptionalString('mfa_phone_number', data.mfa_phone_number).isOptionalString('default_mfa_method', data.default_mfa_method);
            _context76.n = 1;
            return this._networkClient.fetchSDK({
              url: '/b2b/organizations/members/update',
              body: data,
              method: 'PUT'
            });
          case 1:
            resp = _context76.v;
            this._subscriptionService.updateMember(resp.member);
            return _context76.a(2, resp);
        }
      }, _callee76, this);
    }));
  };
  this.deleteMFAPhoneNumber = function () {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee77() {
      var resp;
      return _regenerator().w(function (_context77) {
        while (1) switch (_context77.n) {
          case 0:
            _context77.n = 1;
            return this._networkClient.fetchSDK({
              url: '/b2b/organizations/members/deletePhoneNumber',
              method: 'DELETE'
            });
          case 1:
            resp = _context77.v;
            this._subscriptionService.updateMember(resp.member);
            return _context77.a(2, resp);
        }
      }, _callee77, this);
    }));
  };
  this.deleteMFATOTP = function () {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee78() {
      var resp;
      return _regenerator().w(function (_context78) {
        while (1) switch (_context78.n) {
          case 0:
            _context78.n = 1;
            return this._networkClient.fetchSDK({
              url: "/b2b/organizations/members/deleteTOTP",
              method: 'DELETE'
            });
          case 1:
            resp = _context78.v;
            this._subscriptionService.updateMember(resp.member);
            return _context78.a(2, resp);
        }
      }, _callee78, this);
    }));
  };
  this.deletePassword = function (passwordId) {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee79() {
      var resp;
      return _regenerator().w(function (_context79) {
        while (1) switch (_context79.n) {
          case 0:
            _context79.n = 1;
            return this._networkClient.fetchSDK({
              url: "/b2b/organizations/members/passwords/".concat(passwordId),
              method: 'DELETE'
            });
          case 1:
            resp = _context79.v;
            this._subscriptionService.updateMember(resp.member);
            return _context79.a(2, resp);
        }
      }, _callee79, this);
    }));
  };
  this.unlinkRetiredEmail = function (data) {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee80() {
      var resp;
      return _regenerator().w(function (_context80) {
        while (1) switch (_context80.n) {
          case 0:
            _context80.n = 1;
            return this._apiNetworkClient.fetchSDK({
              url: '/b2b/organizations/members/unlink_retired_email',
              method: 'POST',
              body: data
            });
          case 1:
            resp = _context80.v;
            this._subscriptionService.updateMember(resp.member);
            return _context80.a(2, resp);
        }
      }, _callee80, this);
    }));
  };
  this.startEmailUpdate = function (data) {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee81() {
      var resp;
      return _regenerator().w(function (_context81) {
        while (1) switch (_context81.n) {
          case 0:
            _context81.n = 1;
            return this._apiNetworkClient.fetchSDK({
              url: '/b2b/organizations/members/start_email_update',
              method: 'POST',
              body: data
            });
          case 1:
            resp = _context81.v;
            this._subscriptionService.updateMember(resp.member);
            return _context81.a(2, resp);
        }
      }, _callee81, this);
    }));
  };
  this.getConnectedApps = function () {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee82() {
      return _regenerator().w(function (_context82) {
        while (1) switch (_context82.n) {
          case 0:
            return _context82.a(2, this._networkClient.fetchSDK({
              url: '/b2b/organizations/members/connected_apps',
              method: 'GET'
            }));
        }
      }, _callee82, this);
    }));
  };
  this.revokeConnectedApp = function (data) {
    return __awaiter(_this20, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee83() {
      return _regenerator().w(function (_context83) {
        while (1) switch (_context83.n) {
          case 0:
            return _context83.a(2, this._networkClient.fetchSDK({
              url: "/b2b/organizations/members/connected_apps/".concat(data.connected_app_id, "/revoke"),
              method: 'POST'
            }));
        }
      }, _callee83, this);
    }));
  };
});
var HeadlessB2BSSOClient = /*#__PURE__*/function () {
  function HeadlessB2BSSOClient(_networkClient, _subscriptionService, _pkceManager, _dynamicConfig, _config, dfpProtectedAuth) {
    var _this21 = this;
    _classCallCheck(this, HeadlessB2BSSOClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this._pkceManager = _pkceManager;
    this._dynamicConfig = _dynamicConfig;
    this._config = _config;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.authenticate = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee84() {
        var keyPair, _yield$this$dfpProtec21, dfp_telemetry_id, captcha_token, resp;
        return _regenerator().w(function (_context84) {
          while (1) switch (_context84.n) {
            case 0:
              validate('stytch.sso.authenticate').isString('sso_token', options.sso_token).isNumber('session_duration_minutes', options.session_duration_minutes).isOptionalString('locale', options.locale);
              _context84.n = 1;
              return this._pkceManager.getPKPair();
            case 1:
              keyPair = _context84.v;
              if (!keyPair) {
                logger.warn('No code verifier found in local storage for SSO flow.\n' + 'Consider using stytch.sso.start() to add PKCE to your SSO flows for added security.\n' + 'See https://stytch.com/docs/oauth#guides_pkce for more information.');
              }
              _context84.n = 2;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 2:
              _yield$this$dfpProtec21 = _context84.v;
              dfp_telemetry_id = _yield$this$dfpProtec21.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec21.captcha_token;
              _context84.n = 3;
              return this._networkClient.retriableFetchSDK({
                url: '/b2b/sso/authenticate',
                method: 'POST',
                body: Object.assign(Object.assign({
                  pkce_code_verifier: keyPair === null || keyPair === void 0 ? void 0 : keyPair.code_verifier
                }, options), {
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token,
                  intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined
                }),
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 3:
              resp = _context84.v;
              this._pkceManager.clearPKPair();
              return _context84.a(2, resp);
          }
        }, _callee84, this);
      }));
    });
    this.saml = {
      createConnection: function createConnection(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee85() {
          return _regenerator().w(function (_context85) {
            while (1) switch (_context85.n) {
              case 0:
                _context85.n = 1;
                return this._networkClient.fetchSDK({
                  url: '/b2b/sso/saml',
                  method: 'POST',
                  body: data
                });
              case 1:
                return _context85.a(2, _context85.v);
            }
          }, _callee85, this);
        }));
      },
      updateConnection: function updateConnection(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee86() {
          return _regenerator().w(function (_context86) {
            while (1) switch (_context86.n) {
              case 0:
                _context86.n = 1;
                return this._networkClient.fetchSDK({
                  url: "/b2b/sso/saml/".concat(data.connection_id),
                  method: 'PUT',
                  body: data
                });
              case 1:
                return _context86.a(2, _context86.v);
            }
          }, _callee86, this);
        }));
      },
      updateConnectionByURL: function updateConnectionByURL(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee87() {
          return _regenerator().w(function (_context87) {
            while (1) switch (_context87.n) {
              case 0:
                _context87.n = 1;
                return this._networkClient.fetchSDK({
                  url: "/b2b/sso/saml/".concat(data.connection_id, "/url"),
                  method: 'PUT',
                  body: data
                });
              case 1:
                return _context87.a(2, _context87.v);
            }
          }, _callee87, this);
        }));
      },
      deleteVerificationCertificate: function deleteVerificationCertificate(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee88() {
          return _regenerator().w(function (_context88) {
            while (1) switch (_context88.n) {
              case 0:
                _context88.n = 1;
                return this._networkClient.fetchSDK({
                  url: "/b2b/sso/saml/".concat(data.connection_id, "/verification_certificates/").concat(data.certificate_id),
                  method: 'DELETE'
                });
              case 1:
                return _context88.a(2, _context88.v);
            }
          }, _callee88, this);
        }));
      },
      deleteEncryptionPrivateKey: function deleteEncryptionPrivateKey(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee89() {
          return _regenerator().w(function (_context89) {
            while (1) switch (_context89.n) {
              case 0:
                _context89.n = 1;
                return this._networkClient.fetchSDK({
                  url: "/b2b/sso/saml/".concat(data.connection_id, "/encryption_private_key/").concat(data.private_key_id),
                  method: 'DELETE'
                });
              case 1:
                return _context89.a(2, _context89.v);
            }
          }, _callee89, this);
        }));
      }
    };
    this.oidc = {
      createConnection: function createConnection(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee90() {
          return _regenerator().w(function (_context90) {
            while (1) switch (_context90.n) {
              case 0:
                _context90.n = 1;
                return this._networkClient.fetchSDK({
                  url: '/b2b/sso/oidc',
                  method: 'POST',
                  body: data
                });
              case 1:
                return _context90.a(2, _context90.v);
            }
          }, _callee90, this);
        }));
      },
      updateConnection: function updateConnection(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee91() {
          return _regenerator().w(function (_context91) {
            while (1) switch (_context91.n) {
              case 0:
                _context91.n = 1;
                return this._networkClient.fetchSDK({
                  url: "/b2b/sso/oidc/".concat(data.connection_id),
                  method: 'PUT',
                  body: data
                });
              case 1:
                return _context91.a(2, _context91.v);
            }
          }, _callee91, this);
        }));
      }
    };
    this.external = {
      createConnection: function createConnection(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee92() {
          return _regenerator().w(function (_context92) {
            while (1) switch (_context92.n) {
              case 0:
                _context92.n = 1;
                return this._networkClient.fetchSDK({
                  url: '/b2b/sso/external',
                  method: 'POST',
                  body: data
                });
              case 1:
                return _context92.a(2, _context92.v);
            }
          }, _callee92, this);
        }));
      },
      updateConnection: function updateConnection(data) {
        return __awaiter(_this21, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee93() {
          return _regenerator().w(function (_context93) {
            while (1) switch (_context93.n) {
              case 0:
                _context93.n = 1;
                return this._networkClient.fetchSDK({
                  url: "/b2b/sso/external/".concat(data.connection_id),
                  method: 'PUT',
                  body: data
                });
              case 1:
                return _context93.a(2, _context93.v);
            }
          }, _callee93, this);
        }));
      }
    };
  }
  return _createClass(HeadlessB2BSSOClient, [{
    key: "getBaseApiUrl",
    value: function getBaseApiUrl() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee94() {
        return _regenerator().w(function (_context94) {
          while (1) switch (_context94.n) {
            case 0:
              if (!isTestPublicToken(this._config.publicToken)) {
                _context94.n = 1;
                break;
              }
              return _context94.a(2, this._config.testAPIURL);
            case 1:
              return _context94.a(2, this._config.liveAPIURL);
          }
        }, _callee94, this);
      }));
    }
  }, {
    key: "start",
    value: function start(_ref7) {
      var connection_id = _ref7.connection_id,
        login_redirect_url = _ref7.login_redirect_url,
        signup_redirect_url = _ref7.signup_redirect_url;
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee95() {
        var _yield$this$_dynamicC3, pkceRequiredForSso, baseURL, startUrl, keyPair;
        return _regenerator().w(function (_context95) {
          while (1) switch (_context95.n) {
            case 0:
              _context95.n = 1;
              return this._dynamicConfig;
            case 1:
              _yield$this$_dynamicC3 = _context95.v;
              pkceRequiredForSso = _yield$this$_dynamicC3.pkceRequiredForSso;
              _context95.n = 2;
              return this.getBaseApiUrl();
            case 2:
              baseURL = _context95.v;
              startUrl = new URL("".concat(baseURL, "/v1/public/sso/start"));
              startUrl.searchParams.set('public_token', this._config.publicToken);
              startUrl.searchParams.set('connection_id', connection_id);
              if (!pkceRequiredForSso) {
                _context95.n = 4;
                break;
              }
              _context95.n = 3;
              return this._pkceManager.startPKCETransaction();
            case 3:
              keyPair = _context95.v;
              startUrl.searchParams.set('pkce_code_challenge', keyPair.code_challenge);
              _context95.n = 5;
              break;
            case 4:
              this._pkceManager.clearPKPair();
            case 5:
              if (login_redirect_url) startUrl.searchParams.set('login_redirect_url', login_redirect_url);
              if (signup_redirect_url) startUrl.searchParams.set('signup_redirect_url', signup_redirect_url);
              window.location.href = startUrl.toString();
            case 6:
              return _context95.a(2);
          }
        }, _callee95, this);
      }));
    }
  }, {
    key: "getConnections",
    value: function getConnections() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee96() {
        return _regenerator().w(function (_context96) {
          while (1) switch (_context96.n) {
            case 0:
              _context96.n = 1;
              return this._networkClient.fetchSDK({
                url: '/b2b/sso',
                method: 'GET'
              });
            case 1:
              return _context96.a(2, _context96.v);
          }
        }, _callee96, this);
      }));
    }
  }, {
    key: "discoverConnections",
    value: function discoverConnections(emailAddress) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee97() {
        return _regenerator().w(function (_context97) {
          while (1) switch (_context97.n) {
            case 0:
              _context97.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/sso/discovery/connections?email_address=".concat(encodeURIComponent(emailAddress)),
                method: 'GET'
              });
            case 1:
              return _context97.a(2, _context97.v);
          }
        }, _callee97, this);
      }));
    }
  }, {
    key: "deleteConnection",
    value: function deleteConnection(connectionId) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee98() {
        return _regenerator().w(function (_context98) {
          while (1) switch (_context98.n) {
            case 0:
              return _context98.a(2, this._networkClient.fetchSDK({
                url: "/b2b/sso/".concat(connectionId),
                method: 'DELETE'
              }));
          }
        }, _callee98, this);
      }));
    }
  }]);
}();
var HeadlessB2BSCIMClient = /*#__PURE__*/function () {
  function HeadlessB2BSCIMClient(_networkClient, _subscriptionService) {
    _classCallCheck(this, HeadlessB2BSCIMClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
  }
  return _createClass(HeadlessB2BSCIMClient, [{
    key: "createConnection",
    value: function createConnection(data) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee99() {
        return _regenerator().w(function (_context99) {
          while (1) switch (_context99.n) {
            case 0:
              validate('stytch.scim.createConnection').isOptionalString('display_name', data.display_name).isOptionalString('identity_provider', data.identity_provider);
              _context99.n = 1;
              return this._networkClient.fetchSDK({
                url: '/b2b/scim',
                method: 'POST',
                body: data
              });
            case 1:
              return _context99.a(2, _context99.v);
          }
        }, _callee99, this);
      }));
    }
  }, {
    key: "updateConnection",
    value: function updateConnection(data) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee100() {
        return _regenerator().w(function (_context100) {
          while (1) switch (_context100.n) {
            case 0:
              validate('stytch.scim.updateConnection').isString('connection_id', data.connection_id).isOptionalString('display_name', data.display_name).isOptionalString('identity_provider', data.identity_provider);
              _context100.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/scim/".concat(data.connection_id),
                method: 'PUT',
                body: data
              });
            case 1:
              return _context100.a(2, _context100.v);
          }
        }, _callee100, this);
      }));
    }
  }, {
    key: "deleteConnection",
    value: function deleteConnection(connectionId) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee101() {
        return _regenerator().w(function (_context101) {
          while (1) switch (_context101.n) {
            case 0:
              validate('stytch.scim.deleteConnection').isString('connection_id', connectionId);
              _context101.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/scim/".concat(connectionId),
                method: 'DELETE'
              });
            case 1:
              return _context101.a(2, _context101.v);
          }
        }, _callee101, this);
      }));
    }
  }, {
    key: "getConnection",
    value: function getConnection() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee102() {
        return _regenerator().w(function (_context102) {
          while (1) switch (_context102.n) {
            case 0:
              _context102.n = 1;
              return this._networkClient.fetchSDK({
                url: '/b2b/scim',
                method: 'GET'
              });
            case 1:
              return _context102.a(2, _context102.v);
          }
        }, _callee102, this);
      }));
    }
  }, {
    key: "getConnectionGroups",
    value: function getConnectionGroups(data) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee103() {
        return _regenerator().w(function (_context103) {
          while (1) switch (_context103.n) {
            case 0:
              validate('stytch.scim.getConnectionGroups').isOptionalNumber('limit', data.limit).isOptionalString('cursor', data.cursor);
              _context103.n = 1;
              return this._networkClient.fetchSDK({
                url: '/b2b/scim/groups',
                method: 'POST',
                body: data
              });
            case 1:
              return _context103.a(2, _context103.v);
          }
        }, _callee103, this);
      }));
    }
  }, {
    key: "rotateStart",
    value: function rotateStart(connectionId) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee104() {
        return _regenerator().w(function (_context104) {
          while (1) switch (_context104.n) {
            case 0:
              validate('stytch.scim.rotateStart').isString('connectionId', connectionId);
              _context104.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/scim/rotate/start",
                method: 'POST',
                body: {
                  connection_id: connectionId
                }
              });
            case 1:
              return _context104.a(2, _context104.v);
          }
        }, _callee104, this);
      }));
    }
  }, {
    key: "rotateComplete",
    value: function rotateComplete(connectionId) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee105() {
        return _regenerator().w(function (_context105) {
          while (1) switch (_context105.n) {
            case 0:
              validate('stytch.scim.rotateComplete').isString('connectionId', connectionId);
              _context105.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/scim/rotate/complete",
                method: 'POST',
                body: {
                  connection_id: connectionId
                }
              });
            case 1:
              return _context105.a(2, _context105.v);
          }
        }, _callee105, this);
      }));
    }
  }, {
    key: "rotateCancel",
    value: function rotateCancel(connectionId) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee106() {
        return _regenerator().w(function (_context106) {
          while (1) switch (_context106.n) {
            case 0:
              validate('stytch.scim.rotateCancel').isString('connectionId', connectionId);
              _context106.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/scim/rotate/cancel",
                method: 'POST',
                body: {
                  connection_id: connectionId
                }
              });
            case 1:
              return _context106.a(2, _context106.v);
          }
        }, _callee106, this);
      }));
    }
  }]);
}();
var HeadlessB2BOrganizationClient = /*#__PURE__*/_createClass(function HeadlessB2BOrganizationClient(_networkClient, _apiNetworkClient, _subscriptionService) {
  var _this22 = this;
  _classCallCheck(this, HeadlessB2BOrganizationClient);
  this._networkClient = _networkClient;
  this._apiNetworkClient = _apiNetworkClient;
  this._subscriptionService = _subscriptionService;
  this.get = function () {
    return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee107() {
      var resp;
      return _regenerator().w(function (_context107) {
        while (1) switch (_context107.n) {
          case 0:
            _context107.n = 1;
            return this._networkClient.fetchSDK({
              url: "/b2b/organizations/me",
              method: 'GET'
            });
          case 1:
            resp = _context107.v;
            this._subscriptionService.updateOrganization(resp.organization);
            return _context107.a(2, resp.organization);
        }
      }, _callee107, this);
    }));
  };
  this.getSync = function () {
    return _this22._subscriptionService.getOrganization();
  };
  this.getInfo = function () {
    return {
      organization: _this22.getSync(),
      fromCache: _this22._subscriptionService.getFromCache()
    };
  };
  this.onChange = function (callback) {
    return _this22._subscriptionService.subscribeToState(function (state) {
      var _a;
      return callback((_a = state === null || state === void 0 ? void 0 : state.organization) !== null && _a !== void 0 ? _a : null);
    });
  };
  this.update = function (data) {
    return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee108() {
      var resp;
      return _regenerator().w(function (_context108) {
        while (1) switch (_context108.n) {
          case 0:
            _context108.n = 1;
            return this._networkClient.fetchSDK({
              url: "/b2b/organizations/me",
              method: 'PUT',
              body: data
            });
          case 1:
            resp = _context108.v;
            this._subscriptionService.updateOrganization(resp.organization);
            return _context108.a(2, resp);
        }
      }, _callee108, this);
    }));
  };
  this["delete"] = function () {
    return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee109() {
      var resp;
      return _regenerator().w(function (_context109) {
        while (1) switch (_context109.n) {
          case 0:
            _context109.n = 1;
            return this._networkClient.fetchSDK({
              url: "/b2b/organizations/me",
              method: 'DELETE'
            });
          case 1:
            resp = _context109.v;
            this._subscriptionService.destroyState();
            return _context109.a(2, resp);
        }
      }, _callee109, this);
    }));
  };
  this.getBySlug = function (data) {
    return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee110() {
      return _regenerator().w(function (_context110) {
        while (1) switch (_context110.n) {
          case 0:
            validate('stytch.organization.getBySlug').isString('organization_slug', data.organization_slug);
            return _context110.a(2, this._networkClient.fetchSDK({
              url: "/b2b/organizations/search",
              method: 'POST',
              body: data
            }));
        }
      }, _callee110, this);
    }));
  };
  this.getConnectedApps = function () {
    return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee111() {
      return _regenerator().w(function (_context111) {
        while (1) switch (_context111.n) {
          case 0:
            return _context111.a(2, this._networkClient.fetchSDK({
              url: '/b2b/organizations/connected_apps',
              method: 'GET'
            }));
        }
      }, _callee111, this);
    }));
  };
  this.getConnectedApp = function (data) {
    return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee112() {
      return _regenerator().w(function (_context112) {
        while (1) switch (_context112.n) {
          case 0:
            return _context112.a(2, this._networkClient.fetchSDK({
              url: "/b2b/organizations/connected_apps/".concat(data.connected_app_id),
              method: 'GET'
            }));
        }
      }, _callee112, this);
    }));
  };
  this.members = {
    create: function create(data) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee113() {
        return _regenerator().w(function (_context113) {
          while (1) switch (_context113.n) {
            case 0:
              return _context113.a(2, this._networkClient.fetchSDK({
                url: "/b2b/organizations/members",
                method: 'POST',
                body: data
              }));
          }
        }, _callee113, this);
      }));
    },
    search: function search(data) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee114() {
        return _regenerator().w(function (_context114) {
          while (1) switch (_context114.n) {
            case 0:
              return _context114.a(2, this._networkClient.fetchSDK({
                url: "/b2b/organizations/me/members/search",
                method: 'POST',
                body: data
              }));
          }
        }, _callee114, this);
      }));
    },
    update: function update(data) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee115() {
        var response;
        return _regenerator().w(function (_context115) {
          while (1) switch (_context115.n) {
            case 0:
              _context115.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/organizations/members/".concat(data.member_id),
                method: 'PUT',
                body: data
              });
            case 1:
              response = _context115.v;
              this.updateMemberIfSelf(response);
              return _context115.a(2, response);
          }
        }, _callee115, this);
      }));
    },
    deletePassword: function deletePassword(passwordId) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee116() {
        var response;
        return _regenerator().w(function (_context116) {
          while (1) switch (_context116.n) {
            case 0:
              _context116.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/organizations/members/passwords/".concat(passwordId),
                method: 'DELETE'
              });
            case 1:
              response = _context116.v;
              this.updateMemberIfSelf(response);
              return _context116.a(2, response);
          }
        }, _callee116, this);
      }));
    },
    deleteMFAPhoneNumber: function deleteMFAPhoneNumber(memberId) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee117() {
        var response;
        return _regenerator().w(function (_context117) {
          while (1) switch (_context117.n) {
            case 0:
              _context117.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/organizations/members/mfa_phone_numbers/".concat(memberId),
                method: 'DELETE'
              });
            case 1:
              response = _context117.v;
              this.updateMemberIfSelf(response);
              return _context117.a(2, response);
          }
        }, _callee117, this);
      }));
    },
    deleteMFATOTP: function deleteMFATOTP(memberId) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee118() {
        var response;
        return _regenerator().w(function (_context118) {
          while (1) switch (_context118.n) {
            case 0:
              _context118.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/organizations/members/totp/".concat(memberId),
                method: 'DELETE'
              });
            case 1:
              response = _context118.v;
              this.updateMemberIfSelf(response);
              return _context118.a(2, response);
          }
        }, _callee118, this);
      }));
    },
    "delete": function _delete(memberId) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee119() {
        var _a, response;
        return _regenerator().w(function (_context119) {
          while (1) switch (_context119.n) {
            case 0:
              _context119.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/organizations/members/".concat(memberId),
                method: 'DELETE'
              });
            case 1:
              response = _context119.v;
              if (memberId === ((_a = this._subscriptionService.getMember()) === null || _a === void 0 ? void 0 : _a.member_id)) {
                this._subscriptionService.destroyState();
              }
              return _context119.a(2, response);
          }
        }, _callee119, this);
      }));
    },
    reactivate: function reactivate(memberId) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee120() {
        return _regenerator().w(function (_context120) {
          while (1) switch (_context120.n) {
            case 0:
              return _context120.a(2, this._networkClient.fetchSDK({
                url: "/b2b/organizations/members/".concat(memberId, "/reactivate"),
                method: 'PUT'
              }));
          }
        }, _callee120, this);
      }));
    },
    unlinkRetiredEmail: function unlinkRetiredEmail(data) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee121() {
        var member_id, body, response;
        return _regenerator().w(function (_context121) {
          while (1) switch (_context121.n) {
            case 0:
              member_id = data.member_id, body = __rest(data, ["member_id"]);
              _context121.n = 1;
              return this._apiNetworkClient.fetchSDK({
                url: "/b2b/organizations/members/".concat(member_id, "/unlink_retired_email"),
                method: 'POST',
                body: body
              });
            case 1:
              response = _context121.v;
              this.updateMemberIfSelf(response);
              return _context121.a(2, response);
          }
        }, _callee121, this);
      }));
    },
    startEmailUpdate: function startEmailUpdate(data) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee122() {
        var member_id, body, response;
        return _regenerator().w(function (_context122) {
          while (1) switch (_context122.n) {
            case 0:
              member_id = data.member_id, body = __rest(data, ["member_id"]);
              _context122.n = 1;
              return this._apiNetworkClient.fetchSDK({
                url: "/b2b/organizations/members/".concat(member_id, "/start_email_update"),
                method: 'POST',
                body: body
              });
            case 1:
              response = _context122.v;
              this.updateMemberIfSelf(response);
              return _context122.a(2, response);
          }
        }, _callee122, this);
      }));
    },
    getConnectedApps: function getConnectedApps(data) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee123() {
        return _regenerator().w(function (_context123) {
          while (1) switch (_context123.n) {
            case 0:
              return _context123.a(2, this._networkClient.fetchSDK({
                url: "b2b/organizations/members/".concat(data.member_id, "/connected_apps"),
                method: 'GET'
              }));
          }
        }, _callee123, this);
      }));
    },
    revokeConnectedApp: function revokeConnectedApp(data) {
      return __awaiter(_this22, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee124() {
        return _regenerator().w(function (_context124) {
          while (1) switch (_context124.n) {
            case 0:
              return _context124.a(2, this._networkClient.fetchSDK({
                url: "/b2b/organizations/members/".concat(data.member_id, "/connected_apps/").concat(data.connected_app_id, "/revoke"),
                method: 'POST'
              }));
          }
        }, _callee124, this);
      }));
    }
  };
  this.updateMemberIfSelf = function (response) {
    var _a;
    if (response.member_id === ((_a = _this22._subscriptionService.getMember()) === null || _a === void 0 ? void 0 : _a.member_id)) {
      _this22._subscriptionService.updateMember(response.member);
    }
  };
});
var HeadlessB2BOAuthClient = /*#__PURE__*/function () {
  function HeadlessB2BOAuthClient(_networkClient, _subscriptionService, _pkceManager, _dynamicConfig, _config, dfpProtectedAuth) {
    var _this23 = this;
    _classCallCheck(this, HeadlessB2BOAuthClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this._pkceManager = _pkceManager;
    this._dynamicConfig = _dynamicConfig;
    this._config = _config;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.authenticate = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this23, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee125() {
        var keyPair, _yield$this$dfpProtec22, dfp_telemetry_id, captcha_token, resp, _t18, _t19, _t20, _t21, _t22, _t23, _t24, _t25, _t26;
        return _regenerator().w(function (_context125) {
          while (1) switch (_context125.n) {
            case 0:
              validate('stytch.oauth.authenticate').isString('oauth_token', options.oauth_token).isNumber('session_duration_minutes', options.session_duration_minutes).isOptionalString('locale', options.locale);
              _context125.n = 1;
              return this._pkceManager.getPKPair();
            case 1:
              keyPair = _context125.v;
              if (!keyPair) {
                logger.warn('No code verifier found in local storage for OAuth flow.\n' + 'Consider using stytch.oauth.$provider.start() to add PKCE to your OAuth flows for added security.\n' + 'See https://stytch.com/docs/oauth#guides_pkce for more information.');
              }
              _context125.n = 2;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 2:
              _yield$this$dfpProtec22 = _context125.v;
              dfp_telemetry_id = _yield$this$dfpProtec22.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec22.captcha_token;
              _t18 = this._networkClient;
              _t19 = Object;
              _t20 = keyPair === null || keyPair === void 0 ? void 0 : keyPair.code_verifier;
              _t21 = dfp_telemetry_id;
              _t22 = captcha_token;
              _context125.n = 3;
              return this._subscriptionService.getIntermediateSessionToken();
            case 3:
              _t23 = _context125.v;
              if (_t23) {
                _context125.n = 4;
                break;
              }
              _t23 = undefined;
            case 4:
              _t24 = _t23;
              _t25 = _t19.assign.call(_t19, {
                pkce_code_verifier: _t20,
                dfp_telemetry_id: _t21,
                captcha_token: _t22,
                intermediate_session_token: _t24
              }, options);
              _t26 = this.dfpProtectedAuth.retryWithCaptchaAndDFP;
              _context125.n = 5;
              return _t18.retriableFetchSDK.call(_t18, {
                url: '/b2b/oauth/authenticate',
                method: 'POST',
                body: _t25,
                retryCallback: _t26
              });
            case 5:
              resp = _context125.v;
              this._pkceManager.clearPKPair();
              return _context125.a(2, resp);
          }
        }, _callee125, this);
      }));
    });
    this.discovery = {
      authenticate: this._subscriptionService.withUpdateSession(function (data) {
        return __awaiter(_this23, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee126() {
          var pkPair, _yield$this$dfpProtec23, dfp_telemetry_id, captcha_token, requestBody, resp;
          return _regenerator().w(function (_context126) {
            while (1) switch (_context126.n) {
              case 0:
                validate('stytch.oauth.discovery.authenticate').isString('discovery_oauth_token', data.discovery_oauth_token);
                _context126.n = 1;
                return this._pkceManager.getPKPair();
              case 1:
                pkPair = _context126.v;
                _context126.n = 2;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 2:
                _yield$this$dfpProtec23 = _context126.v;
                dfp_telemetry_id = _yield$this$dfpProtec23.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec23.captcha_token;
                requestBody = Object.assign({
                  pkce_code_verifier: pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier,
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                }, data);
                _context126.n = 3;
                return this._networkClient.retriableFetchSDK({
                  url: '/b2b/oauth/discovery/authenticate',
                  body: requestBody,
                  method: 'POST',
                  retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                });
              case 3:
                resp = _context126.v;
                this._pkceManager.clearPKPair();
                return _context126.a(2, resp);
            }
          }, _callee126, this);
        }));
      })
    };
    this.google = {
      start: this.startOAuthFlow(B2BOAuthProviders.Google),
      discovery: {
        start: this.startDiscoveryOAuthFlow(B2BOAuthProviders.Google)
      }
    };
    this.microsoft = {
      start: this.startOAuthFlow(B2BOAuthProviders.Microsoft),
      discovery: {
        start: this.startDiscoveryOAuthFlow(B2BOAuthProviders.Microsoft)
      }
    };
    this.hubspot = {
      start: this.startOAuthFlow(B2BOAuthProviders.HubSpot),
      discovery: {
        start: this.startDiscoveryOAuthFlow(B2BOAuthProviders.HubSpot)
      }
    };
    this.slack = {
      start: this.startOAuthFlow(B2BOAuthProviders.Slack),
      discovery: {
        start: this.startDiscoveryOAuthFlow(B2BOAuthProviders.Slack)
      }
    };
    this.github = {
      start: this.startOAuthFlow(B2BOAuthProviders.GitHub),
      discovery: {
        start: this.startDiscoveryOAuthFlow(B2BOAuthProviders.GitHub)
      }
    };
  }
  return _createClass(HeadlessB2BOAuthClient, [{
    key: "getBaseApiUrl",
    value: function getBaseApiUrl() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee127() {
        var _yield$this$_dynamicC4, cnameDomain;
        return _regenerator().w(function (_context127) {
          while (1) switch (_context127.n) {
            case 0:
              _context127.n = 1;
              return this._dynamicConfig;
            case 1:
              _yield$this$_dynamicC4 = _context127.v;
              cnameDomain = _yield$this$_dynamicC4.cnameDomain;
              if (!cnameDomain) {
                _context127.n = 2;
                break;
              }
              return _context127.a(2, "https://".concat(cnameDomain));
            case 2:
              if (!isTestPublicToken(this._config.publicToken)) {
                _context127.n = 3;
                break;
              }
              return _context127.a(2, this._config.testAPIURL);
            case 3:
              return _context127.a(2, this._config.liveAPIURL);
          }
        }, _callee127, this);
      }));
    }
  }, {
    key: "startOAuthFlow",
    value: function startOAuthFlow(providerType) {
      var _this24 = this;
      return function (_ref8) {
        var organization_id = _ref8.organization_id,
          organization_slug = _ref8.organization_slug,
          login_redirect_url = _ref8.login_redirect_url,
          signup_redirect_url = _ref8.signup_redirect_url,
          custom_scopes = _ref8.custom_scopes,
          provider_params = _ref8.provider_params;
        return __awaiter(_this24, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee128() {
          var _yield$this$_dynamicC5, pkceRequiredForOAuth, baseURL, startUrl, key, keyPair;
          return _regenerator().w(function (_context128) {
            while (1) switch (_context128.n) {
              case 0:
                _context128.n = 1;
                return this._dynamicConfig;
              case 1:
                _yield$this$_dynamicC5 = _context128.v;
                pkceRequiredForOAuth = _yield$this$_dynamicC5.pkceRequiredForOAuth;
                _context128.n = 2;
                return this.getBaseApiUrl();
              case 2:
                baseURL = _context128.v;
                startUrl = new URL("".concat(baseURL, "/v1/b2b/public/oauth/").concat(providerType, "/start"));
                startUrl.searchParams.set('public_token', this._config.publicToken);
                if (organization_id && organization_id != '') {
                  startUrl.searchParams.set('organization_id', organization_id);
                }
                if (organization_slug && organization_slug != '') {
                  startUrl.searchParams.set('slug', organization_slug);
                }
                if (custom_scopes) {
                  validate('startOAuthFlow').isStringArray('custom_scopes', custom_scopes);
                  startUrl.searchParams.set('custom_scopes', custom_scopes.join(' '));
                }
                if (provider_params) {
                  validate('startOAuthFlow').isOptionalObject('provider_params', provider_params);
                  for (key in provider_params) {
                    startUrl.searchParams.set('provider_' + key, provider_params[key]);
                  }
                }
                if (!pkceRequiredForOAuth) {
                  _context128.n = 4;
                  break;
                }
                _context128.n = 3;
                return this._pkceManager.startPKCETransaction();
              case 3:
                keyPair = _context128.v;
                startUrl.searchParams.set('pkce_code_challenge', keyPair.code_challenge);
                _context128.n = 5;
                break;
              case 4:
                this._pkceManager.clearPKPair();
              case 5:
                if (login_redirect_url) startUrl.searchParams.set('login_redirect_url', login_redirect_url);
                if (signup_redirect_url) startUrl.searchParams.set('signup_redirect_url', signup_redirect_url);
                window.location.href = startUrl.toString();
              case 6:
                return _context128.a(2);
            }
          }, _callee128, this);
        }));
      };
    }
  }, {
    key: "startDiscoveryOAuthFlow",
    value: function startDiscoveryOAuthFlow(providerType) {
      var _this25 = this;
      return function (_ref9) {
        var discovery_redirect_url = _ref9.discovery_redirect_url,
          custom_scopes = _ref9.custom_scopes,
          provider_params = _ref9.provider_params;
        return __awaiter(_this25, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee129() {
          var _yield$this$_dynamicC6, pkceRequiredForOAuth, baseURL, startUrl, key, keyPair;
          return _regenerator().w(function (_context129) {
            while (1) switch (_context129.n) {
              case 0:
                _context129.n = 1;
                return this._dynamicConfig;
              case 1:
                _yield$this$_dynamicC6 = _context129.v;
                pkceRequiredForOAuth = _yield$this$_dynamicC6.pkceRequiredForOAuth;
                _context129.n = 2;
                return this.getBaseApiUrl();
              case 2:
                baseURL = _context129.v;
                startUrl = new URL("".concat(baseURL, "/v1/b2b/public/oauth/").concat(providerType, "/discovery/start"));
                startUrl.searchParams.set('public_token', this._config.publicToken);
                if (custom_scopes) {
                  validate('startOAuthFlow').isStringArray('custom_scopes', custom_scopes);
                  startUrl.searchParams.set('custom_scopes', custom_scopes.join(' '));
                }
                if (provider_params) {
                  validate('startOAuthFlow').isOptionalObject('provider_params', provider_params);
                  for (key in provider_params) {
                    startUrl.searchParams.set('provider_' + key, provider_params[key]);
                  }
                }
                if (!pkceRequiredForOAuth) {
                  _context129.n = 4;
                  break;
                }
                _context129.n = 3;
                return this._pkceManager.startPKCETransaction();
              case 3:
                keyPair = _context129.v;
                startUrl.searchParams.set('pkce_code_challenge', keyPair.code_challenge);
                _context129.n = 5;
                break;
              case 4:
                this._pkceManager.clearPKPair();
              case 5:
                if (discovery_redirect_url) {
                  startUrl.searchParams.set('discovery_redirect_url', discovery_redirect_url);
                }
                window.location.href = startUrl.toString();
              case 6:
                return _context129.a(2);
            }
          }, _callee129, this);
        }));
      };
    }
  }]);
}();
var HeadlessB2BSessionClient = /*#__PURE__*/function () {
  function HeadlessB2BSessionClient(_networkClient, _subscriptionService) {
    var _this26 = this;
    _classCallCheck(this, HeadlessB2BSessionClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this.getSync = function () {
      return _this26._subscriptionService.getSession();
    };
    this.getInfo = function () {
      return {
        session: _this26.getSync(),
        fromCache: _this26._subscriptionService.getFromCache()
      };
    };
    this.onChange = function (callback) {
      return _this26._subscriptionService.subscribeToState(function (state) {
        var _a;
        return callback((_a = state === null || state === void 0 ? void 0 : state.session) !== null && _a !== void 0 ? _a : null);
      });
    };
    this.revoke = function (options) {
      return __awaiter(_this26, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee130() {
        var resp, _t27;
        return _regenerator().w(function (_context130) {
          while (1) switch (_context130.p = _context130.n) {
            case 0:
              _context130.p = 0;
              _context130.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/sessions/revoke",
                method: 'POST'
              });
            case 1:
              resp = _context130.v;
              this._subscriptionService.destroyState();
              return _context130.a(2, resp);
            case 2:
              _context130.p = 2;
              _t27 = _context130.v;
              if (options === null || options === void 0 ? void 0 : options.forceClear) {
                this._subscriptionService.destroyState();
              } else if (UNRECOVERABLE_ERROR_TYPES.includes(_t27.error_type)) {
                this._subscriptionService.destroyState();
              }
              throw _t27;
            case 3:
              return _context130.a(2);
          }
        }, _callee130, this, [[0, 2]]);
      }));
    };
    this.revokeForMember = function (options) {
      return __awaiter(_this26, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee131() {
        return _regenerator().w(function (_context131) {
          while (1) switch (_context131.n) {
            case 0:
              validate('stytch.session.revokeForMember').isString('member_id', options.member_id);
              _context131.n = 1;
              return this._networkClient.fetchSDK({
                url: "/b2b/sessions/revoke/".concat(options.member_id),
                method: 'POST'
              });
            case 1:
              return _context131.a(2, _context131.v);
          }
        }, _callee131, this);
      }));
    };
    this._authenticate = function (options) {
      return __awaiter(_this26, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee132() {
        var _this27 = this;
        var initialSession, isSessionStale, requestBody, resp, _t28;
        return _regenerator().w(function (_context132) {
          while (1) switch (_context132.p = _context132.n) {
            case 0:
              initialSession = this._subscriptionService.getSession();
              isSessionStale = function isSessionStale() {
                var _a;
                return (initialSession === null || initialSession === void 0 ? void 0 : initialSession.member_session_id) !== ((_a = _this27._subscriptionService.getSession()) === null || _a === void 0 ? void 0 : _a.member_session_id);
              };
              _context132.p = 1;
              requestBody = {
                session_duration_minutes: options === null || options === void 0 ? void 0 : options.session_duration_minutes
              };
              _context132.n = 2;
              return this._networkClient.fetchSDK({
                url: '/b2b/sessions/authenticate',
                body: requestBody,
                method: 'POST'
              });
            case 2:
              resp = _context132.v;
              if (!isSessionStale()) {
                _context132.n = 3;
                break;
              }
              return _context132.a(2, this._authenticate(options));
            case 3:
              return _context132.a(2, resp);
            case 4:
              _context132.p = 4;
              _t28 = _context132.v;
              if (!isSessionStale()) {
                _context132.n = 5;
                break;
              }
              return _context132.a(2, this._authenticate(options));
            case 5:
              if (UNRECOVERABLE_ERROR_TYPES.includes(_t28.error_type)) {
                this._subscriptionService.destroySession();
              }
              throw _t28;
            case 6:
              return _context132.a(2);
          }
        }, _callee132, this, [[1, 4]]);
      }));
    };
    this.authenticate = this._subscriptionService.withUpdateSession(this._authenticate);
    this.exchange = this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this26, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee133() {
        return _regenerator().w(function (_context133) {
          while (1) switch (_context133.n) {
            case 0:
              validate('stytch.session.exchange').isString('organization_id', data.organization_id).isNumber('session_duration_minutes', data.session_duration_minutes).isOptionalString('locale', data.locale);
              return _context133.a(2, this._networkClient.fetchSDK({
                url: '/b2b/sessions/exchange',
                body: data,
                method: 'POST'
              }));
          }
        }, _callee133, this);
      }));
    });
    this.exchangeAccessToken = this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this26, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee134() {
        return _regenerator().w(function (_context134) {
          while (1) switch (_context134.n) {
            case 0:
              validate('stytch.session.exchange').isString('organization_id', data.access_token).isNumber('session_duration_minutes', data.session_duration_minutes);
              return _context134.a(2, this._networkClient.fetchSDK({
                url: '/b2b/sessions/exchange_access_token',
                body: data,
                method: 'POST'
              }));
          }
        }, _callee134, this);
      }));
    });
    this.attest = this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this26, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee135() {
        return _regenerator().w(function (_context135) {
          while (1) switch (_context135.n) {
            case 0:
              validate('stytch.session.attest').isOptionalString('organization_id', data.organization_id).isString('profile_id', data.profile_id).isString('token', data.token).isOptionalNumber('session_duration_minutes', data.session_duration_minutes);
              return _context135.a(2, this._networkClient.fetchSDK({
                url: '/b2b/sessions/attest',
                body: data,
                method: 'POST'
              }));
          }
        }, _callee135, this);
      }));
    });
  }
  return _createClass(HeadlessB2BSessionClient, [{
    key: "getTokens",
    value: function getTokens() {
      return this._subscriptionService.getTokens();
    }
  }, {
    key: "updateSession",
    value: function updateSession(tokens) {
      var _a;
      validate('stytch.session.updateSession').isString('session_token', tokens.session_token).isOptionalString('session_jwt', (_a = tokens.session_jwt) !== null && _a !== void 0 ? _a : undefined);
      this._subscriptionService.updateTokens(tokens);
    }
  }]);
}();
var HeadlessB2BDiscoveryClient = /*#__PURE__*/_createClass(function HeadlessB2BDiscoveryClient(_networkClient, _subscriptionService) {
  var _this28 = this;
  _classCallCheck(this, HeadlessB2BDiscoveryClient);
  this._networkClient = _networkClient;
  this._subscriptionService = _subscriptionService;
  this.organizations = {
    list: function list() {
      return __awaiter(_this28, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee136() {
        var _t29, _t30, _t31, _t32;
        return _regenerator().w(function (_context136) {
          while (1) switch (_context136.n) {
            case 0:
              _t29 = this._networkClient;
              _context136.n = 1;
              return this._subscriptionService.getIntermediateSessionToken();
            case 1:
              _t30 = _context136.v;
              if (_t30) {
                _context136.n = 2;
                break;
              }
              _t30 = undefined;
            case 2:
              _t31 = _t30;
              _t32 = {
                intermediate_session_token: _t31
              };
              return _context136.a(2, _t29.fetchSDK.call(_t29, {
                url: '/b2b/discovery/organizations',
                body: _t32,
                method: 'POST'
              }));
          }
        }, _callee136, this);
      }));
    },
    create: this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this28, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee137() {
        var requestBody, _t33, _t34, _t35, _t36;
        return _regenerator().w(function (_context137) {
          while (1) switch (_context137.n) {
            case 0:
              validate('stytch.discovery.organizations.create').isNumber('session_duration_minutes', data.session_duration_minutes).isOptionalString('organization_name', data.organization_name).isOptionalString('organization_slug', data.organization_slug).isOptionalString('organization_logo_url', data.organization_logo_url).isOptionalString('sso_jit_provisioning', data.sso_jit_provisioning).isOptionalStringArray('email_allowed_domains', data.email_allowed_domains).isOptionalString('email_invites', data.email_invites).isOptionalString('auth_methods', data.auth_methods).isOptionalStringArray('allowed_auth_methods', data.allowed_auth_methods).isOptionalString('mfa_policy', data.mfa_policy);
              _t33 = Object;
              _t34 = Object.assign({}, data);
              _context137.n = 1;
              return this._subscriptionService.getIntermediateSessionToken();
            case 1:
              _t35 = _context137.v;
              if (_t35) {
                _context137.n = 2;
                break;
              }
              _t35 = undefined;
            case 2:
              _t36 = _t35;
              requestBody = _t33.assign.call(_t33, _t34, {
                intermediate_session_token: _t36
              });
              return _context137.a(2, this._networkClient.fetchSDK({
                url: '/b2b/discovery/organizations/create',
                body: requestBody,
                method: 'POST'
              }));
          }
        }, _callee137, this);
      }));
    })
  };
  this.intermediateSessions = {
    exchange: this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this28, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee138() {
        var requestBody;
        return _regenerator().w(function (_context138) {
          while (1) switch (_context138.n) {
            case 0:
              validate('stytch.discovery.intermediateSessions.exchange').isString('organization_id', data.organization_id).isNumber('session_duration_minutes', data.session_duration_minutes).isOptionalString('locale', data.locale);
              requestBody = Object.assign(Object.assign({}, data), {
                intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined
              });
              return _context138.a(2, this._networkClient.fetchSDK({
                url: '/b2b/discovery/intermediate_sessions/exchange',
                body: requestBody,
                method: 'POST'
              }));
          }
        }, _callee138, this);
      }));
    })
  };
});
var DefaultDynamicConfig = Promise.resolve({
  pkceRequiredForPasswordResets: false
});
var HeadlessB2BPasswordsClient = /*#__PURE__*/function () {
  function HeadlessB2BPasswordsClient(_networkClient, _subscriptionService, _pkceManager) {
    var _this29 = this;
    var _config = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : DefaultDynamicConfig;
    var dfpProtectedAuth = arguments.length > 4 ? arguments[4] : undefined;
    _classCallCheck(this, HeadlessB2BPasswordsClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this._pkceManager = _pkceManager;
    this._config = _config;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.authenticate = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this29, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee139() {
        var pkPair, code_verifier, _yield$this$dfpProtec24, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context139) {
          while (1) switch (_context139.n) {
            case 0:
              validate('stytch.passwords.authenticate').isString('org_id', options.organization_id).isString('password', options.password).isString('email_address', options.email_address).isNumber('session_duration_minutes', options.session_duration_minutes).isOptionalString('locale', options.locale);
              _context139.n = 1;
              return this._pkceManager.getPKPair();
            case 1:
              pkPair = _context139.v;
              code_verifier = pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier;
              _context139.n = 2;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 2:
              _yield$this$dfpProtec24 = _context139.v;
              dfp_telemetry_id = _yield$this$dfpProtec24.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec24.captcha_token;
              return _context139.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/passwords/authenticate',
                method: 'POST',
                body: {
                  organization_id: options.organization_id,
                  email_address: options.email_address,
                  password: options.password,
                  session_duration_minutes: options.session_duration_minutes,
                  locale: options.locale,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id,
                  code_verifier: code_verifier,
                  intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee139, this);
      }));
    });
    this.discovery = {
      resetByEmailStart: function resetByEmailStart(options) {
        return __awaiter(_this29, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee140() {
          var pkce_code_challenge, _yield$this$dfpProtec25, dfp_telemetry_id, captcha_token;
          return _regenerator().w(function (_context140) {
            while (1) switch (_context140.n) {
              case 0:
                validate('stytch.passwords.discovery.resetByEmailStart').isString('email', options.email_address).isOptionalString('login_redirect_url', options.discovery_redirect_url).isOptionalString('reset_password_redirect_url', options.reset_password_redirect_url).isOptionalString('reset_password_template_id', options.reset_password_template_id).isOptionalNumber('reset_password_expiration_minutes', options.reset_password_expiration_minutes).isOptionalString('verify_email_template_id', options.verify_email_template_id).isOptionalString('locale', options.locale);
                _context140.n = 1;
                return this.getCodeChallenge();
              case 1:
                pkce_code_challenge = _context140.v;
                _context140.n = 2;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 2:
                _yield$this$dfpProtec25 = _context140.v;
                dfp_telemetry_id = _yield$this$dfpProtec25.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec25.captcha_token;
                return _context140.a(2, this._networkClient.retriableFetchSDK({
                  url: '/b2b/passwords/discovery/reset/start',
                  method: 'POST',
                  body: {
                    email_address: options.email_address,
                    discovery_redirect_url: options.discovery_redirect_url,
                    reset_password_redirect_url: options.reset_password_redirect_url,
                    reset_password_expiration_minutes: options.reset_password_expiration_minutes,
                    reset_password_template_id: options.reset_password_template_id,
                    verify_email_template_id: options.verify_email_template_id,
                    locale: options.locale,
                    pkce_code_challenge: pkce_code_challenge,
                    captcha_token: captcha_token,
                    dfp_telemetry_id: dfp_telemetry_id
                  },
                  retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                }));
            }
          }, _callee140, this);
        }));
      },
      resetByEmail: this._subscriptionService.withUpdateSession(function (options) {
        return __awaiter(_this29, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee141() {
          var _yield$this$dfpProtec26, dfp_telemetry_id, captcha_token, pkPair, pkce_code_verifier, resp, _t37, _t38, _t39, _t40, _t41, _t42, _t43, _t44, _t45, _t46;
          return _regenerator().w(function (_context141) {
            while (1) switch (_context141.n) {
              case 0:
                validate('stytch.passwords.discovery.resetByEmail').isString('password_reset_token', options.password_reset_token).isString('password', options.password);
                _context141.n = 1;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 1:
                _yield$this$dfpProtec26 = _context141.v;
                dfp_telemetry_id = _yield$this$dfpProtec26.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec26.captcha_token;
                _context141.n = 2;
                return this._pkceManager.getPKPair();
              case 2:
                pkPair = _context141.v;
                pkce_code_verifier = pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier;
                _t37 = this._networkClient;
                _t38 = options.password_reset_token;
                _t39 = options.password;
                _t40 = captcha_token;
                _t41 = dfp_telemetry_id;
                _t42 = pkce_code_verifier;
                _context141.n = 3;
                return this._subscriptionService.getIntermediateSessionToken();
              case 3:
                _t43 = _context141.v;
                if (_t43) {
                  _context141.n = 4;
                  break;
                }
                _t43 = undefined;
              case 4:
                _t44 = _t43;
                _t45 = {
                  password_reset_token: _t38,
                  password: _t39,
                  captcha_token: _t40,
                  dfp_telemetry_id: _t41,
                  pkce_code_verifier: _t42,
                  intermediate_session_token: _t44
                };
                _t46 = this.dfpProtectedAuth.retryWithCaptchaAndDFP;
                _context141.n = 5;
                return _t37.retriableFetchSDK.call(_t37, {
                  url: '/b2b/passwords/discovery/reset',
                  method: 'POST',
                  body: _t45,
                  retryCallback: _t46
                });
              case 5:
                resp = _context141.v;
                this._pkceManager.clearPKPair();
                return _context141.a(2, resp);
            }
          }, _callee141, this);
        }));
      }),
      authenticate: this._subscriptionService.withUpdateSession(function (options) {
        return __awaiter(_this29, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee142() {
          var pkPair, code_verifier, _yield$this$dfpProtec27, dfp_telemetry_id, captcha_token;
          return _regenerator().w(function (_context142) {
            while (1) switch (_context142.n) {
              case 0:
                validate('stytch.passwords.discovery.authenticate').isString('password', options.password).isString('email_address', options.email_address);
                _context142.n = 1;
                return this._pkceManager.getPKPair();
              case 1:
                pkPair = _context142.v;
                code_verifier = pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier;
                _context142.n = 2;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 2:
                _yield$this$dfpProtec27 = _context142.v;
                dfp_telemetry_id = _yield$this$dfpProtec27.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec27.captcha_token;
                return _context142.a(2, this._networkClient.retriableFetchSDK({
                  url: '/b2b/passwords/discovery/authenticate',
                  method: 'POST',
                  body: {
                    email_address: options.email_address,
                    password: options.password,
                    captcha_token: captcha_token,
                    dfp_telemetry_id: dfp_telemetry_id,
                    code_verifier: code_verifier
                  },
                  retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                }));
            }
          }, _callee142, this);
        }));
      })
    };
    this.resetByEmail = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this29, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee143() {
        var _yield$this$dfpProtec28, dfp_telemetry_id, captcha_token, pkPair, code_verifier, resp;
        return _regenerator().w(function (_context143) {
          while (1) switch (_context143.n) {
            case 0:
              validate('stytch.passwords.resetByEmail').isString('password_reset_token', options.password_reset_token).isString('password', options.password).isNumber('session_duration_minutes', options.session_duration_minutes).isOptionalString('locale', options.locale);
              _context143.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec28 = _context143.v;
              dfp_telemetry_id = _yield$this$dfpProtec28.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec28.captcha_token;
              _context143.n = 2;
              return this._pkceManager.getPKPair();
            case 2:
              pkPair = _context143.v;
              code_verifier = pkPair === null || pkPair === void 0 ? void 0 : pkPair.code_verifier;
              _context143.n = 3;
              return this._networkClient.retriableFetchSDK({
                url: '/b2b/passwords/email/reset',
                method: 'POST',
                body: {
                  password_reset_token: options.password_reset_token,
                  password: options.password,
                  session_duration_minutes: options.session_duration_minutes,
                  locale: options.locale,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id,
                  code_verifier: code_verifier,
                  intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              });
            case 3:
              resp = _context143.v;
              this._pkceManager.clearPKPair();
              return _context143.a(2, resp);
          }
        }, _callee143, this);
      }));
    });
    this.resetByExistingPassword = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this29, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee144() {
        var _yield$this$dfpProtec29, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context144) {
          while (1) switch (_context144.n) {
            case 0:
              validate('stytch.passwords.resetByExistingPassword').isString('email', options.email_address).isString('existing_password', options.existing_password).isString('new_password', options.new_password).isOptionalString('locale', options.locale).isNumber('session_duration_minutes', options.session_duration_minutes);
              _context144.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec29 = _context144.v;
              dfp_telemetry_id = _yield$this$dfpProtec29.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec29.captcha_token;
              return _context144.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/passwords/existing_password/reset',
                method: 'POST',
                body: {
                  organization_id: options.organization_id,
                  email_address: options.email_address,
                  existing_password: options.existing_password,
                  new_password: options.new_password,
                  locale: options.locale,
                  session_duration_minutes: options.session_duration_minutes,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee144, this);
      }));
    });
    this.resetBySession = this._subscriptionService.withUpdateSession(function (options) {
      return __awaiter(_this29, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee145() {
        var _yield$this$dfpProtec30, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context145) {
          while (1) switch (_context145.n) {
            case 0:
              validate('stytch.passwords.resetBySession').isString('password', options.password);
              _context145.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec30 = _context145.v;
              dfp_telemetry_id = _yield$this$dfpProtec30.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec30.captcha_token;
              return _context145.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/passwords/session/reset',
                method: 'POST',
                body: {
                  password: options.password,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee145, this);
      }));
    });
  }
  return _createClass(HeadlessB2BPasswordsClient, [{
    key: "getCodeChallenge",
    value: function getCodeChallenge() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee146() {
        var _yield$this$_config6, pkceRequiredForPasswordResets, keyPair;
        return _regenerator().w(function (_context146) {
          while (1) switch (_context146.n) {
            case 0:
              _context146.n = 1;
              return this._config;
            case 1:
              _yield$this$_config6 = _context146.v;
              pkceRequiredForPasswordResets = _yield$this$_config6.pkceRequiredForPasswordResets;
              if (pkceRequiredForPasswordResets) {
                _context146.n = 2;
                break;
              }
              return _context146.a(2, undefined);
            case 2:
              _context146.n = 3;
              return this._pkceManager.getPKPair();
            case 3:
              keyPair = _context146.v;
              if (!keyPair) {
                _context146.n = 4;
                break;
              }
              return _context146.a(2, keyPair.code_challenge);
            case 4:
              _context146.n = 5;
              return this._pkceManager.startPKCETransaction();
            case 5:
              keyPair = _context146.v;
              return _context146.a(2, keyPair.code_challenge);
          }
        }, _callee146, this);
      }));
    }
  }, {
    key: "resetByEmailStart",
    value: function resetByEmailStart(options) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee147() {
        var code_challenge, _yield$this$dfpProtec31, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context147) {
          while (1) switch (_context147.n) {
            case 0:
              validate('stytch.passwords.resetByEmailStart').isString('email', options.email_address).isOptionalString('login_redirect_url', options.login_redirect_url).isOptionalString('reset_password_redirect_url', options.reset_password_redirect_url).isOptionalString('reset_password_template_id', options.reset_password_template_id).isOptionalNumber('reset_password_expiration_minutes', options.reset_password_expiration_minutes).isOptionalString('verify_email_template_id', options.verify_email_template_id).isOptionalString('locale', options.locale);
              _context147.n = 1;
              return this.getCodeChallenge();
            case 1:
              code_challenge = _context147.v;
              _context147.n = 2;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 2:
              _yield$this$dfpProtec31 = _context147.v;
              dfp_telemetry_id = _yield$this$dfpProtec31.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec31.captcha_token;
              return _context147.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/passwords/email/reset/start',
                method: 'POST',
                body: {
                  organization_id: options.organization_id,
                  email_address: options.email_address,
                  login_redirect_url: options.login_redirect_url,
                  reset_password_redirect_url: options.reset_password_redirect_url,
                  reset_password_expiration_minutes: options.reset_password_expiration_minutes,
                  reset_password_template_id: options.reset_password_template_id,
                  verify_email_template_id: options.verify_email_template_id,
                  locale: options.locale,
                  code_challenge: code_challenge,
                  captcha_token: captcha_token,
                  dfp_telemetry_id: dfp_telemetry_id
                },
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee147, this);
      }));
    }
  }, {
    key: "strengthCheck",
    value: function strengthCheck(options) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee148() {
        return _regenerator().w(function (_context148) {
          while (1) switch (_context148.n) {
            case 0:
              validate('stytch.passwords.strengthCheck').isOptionalString('email', options.email_address).isString('password', options.password);
              return _context148.a(2, this._networkClient.fetchSDK({
                url: '/b2b/passwords/strength_check',
                method: 'POST',
                body: {
                  email_address: options.email_address,
                  password: options.password
                }
              }));
          }
        }, _callee148, this);
      }));
    }
  }]);
}();
var HeadlessB2BOTPsClient = /*#__PURE__*/_createClass(function HeadlessB2BOTPsClient(_networkClient, _subscriptionService, dfpProtectedAuth) {
  var _this30 = this;
  _classCallCheck(this, HeadlessB2BOTPsClient);
  this._networkClient = _networkClient;
  this._subscriptionService = _subscriptionService;
  this.dfpProtectedAuth = dfpProtectedAuth;
  this.sms = {
    send: function send(data) {
      return __awaiter(_this30, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee149() {
        var _yield$this$dfpProtec32, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context149) {
          while (1) switch (_context149.n) {
            case 0:
              validate('stytch.otps.sms.send').isString('organization_id', data.organization_id).isString('member_id', data.member_id).isOptionalString('mfa_phone_number', data.mfa_phone_number).isOptionalString('locale', data.locale);
              _context149.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec32 = _context149.v;
              dfp_telemetry_id = _yield$this$dfpProtec32.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec32.captcha_token;
              return _context149.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/otps/sms/send',
                body: Object.assign(Object.assign({}, data), {
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token,
                  intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined
                }),
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee149, this);
      }));
    },
    authenticate: this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this30, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee150() {
        var _yield$this$dfpProtec33, dfp_telemetry_id, captcha_token, requestBody;
        return _regenerator().w(function (_context150) {
          while (1) switch (_context150.n) {
            case 0:
              validate('stytch.otps.sms.authenticate').isNumber('session_duration_minutes', data.session_duration_minutes).isString('organization_id', data.organization_id).isString('member_id', data.member_id).isString('code', data.code).isOptionalString('set_mfa_enrollment', data.set_mfa_enrollment);
              _context150.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec33 = _context150.v;
              dfp_telemetry_id = _yield$this$dfpProtec33.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec33.captcha_token;
              requestBody = Object.assign(Object.assign({}, data), {
                dfp_telemetry_id: dfp_telemetry_id,
                captcha_token: captcha_token,
                intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined
              });
              return _context150.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/otps/sms/authenticate',
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee150, this);
      }));
    })
  };
  this.email = {
    loginOrSignup: function loginOrSignup(data) {
      return __awaiter(_this30, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee151() {
        var _yield$this$dfpProtec34, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context151) {
          while (1) switch (_context151.n) {
            case 0:
              validate('stytch.otps.email.loginOrSignup').isString('organization_id', data.organization_id).isString('email_address', data.email_address).isOptionalString('login_template_id', data.login_template_id).isOptionalString('signup_template_id', data.signup_template_id).isOptionalString('locale', data.locale).isOptionalNumber('login_expiration_minutes', data.login_expiration_minutes).isOptionalNumber('signup_expiration_minutes', data.signup_expiration_minutes);
              _context151.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec34 = _context151.v;
              dfp_telemetry_id = _yield$this$dfpProtec34.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec34.captcha_token;
              return _context151.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/otps/email/login_or_signup',
                body: Object.assign(Object.assign({}, data), {
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                }),
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee151, this);
      }));
    },
    authenticate: this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this30, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee152() {
        var _yield$this$dfpProtec35, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context152) {
          while (1) switch (_context152.n) {
            case 0:
              validate('stytch.otps.email.authenticate').isString('code', data.code).isString('email_address', data.email_address).isString('organization_id', data.organization_id).isNumber('session_duration_minutes', data.session_duration_minutes).isOptionalString('locale', data.locale);
              _context152.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec35 = _context152.v;
              dfp_telemetry_id = _yield$this$dfpProtec35.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec35.captcha_token;
              return _context152.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/otps/email/authenticate',
                body: Object.assign(Object.assign({}, data), {
                  intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined,
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                }),
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee152, this);
      }));
    }),
    discovery: {
      send: function send(data) {
        return __awaiter(_this30, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee153() {
          var _yield$this$dfpProtec36, dfp_telemetry_id, captcha_token, requestBody;
          return _regenerator().w(function (_context153) {
            while (1) switch (_context153.n) {
              case 0:
                validate('stytch.otps.email.discovery.send').isString('email_address', data.email_address).isOptionalString('login_template_id', data.login_template_id).isOptionalString('locale', data.locale).isOptionalNumber('discovery_expiration_minutes', data.discovery_expiration_minutes);
                _context153.n = 1;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 1:
                _yield$this$dfpProtec36 = _context153.v;
                dfp_telemetry_id = _yield$this$dfpProtec36.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec36.captcha_token;
                requestBody = Object.assign(Object.assign({}, data), {
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                });
                return _context153.a(2, this._networkClient.retriableFetchSDK({
                  url: '/b2b/otps/email/discovery/send',
                  body: requestBody,
                  method: 'POST',
                  retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                }));
            }
          }, _callee153, this);
        }));
      },
      authenticate: this._subscriptionService.withUpdateSession(function (data) {
        return __awaiter(_this30, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee154() {
          var _yield$this$dfpProtec37, dfp_telemetry_id, captcha_token, requestBody;
          return _regenerator().w(function (_context154) {
            while (1) switch (_context154.n) {
              case 0:
                validate('stytch.otps.email.discovery.authenticate').isString('code', data.code).isString('email_address', data.email_address);
                _context154.n = 1;
                return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
              case 1:
                _yield$this$dfpProtec37 = _context154.v;
                dfp_telemetry_id = _yield$this$dfpProtec37.dfp_telemetry_id;
                captcha_token = _yield$this$dfpProtec37.captcha_token;
                requestBody = Object.assign({
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                }, data);
                return _context154.a(2, this._networkClient.retriableFetchSDK({
                  url: '/b2b/otps/email/discovery/authenticate',
                  body: requestBody,
                  method: 'POST',
                  retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
                }));
            }
          }, _callee154, this);
        }));
      })
    }
  };
});
var HeadlessB2BTOTPsClient = /*#__PURE__*/function () {
  function HeadlessB2BTOTPsClient(_networkClient, _subscriptionService, dfpProtectedAuth) {
    var _this31 = this;
    _classCallCheck(this, HeadlessB2BTOTPsClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.authenticate = this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this31, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee155() {
        var _yield$this$dfpProtec38, dfp_telemetry_id, captcha_token, requestBody;
        return _regenerator().w(function (_context155) {
          while (1) switch (_context155.n) {
            case 0:
              validate('stytch.totp.authenticate').isString('organization_id', data.organization_id).isString('member_id', data.member_id).isString('code', data.code).isNumber('session_duration_minutes', data.session_duration_minutes).isOptionalString('set_mfa_enrollment', data.set_mfa_enrollment).isOptionalBoolean('set_default_mfa', data.set_default_mfa);
              _context155.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec38 = _context155.v;
              dfp_telemetry_id = _yield$this$dfpProtec38.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec38.captcha_token;
              requestBody = Object.assign(Object.assign({}, data), {
                dfp_telemetry_id: dfp_telemetry_id,
                captcha_token: captcha_token,
                intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined
              });
              return _context155.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/totp/authenticate',
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee155, this);
      }));
    });
  }
  return _createClass(HeadlessB2BTOTPsClient, [{
    key: "create",
    value: function create(data) {
      var _a;
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee156() {
        var _yield$this$dfpProtec39, dfp_telemetry_id, captcha_token, response, _t47, _t48, _t49, _t50, _t51, _t52, _t53, _t54, _t55;
        return _regenerator().w(function (_context156) {
          while (1) switch (_context156.n) {
            case 0:
              validate('stytch.totp.create').isString('organization_id', data.organization_id).isString('member_id', data.member_id).isOptionalNumber('expiration_minutes', data.expiration_minutes);
              _context156.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec39 = _context156.v;
              dfp_telemetry_id = _yield$this$dfpProtec39.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec39.captcha_token;
              _t47 = this._networkClient;
              _t48 = Object;
              _t49 = Object.assign({}, data);
              _t50 = dfp_telemetry_id;
              _t51 = captcha_token;
              _context156.n = 2;
              return this._subscriptionService.getIntermediateSessionToken();
            case 2:
              _t52 = _context156.v;
              if (_t52) {
                _context156.n = 3;
                break;
              }
              _t52 = undefined;
            case 3:
              _t53 = _t52;
              _t54 = _t48.assign.call(_t48, _t49, {
                dfp_telemetry_id: _t50,
                captcha_token: _t51,
                intermediate_session_token: _t53
              });
              _t55 = this.dfpProtectedAuth.retryWithCaptchaAndDFP;
              _context156.n = 4;
              return _t47.retriableFetchSDK.call(_t47, {
                url: '/b2b/totp',
                body: _t54,
                method: 'POST',
                retryCallback: _t55
              });
            case 4:
              response = _context156.v;
              if (response.member_id === ((_a = this._subscriptionService.getMember()) === null || _a === void 0 ? void 0 : _a.member_id)) {
                this._subscriptionService.updateMember(response.member);
              }
              return _context156.a(2, response);
          }
        }, _callee156, this);
      }));
    }
  }]);
}();
var HeadlessB2BRecoveryCodesClient = /*#__PURE__*/function () {
  function HeadlessB2BRecoveryCodesClient(_networkClient, _subscriptionService, dfpProtectedAuth) {
    var _this32 = this;
    _classCallCheck(this, HeadlessB2BRecoveryCodesClient);
    this._networkClient = _networkClient;
    this._subscriptionService = _subscriptionService;
    this.dfpProtectedAuth = dfpProtectedAuth;
    this.recover = this._subscriptionService.withUpdateSession(function (data) {
      return __awaiter(_this32, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee157() {
        var _yield$this$dfpProtec40, dfp_telemetry_id, captcha_token, requestBody;
        return _regenerator().w(function (_context157) {
          while (1) switch (_context157.n) {
            case 0:
              validate('stytch.recoveryCodes.recover').isString('organization_id', data.organization_id).isString('member_id', data.member_id).isString('recovery_code', data.recovery_code).isNumber('session_duration_minutes', data.session_duration_minutes);
              _context157.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec40 = _context157.v;
              dfp_telemetry_id = _yield$this$dfpProtec40.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec40.captcha_token;
              requestBody = Object.assign(Object.assign({}, data), {
                dfp_telemetry_id: dfp_telemetry_id,
                captcha_token: captcha_token,
                intermediate_session_token: this._subscriptionService.getIntermediateSessionToken() || undefined
              });
              return _context157.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/recovery_codes/recover',
                body: requestBody,
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee157, this);
      }));
    });
  }
  return _createClass(HeadlessB2BRecoveryCodesClient, [{
    key: "rotate",
    value: function rotate() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee158() {
        var _yield$this$dfpProtec41, dfp_telemetry_id, captcha_token;
        return _regenerator().w(function (_context158) {
          while (1) switch (_context158.n) {
            case 0:
              _context158.n = 1;
              return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
            case 1:
              _yield$this$dfpProtec41 = _context158.v;
              dfp_telemetry_id = _yield$this$dfpProtec41.dfp_telemetry_id;
              captcha_token = _yield$this$dfpProtec41.captcha_token;
              return _context158.a(2, this._networkClient.retriableFetchSDK({
                url: '/b2b/recovery_codes/rotate',
                body: {
                  dfp_telemetry_id: dfp_telemetry_id,
                  captcha_token: captcha_token
                },
                method: 'POST',
                retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
              }));
          }
        }, _callee158, this);
      }));
    }
  }, {
    key: "get",
    value: function get() {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee159() {
        return _regenerator().w(function (_context159) {
          while (1) switch (_context159.n) {
            case 0:
              return _context159.a(2, this._networkClient.fetchSDK({
                url: '/b2b/recovery_codes',
                method: 'GET'
              }));
          }
        }, _callee159, this);
      }));
    }
  }]);
}();
var HeadlessB2BRBACClient = /*#__PURE__*/function () {
  function HeadlessB2BRBACClient(cachedConfig, dynamicConfig, _subscriptionService) {
    var _this33 = this;
    _classCallCheck(this, HeadlessB2BRBACClient);
    this._subscriptionService = _subscriptionService;
    this.isAuthorizedSync = function (resourceId, action) {
      var effectivePolicy = _this33.getEffectivePolicySync();
      return !!(effectivePolicy === null || effectivePolicy === void 0 ? void 0 : effectivePolicy.callerIsAuthorized(_this33.roleIds(), resourceId, action));
    };
    this.isAuthorized = function (resourceId, action) {
      return _this33.getEffectivePolicy().then(function (policy) {
        return policy.callerIsAuthorized(_this33.roleIds(), resourceId, action);
      });
    };
    this.cachedPolicy = cachedConfig.rbacPolicy ? RBACPolicy.fromJSON(cachedConfig.rbacPolicy) : null;
    this.policyPromise = dynamicConfig.then(function (data) {
      if (!data.rbacPolicy) {
        logger.error('Unable to retrieve RBAC policy from servers. Assuming caller has no permissions.');
        return new RBACPolicy([], []);
      }
      // Update the existing policy too, so isAuthorizedSync will be up-to-date
      _this33.cachedPolicy = RBACPolicy.fromJSON(data.rbacPolicy);
      return _this33.cachedPolicy;
    });
  }
  /**
   * Gets the effective policy for the current session by merging project policy with org custom roles
   */
  return _createClass(HeadlessB2BRBACClient, [{
    key: "getEffectivePolicy",
    value: function getEffectivePolicy() {
      var _a;
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee160() {
        var projectPolicy, organization;
        return _regenerator().w(function (_context160) {
          while (1) switch (_context160.n) {
            case 0:
              _context160.n = 1;
              return this.policyPromise;
            case 1:
              projectPolicy = _context160.v;
              organization = this._subscriptionService.getOrganization(); // If no org or no custom roles, just return project policy
              if ((_a = organization === null || organization === void 0 ? void 0 : organization.custom_roles) === null || _a === void 0 ? void 0 : _a.length) {
                _context160.n = 2;
                break;
              }
              return _context160.a(2, projectPolicy);
            case 2:
              return _context160.a(2, projectPolicy.mergeWithCustomRoles(organization.custom_roles));
          }
        }, _callee160, this);
      }));
    }
    /**
     * Gets the effective policy synchronously for the current session
     * Uses cached policies only
     */
  }, {
    key: "getEffectivePolicySync",
    value: function getEffectivePolicySync() {
      var _a;
      if (!this.cachedPolicy) {
        return null;
      }
      var organization = this._subscriptionService.getOrganization();
      // If no custom roles, just return project policy
      if (!((_a = organization === null || organization === void 0 ? void 0 : organization.custom_roles) === null || _a === void 0 ? void 0 : _a.length)) {
        return this.cachedPolicy;
      }
      return this.cachedPolicy.mergeWithCustomRoles(organization.custom_roles);
    }
  }, {
    key: "allPermissions",
    value: function allPermissions() {
      var _this34 = this;
      return this.getEffectivePolicy().then(function (policy) {
        return policy.allPermissionsForCaller(_this34.roleIds());
      });
    }
  }, {
    key: "roleIds",
    value: function roleIds() {
      var _a;
      var session = this._subscriptionService.getSession();
      if (!session) {
        return [];
      }
      // Although session.roles is guaranteed to exist for fresh data, there is a minuscule chance
      // that the member session stored in localstorage clientside comes from before roles were added to
      // the API response - in which case session.roles will be undefined and this will crash
      // TODO: [AUTH-2294] We can safely remove this ~3mos after RBAC is released
      return (_a = session.roles) !== null && _a !== void 0 ? _a : [];
    }
  }]);
}();
var HeadlessB2BImpersonationClient = /*#__PURE__*/_createClass(function HeadlessB2BImpersonationClient(_networkClient, _subscriptionService, dfpProtectedAuth) {
  var _this35 = this;
  _classCallCheck(this, HeadlessB2BImpersonationClient);
  this._networkClient = _networkClient;
  this._subscriptionService = _subscriptionService;
  this.dfpProtectedAuth = dfpProtectedAuth;
  this.authenticate = this._subscriptionService.withUpdateSession(function (data) {
    return __awaiter(_this35, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee161() {
      var _yield$this$dfpProtec42, dfp_telemetry_id, captcha_token;
      return _regenerator().w(function (_context161) {
        while (1) switch (_context161.n) {
          case 0:
            validate('stytch.impersonation.authenticate').isString('impersonation_token', data.impersonation_token);
            _context161.n = 1;
            return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha();
          case 1:
            _yield$this$dfpProtec42 = _context161.v;
            dfp_telemetry_id = _yield$this$dfpProtec42.dfp_telemetry_id;
            captcha_token = _yield$this$dfpProtec42.captcha_token;
            return _context161.a(2, this._networkClient.retriableFetchSDK({
              url: '/b2b/impersonation/authenticate',
              body: Object.assign(Object.assign({}, data), {
                dfp_telemetry_id: dfp_telemetry_id,
                captcha_token: captcha_token
              }),
              method: 'POST',
              retryCallback: this.dfpProtectedAuth.retryWithCaptchaAndDFP
            }));
        }
      }, _callee161, this);
    }));
  });
});
var HeadlessB2BIDPClient = /*#__PURE__*/_createClass(function HeadlessB2BIDPClient(_networkClient) {
  var _this36 = this;
  _classCallCheck(this, HeadlessB2BIDPClient);
  this._networkClient = _networkClient;
  /**
   * Initiates a request for authorization of a Connected App to access a Member's account.
   *
   * Call this endpoint using the query parameters from an OAuth Authorization request. This endpoint validates various fields (scope, client_id, redirect_uri, prompt, etc...) are correct and returns relevant information for rendering an OAuth Consent Screen.
   *
   * @example
   * const response = await stytch.idp.oauthAuthorizeStart({
   *   client_id: 'client_123',
   *   redirect_uri: 'https://example.com/callback',
   *   scope: 'openid email profile',
   * });
   */
  this.oauthAuthorizeStart = function (data) {
    return __awaiter(_this36, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee162() {
      return _regenerator().w(function (_context162) {
        while (1) switch (_context162.n) {
          case 0:
            return _context162.a(2, this._networkClient.fetchSDK({
              url: '/idp/b2b/oauth/authorize/start',
              method: 'POST',
              body: data
            }));
        }
      }, _callee162, this);
    }));
  };
  /**
   * Completes a request for authorization of a Connected App to access a Member's account.
   *
   * Call this endpoint using the query parameters from an OAuth Authorization request, after previously validating those parameters using the Preflight Check API. Note that this endpoint takes in a few additional parameters the preflight check does not- state, nonce, and code_challenge.
   *
   * If the authorization was successful, the redirect_uri will contain a valid authorization_code embedded as a query parameter. If the authorization was unsuccessful, the redirect_uri will contain an OAuth2.1 error_code. In both cases, redirect the Member to the location for the response to be consumed by the Connected App.
   *
   * Exactly one of the following must be provided to identify the Member granting authorization:
   * organization_id + member_id
   * session_token
   * session_jwt
   *
   * If a session_token or session_jwt is passed, the OAuth Authorization will be linked to the Member's session for tracking purposes. One of these fields must be used if the Connected App intends to complete the Exchange Access Token flow.
   *
   * @example
   * const response = await stytch.idp.oauthAuthorizeSubmit({
   *   client_id: 'client_123',
   *   redirect_uri: 'https://example.com/callback',
   *   scope: 'openid email profile',
   * });
   */
  this.oauthAuthorizeSubmit = function (data) {
    return __awaiter(_this36, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee163() {
      return _regenerator().w(function (_context163) {
        while (1) switch (_context163.n) {
          case 0:
            return _context163.a(2, this._networkClient.fetchSDK({
              url: '/idp/b2b/oauth/authorize/submit',
              method: 'POST',
              body: data
            }));
        }
      }, _callee163, this);
    }));
  };
  this.oauthLogoutStart = function (data) {
    return __awaiter(_this36, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee164() {
      return _regenerator().w(function (_context164) {
        while (1) switch (_context164.n) {
          case 0:
            return _context164.a(2, this._networkClient.fetchSDK({
              url: "/b2b/oauth/logout/start",
              method: 'POST',
              body: data
            }));
        }
      }, _callee164, this);
    }));
  };
});
var IframeHostClient = /*#__PURE__*/function () {
  function IframeHostClient(iframeURL) {
    _classCallCheck(this, IframeHostClient);
    this.iframeURL = iframeURL;
    this.createIframe();
  }
  return _createClass(IframeHostClient, [{
    key: "createIframe",
    value: function createIframe() {
      var existingIframe = document.querySelector("[src~=\"".concat(this.iframeURL, "\"]"));
      /* If an iframe does not exist yet, create one */
      if (!existingIframe) {
        existingIframe = document.createElement('iframe');
        existingIframe.src = this.iframeURL;
        existingIframe.style.position = 'absolute';
        existingIframe.style.width = '0';
        existingIframe.style.height = '0';
        existingIframe.style.border = '0';
        document.body.appendChild(existingIframe);
      } else {
        logger.warn(MULTIPLE_STYTCH_CLIENTS_DETECTED_WARNING);
      }
      /**
       * [NASTY BUG]
       * If we postMessage to an iframe that is _not yet loaded_, chrome will give a cryptic error message
       * Failed to execute 'postMessage' on 'DOMWindow':
       *   The target origin provided ('https://js.stytch.com') does not match the recipient window's origin ('http://localhost:3000').
       * There is no builtin way to determine if an iframe is already loaded,
       * so we set a dataset attr in our onload handler and use that to determine loading state
       */
      if (existingIframe.dataset.loaded === 'true') {
        this.frame = Promise.resolve(existingIframe);
        return;
      }
      this.frame = new Promise(function (resolve) {
        existingIframe.addEventListener('load', function () {
          existingIframe.dataset.loaded = 'true';
          resolve(existingIframe);
        }, {
          once: true
        });
      });
    }
  }, {
    key: "call",
    value: function call(method, args) {
      return __awaiter(this, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee165() {
        var _this37 = this;
        var frame, channel;
        return _regenerator().w(function (_context165) {
          while (1) switch (_context165.n) {
            case 0:
              _context165.n = 1;
              return this.frame;
            case 1:
              frame = _context165.v;
              channel = new MessageChannel();
              return _context165.a(2, new Promise(function (resolve, reject) {
                var _a;
                channel.port1.onmessage = function (event) {
                  var resp = event.data;
                  channel.port1.close();
                  if (resp.success) {
                    resolve(resp.payload);
                  } else {
                    reject(ErrorMarshaller.unmarshall(resp.error));
                  }
                };
                var message = {
                  method: method,
                  args: args
                };
                (_a = frame.contentWindow) === null || _a === void 0 ? void 0 : _a.postMessage(message, _this37.iframeURL, [channel.port2]);
              }));
          }
        }, _callee165, this);
      }));
    }
  }]);
}();
var SearchDataManager = /*#__PURE__*/function () {
  function SearchDataManager(_networkClient, dfpProtectedAuth) {
    _classCallCheck(this, SearchDataManager);
    this._networkClient = _networkClient;
    this.dfpProtectedAuth = dfpProtectedAuth;
  }
  return _createClass(SearchDataManager, [{
    key: "searchUser",
    value: function searchUser(email) {
      var _this38 = this;
      return this.dfpProtectedAuth.getDFPTelemetryIDAndCaptcha().then(function (_ref0) {
        var dfp_telemetry_id = _ref0.dfp_telemetry_id,
          captcha_token = _ref0.captcha_token;
        return _this38._networkClient.fetchSDK({
          url: "/users/search",
          method: 'POST',
          body: {
            email: email,
            dfp_telemetry_id: dfp_telemetry_id,
            captcha_token: captcha_token
          }
        });
      });
    }
  }, {
    key: "searchMember",
    value: function searchMember(email, organization_id) {
      return this._networkClient.fetchSDK({
        url: "/b2b/organizations/members/search",
        method: 'POST',
        body: {
          email_address: email,
          organization_id: organization_id
        }
      });
    }
  }]);
}(); // We should try refreshing the session if there exists a cached session in
// state that might be stale. Otherwise, we know there is no session, so there's
// no need.
var shouldTryRefresh = function shouldTryRefresh(state) {
  return !!(state === null || state === void 0 ? void 0 : state.session);
};
var SessionManagerRegistry = /*#__PURE__*/function () {
  function SessionManagerRegistry() {
    _classCallCheck(this, SessionManagerRegistry);
    this.hasWarned = false;
    this.registry = new Map();
  }
  return _createClass(SessionManagerRegistry, [{
    key: "register",
    value: function register(key, sessionManager) {
      var otherManager = this.registry.get(key);
      // If there appears to be another registered session manager, issue a
      // warning and cancel its background refresh in favor the newer registration
      if (otherManager && otherManager !== sessionManager) {
        if (!this.hasWarned) {
          logger.warn(MULTIPLE_STYTCH_CLIENTS_DETECTED_WARNING);
          this.hasWarned = true;
        }
        otherManager.cancelBackgroundRefresh();
      }
      this.registry.set(key, sessionManager);
    }
  }, {
    key: "unregister",
    value: function unregister(publicToken, sessionManager) {
      var otherManager = this.registry.get(publicToken);
      if (otherManager && otherManager === sessionManager) {
        this.registry["delete"](publicToken);
      }
    }
  }]);
}();
var SessionManager = /*#__PURE__*/function () {
  function SessionManager(_subscriptionService, _headlessSessionClient, _publicToken, _options) {
    var _this39 = this;
    _classCallCheck(this, SessionManager);
    this._subscriptionService = _subscriptionService;
    this._headlessSessionClient = _headlessSessionClient;
    this._publicToken = _publicToken;
    this._options = _options;
    // When testing - it's often more useful to set to a shorter duration
    // private static REFRESH_INTERVAL_MS = 1000 * 3;
    this.timeout = null;
    /**
     * We need to listen to a few types of events:
     * - If the user logs in via invoking a .authenticate() call, we should start the background worker
     * - If the user steps up their authentication via another .authenticate call(), we should restart the background worker
     * - If the user logs out, we should terminate the worker
     * - We should ignore session changes that we ourselves caused - so if we already have a timeout, leave it be!
     */
    this._onDataChange = function (state) {
      if (state != null && state.sessionDurationMinutes) {
        _this39.lastAuthenticationSessionDuration = state.sessionDurationMinutes;
      }
      if (shouldTryRefresh(state)) {
        _this39.scheduleBackgroundRefresh();
      } else {
        _this39.cancelBackgroundRefresh();
      }
    };
    // In cases where we cannot get a satisfactory request:
    // - Stytch is hard-down
    // - The user's network is disconnected for an extended period of time
    // we will continue to retry every 4 minutes ad infinum
    this._reauthenticateWithBackoff = function () {
      return __awaiter(_this39, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee166() {
        var count, options, _t56;
        return _regenerator().w(function (_context166) {
          while (1) switch (_context166.p = _context166.n) {
            case 0:
              count = 0;
            case 1:
              if (!true) {
                _context166.n = 7;
                break;
              }
              _context166.p = 2;
              options = {
                session_duration_minutes: this._options.keepSessionAlive ? this.lastAuthenticationSessionDuration : undefined
              };
              _context166.n = 3;
              return this._headlessSessionClient.authenticate(options);
            case 3:
              return _context166.a(2, _context166.v);
            case 4:
              _context166.p = 4;
              _t56 = _context166.v;
              if (!SessionManager.isUnrecoverableError(_t56)) {
                _context166.n = 5;
                break;
              }
              return _context166.a(2, Promise.reject(_t56));
            case 5:
              count++;
              _context166.n = 6;
              return new Promise(function (done) {
                return setTimeout(done, SessionManager.timeoutForAttempt(count));
              });
            case 6:
              _context166.n = 1;
              break;
            case 7:
              return _context166.a(2);
          }
        }, _callee166, this, [[2, 4]]);
      }));
    };
    this._subscriptionService.subscribeToState(this._onDataChange);
  }
  /**
   * The core logic of the session refresh recursive trampoline
   * - Refreshes the currently issued session
   * - Schedules a future refresh if successful
   */
  return _createClass(SessionManager, [{
    key: "register",
    value: function register() {
      SessionManager.registry.register(this._publicToken, this);
    }
  }, {
    key: "unregister",
    value: function unregister() {
      SessionManager.registry.unregister(this._publicToken, this);
    }
  }, {
    key: "performBackgroundRefresh",
    value: function performBackgroundRefresh() {
      var _this40 = this;
      logger.debug('performing background refresh at ', Date.now());
      this._reauthenticateWithBackoff().then(function () {
        _this40.scheduleBackgroundRefresh();
      })["catch"](function (error) {
        logger.warn('Session background refresh failed. Signalling to app that user is logged out.', {
          error: error
        });
        _this40._subscriptionService.destroySession();
      });
    }
  }, {
    key: "scheduleBackgroundRefresh",
    value: function scheduleBackgroundRefresh() {
      var _this41 = this;
      /* Highlander rules - there can only ever be one */
      this.cancelBackgroundRefresh();
      this.register();
      logger.debug('Scheduling bg refresh', Date.now());
      this.timeout = setTimeout(function () {
        _this41.performBackgroundRefresh();
      }, SessionManager.REFRESH_INTERVAL_MS);
    }
  }, {
    key: "cancelBackgroundRefresh",
    value: function cancelBackgroundRefresh() {
      if (this.timeout !== null) {
        this.unregister();
        logger.debug('Cancelling bg refresh', Date.now());
        clearTimeout(this.timeout);
        this.timeout = null;
      }
    }
    // We start with a backoff of 2000ms and increase exponentially to ~4 minutes (+/- 175 ms for jitter)
    // A short backoff initially helps increase the chance that we refresh the session before the JWT expires
  }], [{
    key: "timeoutForAttempt",
    value: function timeoutForAttempt(count) {
      count = Math.min(count, 7);
      var jitter = Math.floor(Math.random() * 350) - 175;
      var delayMS = 2000 * Math.pow(2, count);
      return jitter + delayMS;
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
  }, {
    key: "isUnrecoverableError",
    value: function isUnrecoverableError(error) {
      return UNRECOVERABLE_ERROR_TYPES.includes(error.error_type);
    }
  }]);
}(); // Three minutes
SessionManager.REFRESH_INTERVAL_MS = 1000 * 60 * 3;
SessionManager.registry = new SessionManagerRegistry();
var StateChangeClient = /*#__PURE__*/_createClass(function StateChangeClient(_subscriptionService, emptyState) {
  var _this42 = this;
  _classCallCheck(this, StateChangeClient);
  this._subscriptionService = _subscriptionService;
  this.emptyState = emptyState;
  this.onStateChange = function (callback) {
    return _this42._subscriptionService.subscribeToState(function (state) {
      callback(state !== null && state !== void 0 ? state : _this42.emptyState);
    });
  };
});
var LOCAL_STORAGE_KEY_PREFIX = 'stytch_sdk_state_';
var getLocalStorageKey = function getLocalStorageKey(publicToken) {
  return "".concat(LOCAL_STORAGE_KEY_PREFIX).concat(publicToken);
};
var SubscriptionDataLayer = /*#__PURE__*/function () {
  function SubscriptionDataLayer(_publicToken, _storageClient) {
    var _this43 = this;
    _classCallCheck(this, SubscriptionDataLayer);
    this._publicToken = _publicToken;
    this._storageClient = _storageClient;
    this.syncFromLocalStorage = function () {
      return __awaiter(_this43, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee167() {
        var _this44 = this;
        return _regenerator().w(function (_context167) {
          while (1) switch (_context167.n) {
            case 0:
              return _context167.a(2, this._storageClient.getData(getLocalStorageKey(this._publicToken)).then(function (localData) {
                if (!localData) {
                  return null;
                }
                var parsedState;
                try {
                  parsedState = JSON.parse(localData);
                } catch (_a) {
                  // Overwrite the bad data
                  _this44._storageClient.clearData(getLocalStorageKey(_this44._publicToken));
                  // this.removeSessionCookie();
                  return null;
                }
                var _parsedState = parsedState,
                  state = _parsedState.state,
                  session_token = _parsedState.session_token,
                  session_jwt = _parsedState.session_jwt,
                  intermediate_session_token = _parsedState.intermediate_session_token;
                _this44.state = state;
                _this44.session_token = session_token;
                _this44.session_jwt = session_jwt;
                _this44.intermediate_session_token = intermediate_session_token;
                return {
                  state: state,
                  session_token: session_token,
                  session_jwt: session_jwt,
                  intermediate_session_token: intermediate_session_token
                };
              })["catch"](function () {
                return null;
              }));
          }
        }, _callee167, this);
      }));
    };
    this.state = null;
    this.session_token = null;
    this.session_jwt = null;
    this.intermediate_session_token = null;
    this.intermediate_session_token_expiration = null;
    this.subscriptions = {};
  }
  return _createClass(SubscriptionDataLayer, [{
    key: "syncToLocalStorage",
    value: function syncToLocalStorage() {
      this._storageClient.setData(getLocalStorageKey(this._publicToken), JSON.stringify({
        state: this.state,
        session_token: this.session_token,
        session_jwt: this.session_jwt,
        intermediate_session_token: this.intermediate_session_token
      }));
    }
  }]);
}();
var addSubscriber = function addSubscriber(collection, subscriber) {
  var uniqueId = Math.random().toString(36).slice(-10);
  collection[uniqueId] = subscriber;
  return function () {
    return delete collection[uniqueId];
  };
};
var notifySubscribers = function notifySubscribers(collection, value) {
  Object.values(collection).forEach(function (cb) {
    return cb(value);
  });
};
var SubscriptionService = /*#__PURE__*/function () {
  function SubscriptionService(publicToken, storageClient) {
    _classCallCheck(this, SubscriptionService);
    var _a;
    /**
     * Whether the state was retrieved from the cache and is awaiting a refresh
     */
    this.fromCache = true;
    // TODO: Generalize this for Mobile and Web based SDKs
    this._datalayer = new SubscriptionDataLayer(publicToken, storageClient);
    var session = (_a = this._datalayer.state) === null || _a === void 0 ? void 0 : _a.session;
    if (session && Date.parse(session.expires_at) < Date.now()) {
      this.destroyState();
      return;
    }
  }
  return _createClass(SubscriptionService, [{
    key: "syncFromDeviceStorage",
    value: function syncFromDeviceStorage(onCompleteCallback) {
      var _this45 = this;
      this._datalayer.syncFromLocalStorage().then(function (res) {
        var _a;
        if (!res) {
          _this45.setCacheRefreshed();
        } else if (((_a = res.state) === null || _a === void 0 ? void 0 : _a.session) && Date.parse(res.state.session.expires_at) < Date.now()) {
          _this45.destroyState();
        } else {
          // If we retrieved a possibly valid session, indicate whether we
          // intend to refresh it (via a background refresh)
          _this45.updateStateAndTokens(res, {
            fromCache: shouldTryRefresh(res.state)
          });
        }
      })["finally"](function () {
        onCompleteCallback();
      });
    }
  }, {
    key: "getState",
    value: function getState() {
      return this._datalayer.state;
    }
  }, {
    key: "getTokens",
    value: function getTokens() {
      if (!(typeof this._datalayer.session_token === 'string') || !(typeof this._datalayer.session_jwt === 'string')) {
        return null;
      }
      return {
        session_token: this._datalayer.session_token,
        session_jwt: this._datalayer.session_jwt
      };
    }
  }, {
    key: "removeIST",
    value: function removeIST() {
      this._datalayer.intermediate_session_token = null;
      this._datalayer.intermediate_session_token_expiration = null;
    }
  }, {
    key: "removeSessionTokens",
    value: function removeSessionTokens() {
      this._datalayer.session_jwt = null;
      this._datalayer.session_token = null;
    }
  }, {
    key: "getIntermediateSessionToken",
    value: function getIntermediateSessionToken() {
      if (this._datalayer.intermediate_session_token_expiration && Date.now() > this._datalayer.intermediate_session_token_expiration) {
        this.removeIST();
      }
      return this._datalayer.intermediate_session_token;
    }
  }, {
    key: "destroyState",
    value: function destroyState() {
      this.updateStateAndTokens({
        state: null,
        session_token: null,
        session_jwt: null,
        intermediate_session_token: null
      });
    }
  }, {
    key: "destroySession",
    value: function destroySession() {
      this.updateStateAndTokens({
        state: null,
        session_token: null,
        session_jwt: null,
        intermediate_session_token: this.getIntermediateSessionToken()
      });
    }
  }, {
    key: "_updateStateAndTokensInternal",
    value: function _updateStateAndTokensInternal(stateDiff, options) {
      var state = stateDiff.state,
        session_token = stateDiff.session_token,
        session_jwt = stateDiff.session_jwt,
        intermediate_session_token = stateDiff.intermediate_session_token;
      var newData = state == null ? null : Object.assign(Object.assign({}, this._datalayer.state), state);
      this._datalayer.state = newData;
      if (newData) {
        this._datalayer.session_token = session_token;
        this._datalayer.session_jwt = session_jwt;
        this.removeIST();
      } else if (intermediate_session_token) {
        this.removeSessionTokens();
        this._datalayer.intermediate_session_token = intermediate_session_token;
        // ISTs are only valid for 10 minutes
        this._datalayer.intermediate_session_token_expiration = Date.now() + 10 * 60 * 1000;
      } else {
        this.removeSessionTokens();
        this.removeIST();
      }
      if (!options.fromCache) {
        this.setCacheRefreshed();
      }
      var notification;
      if (newData == null || options.fromCache) {
        notification = newData;
      } else {
        notification = Object.assign(Object.assign({}, newData), {
          sessionDurationMinutes: options.sessionDurationMinutes
        });
      }
      notifySubscribers(this._datalayer.subscriptions, notification);
    }
  }, {
    key: "updateStateAndTokens",
    value: function updateStateAndTokens(stateDiff) {
      var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {
        fromCache: false
      };
      this._updateStateAndTokensInternal(stateDiff, options);
      this._datalayer.syncToLocalStorage();
    }
  }, {
    key: "updateState",
    value: function updateState(state) {
      var newState = state ? Object.assign(Object.assign({}, this._datalayer.state), state) : null;
      this._datalayer.state = newState;
      this.setCacheRefreshed();
      notifySubscribers(this._datalayer.subscriptions, newState);
      // Delay notifying other tabs until after we have refreshed ourselves
      this._datalayer.syncToLocalStorage();
    }
  }, {
    key: "updateTokens",
    value: function updateTokens(tokens) {
      var _a;
      this._datalayer.session_token = tokens.session_token;
      this._datalayer.session_jwt = (_a = tokens.session_jwt) !== null && _a !== void 0 ? _a : null;
      this._datalayer.syncToLocalStorage();
    }
  }, {
    key: "subscribeToState",
    value: function subscribeToState(callback) {
      return addSubscriber(this._datalayer.subscriptions, callback);
    }
  }, {
    key: "getFromCache",
    value: function getFromCache() {
      return this.fromCache;
    }
  }, {
    key: "setCacheRefreshed",
    value: function setCacheRefreshed() {
      this.fromCache = false;
    }
  }]);
}();
var ConsumerSubscriptionService = /*#__PURE__*/function (_SubscriptionService) {
  function ConsumerSubscriptionService() {
    var _this46;
    _classCallCheck(this, ConsumerSubscriptionService);
    _this46 = _callSuper(this, ConsumerSubscriptionService, arguments);
    _this46.updateSession = function (resp, options) {
      // This is a bit of a hack to get the type inference to work. In practice,
      // opaque tokens are only a concern on web.
      var session = resp.session,
        user = resp.user,
        session_jwt = resp.session_jwt,
        session_token = resp.session_token;
      _this46.updateStateAndTokens({
        state: {
          session: session,
          user: user
        },
        session_jwt: session_jwt,
        session_token: session_token,
        intermediate_session_token: null
      }, {
        fromCache: false,
        sessionDurationMinutes: options === null || options === void 0 ? void 0 : options.sessionDurationMinutes
      });
    };
    _this46.withUpdateSession = function (authenticate) {
      return function () {
        for (var _len4 = arguments.length, args = new Array(_len4), _key4 = 0; _key4 < _len4; _key4++) {
          args[_key4] = arguments[_key4];
        }
        return __awaiter(_this46, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee168() {
          var resp, options;
          return _regenerator().w(function (_context168) {
            while (1) switch (_context168.n) {
              case 0:
                _context168.n = 1;
                return authenticate.apply(void 0, args);
              case 1:
                resp = _context168.v;
                if (resp != null) {
                  options = args.find(function (a) {
                    return a != null && !(typeof a === 'string');
                  });
                  this.updateSession(resp, {
                    sessionDurationMinutes: options === null || options === void 0 ? void 0 : options.session_duration_minutes
                  });
                }
                return _context168.a(2, resp);
            }
          }, _callee168, this);
        }));
      };
    };
    _this46.updateUser = function (user) {
      return _this46.updateState({
        user: user
      });
    };
    _this46.getUser = function () {
      var _a, _b;
      return (_b = (_a = _this46.getState()) === null || _a === void 0 ? void 0 : _a.user) !== null && _b !== void 0 ? _b : null;
    };
    _this46.getSession = function () {
      var _a, _b;
      return (_b = (_a = _this46.getState()) === null || _a === void 0 ? void 0 : _a.session) !== null && _b !== void 0 ? _b : null;
    };
    return _this46;
  }
  _inherits(ConsumerSubscriptionService, _SubscriptionService);
  return _createClass(ConsumerSubscriptionService);
}(SubscriptionService);
var B2BSubscriptionService = /*#__PURE__*/function (_SubscriptionService2) {
  function B2BSubscriptionService() {
    var _this47;
    _classCallCheck(this, B2BSubscriptionService);
    _this47 = _callSuper(this, B2BSubscriptionService, arguments);
    _this47.updateSession = function (originalResp, options) {
      // This is a bit of a hack to get the type inference to work. In practice,
      // opaque tokens are only a concern on web.
      var resp = originalResp;
      if ('member_session' in resp && resp.member_session) {
        _this47.updateStateAndTokens({
          state: {
            session: resp.member_session,
            member: resp.member,
            organization: resp.organization
          },
          session_token: resp.session_token,
          session_jwt: resp.session_jwt,
          intermediate_session_token: null
        }, {
          fromCache: false,
          sessionDurationMinutes: options === null || options === void 0 ? void 0 : options.sessionDurationMinutes
        });
      } else {
        _this47.updateStateAndTokens({
          state: null,
          session_token: null,
          session_jwt: null,
          intermediate_session_token: resp.intermediate_session_token
        }, {
          fromCache: false,
          sessionDurationMinutes: options === null || options === void 0 ? void 0 : options.sessionDurationMinutes
        });
      }
    };
    _this47.withUpdateSession = function (authenticate) {
      return function (options) {
        return __awaiter(_this47, void 0, void 0, /*#__PURE__*/_regenerator().m(function _callee169() {
          var resp;
          return _regenerator().w(function (_context169) {
            while (1) switch (_context169.n) {
              case 0:
                _context169.n = 1;
                return authenticate(options);
              case 1:
                resp = _context169.v;
                this.updateSession(resp, {
                  sessionDurationMinutes: options === null || options === void 0 ? void 0 : options.session_duration_minutes
                });
                return _context169.a(2, resp);
            }
          }, _callee169, this);
        }));
      };
    };
    _this47.updateMember = function (member) {
      return _this47.updateState({
        member: member
      });
    };
    _this47.getMember = function () {
      var _a, _b;
      return (_b = (_a = _this47.getState()) === null || _a === void 0 ? void 0 : _a.member) !== null && _b !== void 0 ? _b : null;
    };
    _this47.updateOrganization = function (organization) {
      return _this47.updateState({
        organization: organization
      });
    };
    _this47.getOrganization = function () {
      var _a, _b;
      return (_b = (_a = _this47.getState()) === null || _a === void 0 ? void 0 : _a.organization) !== null && _b !== void 0 ? _b : null;
    };
    _this47.getSession = function () {
      var _a, _b;
      return (_b = (_a = _this47.getState()) === null || _a === void 0 ? void 0 : _a.session) !== null && _b !== void 0 ? _b : null;
    };
    return _this47;
  }
  _inherits(B2BSubscriptionService, _SubscriptionService2);
  return _createClass(B2BSubscriptionService);
}(SubscriptionService);
var VERTICAL_B2B = 'B2B';
var VERTICAL_CONSUMER = 'CONSUMER';
var createDeepEqual = function createDeepEqual() {
  var _ref1 = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {},
    _ref1$KEYS_TO_EXCLUDE = _ref1.KEYS_TO_EXCLUDE,
    KEYS_TO_EXCLUDE = _ref1$KEYS_TO_EXCLUDE === void 0 ? [] : _ref1$KEYS_TO_EXCLUDE;
  // If comparing functions, this may need some work. Not sure the
  // best path for this: compare instance (what it currently does),
  // stringify and compare, etc.
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  var _deepEqual = function deepEqual(a, b) {
    // Ensures type is the same
    if (_typeof(a) !== _typeof(b)) return false;
    // arrays, null, and objects all have type 'object'
    if (a === null || b === null) return a === b;
    if (_typeof(a) === 'object') {
      if (Object.keys(a).length !== Object.keys(b).length || Object.keys(a).some(function (k) {
        return !(k in b);
      })) return false;
      return Object.entries(a).filter(function (_ref10) {
        var _ref11 = _slicedToArray(_ref10, 1),
          k = _ref11[0];
        return !KEYS_TO_EXCLUDE.includes(k);
      }).every(function (_ref12) {
        var _ref13 = _slicedToArray(_ref12, 2),
          k = _ref13[0],
          v = _ref13[1];
        return _deepEqual(v, b[k]);
      });
    }
    // boolean, string, number, undefined
    return a === b;
  };
  return _deepEqual;
};
export { B2BSubscriptionService, CLIENTSIDE_SERVICES_IFRAME_URL, COUNTRIES_LIST, ConsumerSubscriptionService, DEFAULT_INTERVAL_DURATION_MS, DEFAULT_MAX_BATCH_SIZE, DEFAULT_OTP_EXPIRATION_MINUTES, DEFAULT_SESSION_DURATION_MINUTES, DFPProtectedAuthProvider, DisabledDFPProtectedAuthProvider, EmailSentType, ErrorMarshaller, EventLogger, GOOGLE_ONE_TAP_HOST, GOOGLE_ONE_TAP_SCRIPT_URL, HeadlessB2BDiscoveryClient, HeadlessB2BIDPClient, HeadlessB2BImpersonationClient, HeadlessB2BMagicLinksClient, HeadlessB2BOAuthClient, HeadlessB2BOTPsClient, HeadlessB2BOrganizationClient, HeadlessB2BPasswordsClient, HeadlessB2BRBACClient, HeadlessB2BRecoveryCodesClient, HeadlessB2BSCIMClient, HeadlessB2BSSOClient, HeadlessB2BSelfClient, HeadlessB2BSessionClient, HeadlessB2BTOTPsClient, HeadlessCryptoWalletClient, HeadlessIDPClient, HeadlessImpersonationClient, HeadlessMagicLinksClient, HeadlessOAuthClient, HeadlessOTPClient, HeadlessPasswordClient, HeadlessRBACClient, HeadlessSessionClient, HeadlessTOTPClient, HeadlessUserClient, HeadlessWebAuthnClient, IframeHostClient, LIVE_API_URL, MULTIPLE_STYTCH_CLIENTS_DETECTED_WARNING, POWERED_BY_STYTCH_IMG_URL, RBACPolicy, RetriableError, RetriableErrorType, STYTCH_DFP_BACKEND_URL, STYTCH_DFP_CDN_URL, STYTCH_SESSION_COOKIE, STYTCH_SESSION_JWT_COOKIE, SearchDataManager, SessionManager, StateChangeClient, SubscriptionDataLayer, SubscriptionService, TEST_API_URL, VERTICAL_B2B, VERTICAL_CONSUMER, WILDCARD_ACTION, arrayUtils, baseFetchSDK, baseSubmitFormSDK, checkB2BNotSSR, checkNotSSR, checkPublicToken, createAppSessionId, createDeepEqual, createEventId, createPersistentId, getDFPBackendURL, getDFPCdnURL, getLiveApiURL, getTestApiURL, isEmailMethod, isPhoneMethod, isTestPublicToken, loadESModule, logger, normalizePromiseLike, omitUser, removeResponseCommon, retriableFetchSDK, validate };
//# sourceMappingURL=index.esm.js.map

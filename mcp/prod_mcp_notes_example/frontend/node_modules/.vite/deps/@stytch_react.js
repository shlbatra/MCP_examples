import {
  isStytchSSRProxy,
  noHeadlessClientError,
  noProviderError,
  parseOAuthAuthorizeParams,
  parseOAuthLogoutParams,
  providerMustBeUniqueError
} from "./chunk-6CFCMUQ2.js";
import {
  require_react
} from "./chunk-6ZBOOF7O.js";
import {
  __toESM
} from "./chunk-5WRI5ZAA.js";

// node_modules/@stytch/react/dist/index.esm.js
var import_react2 = __toESM(require_react());

// node_modules/@stytch/react/dist/useIsomorphicLayoutEffect-3bc90e37.js
var import_react = __toESM(require_react());
var createDeepEqual = ({ KEYS_TO_EXCLUDE = [] } = {}) => {
  const deepEqual2 = (a, b) => {
    if (typeof a !== typeof b)
      return false;
    if (a === null || b === null)
      return a === b;
    if (typeof a === "object") {
      if (Object.keys(a).length !== Object.keys(b).length || Object.keys(a).some((k) => !(k in b)))
        return false;
      return Object.entries(a).filter(([k]) => !KEYS_TO_EXCLUDE.includes(k)).every(([k, v]) => deepEqual2(v, b[k]));
    }
    return a === b;
  };
  return deepEqual2;
};
var deepEqual = createDeepEqual();
var mergeWithStableProps = (oldValue, newValue) => {
  if (oldValue === newValue) {
    return newValue;
  }
  return Object.keys(oldValue).reduce((acc, key) => {
    if (key in newValue && deepEqual(oldValue[key], newValue[key])) {
      acc[key] = oldValue[key];
    }
    return acc;
  }, Object.assign({}, newValue));
};
var useAsyncState = (initialState) => {
  const isMounted = (0, import_react.useRef)(true);
  const [state, setState] = (0, import_react.useState)(initialState);
  (0, import_react.useEffect)(() => {
    isMounted.current = true;
    return () => {
      isMounted.current = false;
    };
  }, []);
  const setStateAction = (0, import_react.useCallback)((newState) => {
    if (isMounted.current) {
      setState(newState);
    }
  }, []);
  return [state, setStateAction];
};
function invariant(cond, message) {
  if (!cond)
    throw new Error(message);
}
var useIsomorphicLayoutEffect = typeof window !== "undefined" ? import_react.useLayoutEffect : import_react.useEffect;

// node_modules/@stytch/react/dist/index.esm.js
var initialUser = {
  user: null,
  fromCache: false,
  isInitialized: false
};
var initialSession = {
  session: null,
  fromCache: false,
  isInitialized: false
};
var StytchContext = (0, import_react2.createContext)({ isMounted: false });
var StytchUserContext = (0, import_react2.createContext)(initialUser);
var StytchSessionContext = (0, import_react2.createContext)(initialSession);
var useIsMounted__INTERNAL = () => (0, import_react2.useContext)(StytchContext).isMounted;
var isUIClient = (client) => {
  return client.mountLogin !== void 0;
};
var useStytchUser$1 = () => {
  invariant(useIsMounted__INTERNAL(), noProviderError("useStytchUser"));
  return (0, import_react2.useContext)(StytchUserContext);
};
var useStytchSession$1 = () => {
  invariant(useIsMounted__INTERNAL(), noProviderError("useStytchSession"));
  return (0, import_react2.useContext)(StytchSessionContext);
};
var useStytch = () => {
  const ctx = (0, import_react2.useContext)(StytchContext);
  invariant(ctx.isMounted, noProviderError("useStytch"));
  return ctx.client;
};
var withStytch = (Component) => {
  const WithStytch = (props) => {
    invariant(useIsMounted__INTERNAL(), noProviderError("withStytch"));
    return import_react2.default.createElement(Component, Object.assign({}, props, { stytch: useStytch() }));
  };
  WithStytch.displayName = `withStytch(${Component.displayName || Component.name || "Component"})`;
  return WithStytch;
};
var withStytchUser$1 = (Component) => {
  const WithStytchUser = (props) => {
    invariant(useIsMounted__INTERNAL(), noProviderError("withStytchUser"));
    const { user, isInitialized, fromCache } = useStytchUser$1();
    return import_react2.default.createElement(Component, Object.assign({}, props, { stytchUser: user, stytchUserIsInitialized: isInitialized, stytchUserIsFromCache: fromCache }));
  };
  WithStytchUser.displayName = `withStytchUser(${Component.displayName || Component.name || "Component"})`;
  return WithStytchUser;
};
var withStytchSession$1 = (Component) => {
  const WithStytchSession = (props) => {
    invariant(useIsMounted__INTERNAL(), noProviderError("withStytchSession"));
    const { session, isInitialized, fromCache } = useStytchSession$1();
    return import_react2.default.createElement(Component, Object.assign({}, props, { stytchSession: session, stytchSessionIsInitialized: isInitialized, stytchSessionIsFromCache: fromCache }));
  };
  WithStytchSession.displayName = `withStytchSession(${Component.displayName || Component.name || "Component"})`;
  return WithStytchSession;
};
var useStytchIsAuthorized$1 = (resourceId, action) => {
  invariant(useIsMounted__INTERNAL(), noProviderError("useStytchIsAuthorized", "StytchProvider"));
  const client = useStytch();
  const { user } = useStytchUser$1();
  const [isAuthorized, setIsAuthorized] = useAsyncState({
    isInitialized: false,
    fromCache: false,
    isAuthorized: false
  });
  (0, import_react2.useEffect)(() => {
    if (isStytchSSRProxy(client)) {
      return;
    }
    setIsAuthorized({
      isInitialized: true,
      fromCache: true,
      isAuthorized: client.rbac.isAuthorizedSync(resourceId, action)
    });
  }, [action, client, resourceId, setIsAuthorized]);
  (0, import_react2.useEffect)(() => {
    if (isStytchSSRProxy(client)) {
      return;
    }
    client.rbac.isAuthorized(resourceId, action).then((isAuthorized2) => {
      setIsAuthorized({ isAuthorized: isAuthorized2, fromCache: false, isInitialized: true });
    });
  }, [client, user === null || user === void 0 ? void 0 : user.roles, resourceId, action, setIsAuthorized]);
  return isAuthorized;
};
var withStytchPermissions$1 = (Component) => {
  const WithStytchPermissions = (props) => {
    invariant(useIsMounted__INTERNAL(), noProviderError("useRBACPermissions", "StytchProvider"));
    const client = useStytch();
    const { user } = useStytchUser$1();
    const [permissions, setPermissions] = useAsyncState({ loaded: false, value: null });
    (0, import_react2.useEffect)(() => {
      client.rbac.allPermissions().then((permissions2) => {
        setPermissions({ loaded: true, value: permissions2 });
      });
    }, [client, user === null || user === void 0 ? void 0 : user.roles, setPermissions]);
    if (!permissions.loaded) {
      return null;
    }
    return import_react2.default.createElement(Component, Object.assign({}, props, { stytchPermissions: permissions.value }));
  };
  WithStytchPermissions.displayName = `withStytchPermissions(${Component.displayName || Component.name || "Component"})`;
  return WithStytchPermissions;
};
var StytchProvider$1 = ({ stytch, children, assumeHydrated = false }) => {
  invariant(!useIsMounted__INTERNAL(), providerMustBeUniqueError);
  invariant(!assumeHydrated || typeof window !== "undefined", "The `assumeHydrated` prop must be set to `false` when using StytchProvider in a server environment.");
  const ctx = (0, import_react2.useMemo)(() => ({ client: stytch, isMounted: true }), [stytch]);
  const getHydratedState = (0, import_react2.useCallback)(() => {
    return {
      session: Object.assign(Object.assign({}, stytch.session.getInfo()), { isInitialized: true }),
      user: Object.assign(Object.assign({}, stytch.user.getInfo()), { isInitialized: true })
    };
  }, [stytch]);
  const getInitialState = () => {
    return {
      session: initialSession,
      user: initialUser
    };
  };
  const [{ user, session }, setClientState] = useAsyncState(() => assumeHydrated ? getHydratedState() : getInitialState());
  const assumeHydratedRef = (0, import_react2.useRef)(assumeHydrated);
  (0, import_react2.useEffect)(() => {
    if (isStytchSSRProxy(stytch)) {
      return;
    }
    const updateState = () => {
      setClientState((oldState) => mergeWithStableProps(oldState, getHydratedState()));
    };
    if (!assumeHydratedRef.current) {
      updateState();
    }
    return stytch.onStateChange(updateState);
  }, [getHydratedState, setClientState, stytch]);
  return import_react2.default.createElement(
    StytchContext.Provider,
    { value: ctx },
    import_react2.default.createElement(
      StytchUserContext.Provider,
      { value: user },
      import_react2.default.createElement(StytchSessionContext.Provider, { value: session }, children)
    )
  );
};
var StytchLogin = ({ config, styles, callbacks, strings }) => {
  invariant(useIsMounted__INTERNAL(), noProviderError("<StytchLogin />"));
  const stytchClient = useStytch();
  const containerEl = (0, import_react2.useRef)(null);
  useIsomorphicLayoutEffect(() => {
    if (!isUIClient(stytchClient)) {
      throw Error(noHeadlessClientError);
    }
    if (!containerEl.current) {
      return;
    }
    if (!containerEl.current.id) {
      const randId = Math.floor(Math.random() * 1e6);
      containerEl.current.id = `stytch-magic-link-${randId}`;
    }
    stytchClient.mountLogin({
      config,
      callbacks,
      elementId: `#${containerEl.current.id}`,
      styles,
      strings
    });
  }, [stytchClient, config, styles, callbacks, strings]);
  return import_react2.default.createElement("div", { ref: containerEl });
};
var StytchPasswordReset = ({ config, styles, callbacks, strings, passwordResetToken }) => {
  invariant(useIsMounted__INTERNAL(), noProviderError("<StytchResetPassword />"));
  const stytchClient = useStytch();
  const containerEl = (0, import_react2.useRef)(null);
  useIsomorphicLayoutEffect(() => {
    if (!isUIClient(stytchClient)) {
      throw Error(noHeadlessClientError);
    }
    if (!containerEl.current) {
      return;
    }
    if (!containerEl.current.id) {
      const randId = Math.floor(Math.random() * 1e6);
      containerEl.current.id = `stytch-reset-password-${randId}`;
    }
    if (passwordResetToken) {
      stytchClient.mountResetPassword({
        config,
        callbacks,
        elementId: `#${containerEl.current.id}`,
        styles,
        strings,
        passwordResetToken
      });
    }
  }, [stytchClient, config, styles, callbacks, strings, passwordResetToken]);
  return import_react2.default.createElement("div", { ref: containerEl });
};
var StytchPasskeyRegistration = ({ config, styles, callbacks, strings }) => {
  invariant(useIsMounted__INTERNAL(), noProviderError("<StytchPasskeyRegistration />"));
  const stytchClient = useStytch();
  const user = useStytchUser$1();
  const containerEl = (0, import_react2.useRef)(null);
  useIsomorphicLayoutEffect(() => {
    if (!isUIClient(stytchClient)) {
      throw Error(noHeadlessClientError);
    }
    if (!containerEl.current) {
      return;
    }
    if (!containerEl.current.id) {
      const randId = Math.floor(Math.random() * 1e6);
      containerEl.current.id = `stytch-passkey-registration-${randId}`;
    }
    stytchClient.mountPasskeyRegistration({
      config,
      callbacks,
      elementId: `#${containerEl.current.id}`,
      styles,
      strings
    });
  }, [stytchClient, config, styles, callbacks, strings, user]);
  return import_react2.default.createElement("div", { ref: containerEl });
};
var IdentityProvider = ({ styles, callbacks, strings, getIDPConsentManifest, authTokenParams }) => {
  invariant(useIsMounted__INTERNAL(), noProviderError("<IdentityProvider />"));
  const stytchClient = useStytch();
  const user = useStytchUser$1();
  const containerEl = (0, import_react2.useRef)(null);
  useIsomorphicLayoutEffect(() => {
    if (!isUIClient(stytchClient)) {
      throw Error(noHeadlessClientError);
    }
    if (!containerEl.current) {
      return;
    }
    if (!containerEl.current.id) {
      const randId = Math.floor(Math.random() * 1e6);
      containerEl.current.id = `stytch-idp-${randId}`;
    }
    stytchClient.mountIdentityProvider({
      callbacks,
      elementId: `#${containerEl.current.id}`,
      styles,
      strings,
      getIDPConsentManifest,
      authTokenParams
    });
  }, [stytchClient, styles, callbacks, user, strings, getIDPConsentManifest, authTokenParams]);
  return import_react2.default.createElement("div", { ref: containerEl });
};
var useStytchUser = useStytchUser$1;
var useStytchSession = useStytchSession$1;
var withStytchUser = withStytchUser$1;
var withStytchSession = withStytchSession$1;
var useStytchIsAuthorized = useStytchIsAuthorized$1;
var withStytchPermissions = withStytchPermissions$1;
var StytchProvider = ({ stytch, children, assumeHydrated = true }) => {
  return import_react2.default.createElement(StytchProvider$1, { stytch, assumeHydrated }, children);
};
export {
  IdentityProvider,
  StytchLogin,
  StytchPasskeyRegistration,
  StytchPasswordReset,
  StytchProvider,
  parseOAuthAuthorizeParams,
  parseOAuthLogoutParams,
  useStytch,
  useStytchIsAuthorized,
  useStytchSession,
  useStytchUser,
  withStytch,
  withStytchPermissions,
  withStytchSession,
  withStytchUser
};
//# sourceMappingURL=@stytch_react.js.map
